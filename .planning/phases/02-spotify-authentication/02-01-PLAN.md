---
phase: 02-spotify-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pubspec.yaml
  - lib/features/auth/data/auth_repository.dart
  - lib/features/auth/providers/auth_providers.dart
  - lib/core/constants/spotify_constants.dart
  - lib/app/router.dart
  - lib/features/auth/presentation/login_screen.dart
  - lib/features/home/presentation/home_screen.dart
autonomous: true

must_haves:
  truths:
    - "Unauthenticated user is redirected to login screen"
    - "Login screen has a 'Log in with Spotify' button that initiates OAuth"
    - "After successful OAuth, user is redirected to home screen"
    - "Home screen has a logout button that signs user out"
    - "After logout, user is redirected back to login screen"
    - "Auth state changes automatically trigger route changes (no manual navigation)"
  artifacts:
    - path: "lib/features/auth/data/auth_repository.dart"
      provides: "Supabase OAuth operations (signInWithSpotify, signOut, session access)"
      contains: "signInWithOAuth"
    - path: "lib/features/auth/providers/auth_providers.dart"
      provides: "Riverpod providers for auth state"
      contains: "authRepositoryProvider"
    - path: "lib/core/constants/spotify_constants.dart"
      provides: "Spotify scopes and redirect scheme constants"
      contains: "spotifyScopes"
    - path: "lib/app/router.dart"
      provides: "Auth-guarded routing with redirect logic"
      contains: "AuthNotifier"
    - path: "lib/features/auth/presentation/login_screen.dart"
      provides: "Login screen with Spotify OAuth button"
      contains: "LoginScreen"
    - path: "lib/features/home/presentation/home_screen.dart"
      provides: "Home screen with logout functionality"
      contains: "signOut"
  key_links:
    - from: "lib/features/auth/presentation/login_screen.dart"
      to: "lib/features/auth/data/auth_repository.dart"
      via: "authRepositoryProvider -> signInWithSpotify()"
      pattern: "authRepositoryProvider.*signInWithSpotify"
    - from: "lib/app/router.dart"
      to: "lib/features/auth/data/auth_repository.dart"
      via: "AuthNotifier listens to onAuthStateChange, GoRouter refreshListenable"
      pattern: "refreshListenable.*authNotifier"
    - from: "lib/features/home/presentation/home_screen.dart"
      to: "lib/features/auth/data/auth_repository.dart"
      via: "authRepositoryProvider -> signOut()"
      pattern: "authRepositoryProvider.*signOut"
---

<objective>
Build the complete Spotify OAuth auth layer in Dart: auth repository, Riverpod providers, auth-guarded router, login screen, and logout functionality.

Purpose: This is the core auth infrastructure that enables Spotify login, session-reactive routing, and logout. All Dart code; no platform config yet.
Output: Auth feature module (repository + providers + login screen), modified router with auth guards, home screen with logout button.
</objective>

<execution_context>
@/Users/tijmen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tijmen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-spotify-authentication/02-RESEARCH.md
@.planning/phases/01-project-foundation/01-01-SUMMARY.md
@.planning/phases/01-project-foundation/01-02-SUMMARY.md

Key existing files to reference:
@lib/main.dart
@lib/app/app.dart
@lib/app/router.dart
@lib/features/home/presentation/home_screen.dart
@pubspec.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth repository, providers, and constants</name>
  <files>
    pubspec.yaml
    lib/core/constants/spotify_constants.dart
    lib/features/auth/data/auth_repository.dart
    lib/features/auth/providers/auth_providers.dart
  </files>
  <action>
    1. Add `flutter_secure_storage: ^9.2.4` to pubspec.yaml dependencies. Run `flutter pub get`.

    2. Create `lib/core/constants/spotify_constants.dart`:
       - `spotifyScopes` constant string: `'user-read-email user-read-private user-top-read user-library-read playlist-modify-public playlist-modify-private'`
       - `spotifyRedirectScheme` constant: `'io.runplaylist.app'`
       - `spotifyRedirectUrl` constant: `'io.runplaylist.app://login-callback'`
       These are ALL the scopes the app will ever need. Request them all upfront per research guidance.

    3. Create `lib/features/auth/data/auth_repository.dart`:
       - Class `AuthRepository` taking `SupabaseClient` in constructor
       - `signInWithSpotify()` method: calls `_client.auth.signInWithOAuth(OAuthProvider.spotify, ...)` with:
         - `redirectTo`: `null` on web (`kIsWeb`), `spotifyRedirectUrl` on mobile
         - `authScreenLaunchMode`: `LaunchMode.platformDefault` on web, `LaunchMode.externalApplication` on mobile (NEVER inAppWebView on iOS -- causes redirect failures per research Pitfall 2)
         - `scopes`: `spotifyScopes` from constants
       - `signOut()` method: calls `_client.auth.signOut()` â€” NO manual navigation (GoRouter redirect handles it per research anti-patterns)
       - `currentSession` getter: returns `_client.auth.currentSession`
       - `onAuthStateChange` getter: returns `_client.auth.onAuthStateChange` stream
       - `isAuthenticated` getter: returns `currentSession != null`

    4. Create `lib/features/auth/providers/auth_providers.dart`:
       - `authRepositoryProvider`: `Provider<AuthRepository>` that creates `AuthRepository(Supabase.instance.client)`
       - `authStateProvider`: `StreamProvider<AuthState>` that watches `Supabase.instance.client.auth.onAuthStateChange`
       - `currentSessionProvider`: `Provider<Session?>` that returns `Supabase.instance.client.auth.currentSession`
       - `isAuthenticatedProvider`: `Provider<bool>` that returns `ref.watch(currentSessionProvider) != null`
       Use manual Riverpod providers (NOT @riverpod code-gen) per Phase 1 decision about Dart 3.10 incompatibility.
  </action>
  <verify>
    - `flutter pub get` succeeds
    - `flutter analyze` passes with no errors (warnings OK)
    - All 4 files exist with expected exports
  </verify>
  <done>
    AuthRepository wraps Supabase OAuth with platform-aware redirect and launch mode. Riverpod providers expose auth state reactively. Spotify constants define all scopes and redirect scheme in one place.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire auth-guarded router, login screen, and logout</name>
  <files>
    lib/app/router.dart
    lib/features/auth/presentation/login_screen.dart
    lib/features/home/presentation/home_screen.dart
  </files>
  <action>
    1. Modify `lib/app/router.dart`:
       - Add `AuthNotifier` class (extends `ChangeNotifier`):
         - Constructor subscribes to `Supabase.instance.client.auth.onAuthStateChange` and calls `notifyListeners()` on each event
         - `isAuthenticated` getter: returns `Supabase.instance.client.auth.currentSession != null`
       - Add `authNotifierProvider`: `Provider<AuthNotifier>` that creates `AuthNotifier()`
       - Modify `routerProvider` to:
         - Read `authNotifier` from `ref.watch(authNotifierProvider)`
         - Set `refreshListenable: authNotifier` on GoRouter (this makes router re-evaluate on auth changes)
         - Add `redirect` function:
           - If NOT authenticated AND NOT on `/login` -> redirect to `/login`
           - If authenticated AND on `/login` -> redirect to `/`
           - Otherwise -> return null (no redirect)
         - Add `/login` route: `GoRoute(path: '/login', builder: -> LoginScreen())`
       - Keep existing `/` (HomeScreen) and `/settings` (SettingsScreen) routes
       - Import LoginScreen from `features/auth/presentation/login_screen.dart`

    2. Create `lib/features/auth/presentation/login_screen.dart`:
       - `LoginScreen` extends `ConsumerWidget`
       - Scaffold with centered Column:
         - App title text: "Running Playlist AI" (fontSize 24, fontWeight bold)
         - Subtitle text: "Music that matches your stride" (lighter weight)
         - SizedBox(height: 48)
         - `ElevatedButton.icon` with:
           - `icon: Icon(Icons.music_note)`
           - `label: Text('Log in with Spotify')`
           - `onPressed`: calls `ref.read(authRepositoryProvider).signInWithSpotify()`
           - Wrap in try/catch, show SnackBar on error
       - Import authRepositoryProvider from providers file
       - NO manual navigation after login -- GoRouter redirect handles it automatically

    3. Modify `lib/features/home/presentation/home_screen.dart`:
       - Change from `StatelessWidget` to `ConsumerWidget` (needs ref for auth)
       - Add a logout button (ElevatedButton or TextButton) in the body or app bar actions:
         - `onPressed`: calls `ref.read(authRepositoryProvider).signOut()`
         - Label: "Log out"
       - NO manual navigation after signOut -- GoRouter redirect handles it (per research anti-patterns)
       - Import authRepositoryProvider
       - Keep existing Settings navigation button
  </action>
  <verify>
    - `flutter analyze` passes with no errors
    - `flutter build web` succeeds
    - Verify in code: router has `refreshListenable`, `redirect` function, `/login` route
    - Verify LoginScreen calls `signInWithSpotify()`, HomeScreen calls `signOut()`
    - Verify NO manual `context.go('/login')` or `context.go('/')` after auth operations
  </verify>
  <done>
    GoRouter redirects unauthenticated users to `/login` and authenticated users away from `/login`. Login screen initiates Spotify OAuth via auth repository. Home screen has logout that clears session. All navigation is driven reactively by auth state changes through AuthNotifier + refreshListenable -- zero manual navigation.
  </done>
</task>

</tasks>

<verification>
1. `flutter pub get` -- all dependencies resolve
2. `flutter analyze` -- no errors (warnings/info OK)
3. `flutter build web` -- compiles successfully
4. Code review: router.dart has AuthNotifier with refreshListenable, redirect guards `/login` route
5. Code review: login_screen.dart calls signInWithSpotify(), no manual navigation
6. Code review: home_screen.dart calls signOut(), no manual navigation
7. Code review: auth_repository.dart uses LaunchMode.externalApplication on mobile, not inAppWebView
8. Code review: spotifyScopes includes all 6 required scopes
</verification>

<success_criteria>
- Auth feature directory exists with repository, providers, and login screen
- Router guards all routes behind authentication
- Login and logout trigger auth state changes that GoRouter reacts to
- flutter build web passes
- flutter analyze clean
</success_criteria>

<output>
After completion, create `.planning/phases/02-spotify-authentication/02-01-SUMMARY.md`
</output>
