---
phase: 02-spotify-authentication
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - android/app/src/main/AndroidManifest.xml
  - ios/Runner/Info.plist
autonomous: false

user_setup:
  - service: spotify
    why: "Spotify OAuth provider for user authentication"
    env_vars: []
    dashboard_config:
      - task: "Create Spotify Developer App"
        location: "https://developer.spotify.com/dashboard -> Create App"
        details: "App name: 'Running Playlist AI'. Add redirect URI: https://<supabase-project-ref>.supabase.co/auth/v1/callback"
      - task: "Copy Client ID and Client Secret"
        location: "Spotify Developer Dashboard -> App Settings"
        details: "These go into Supabase dashboard, not into the Flutter app"
  - service: supabase
    why: "Supabase Auth acts as OAuth intermediary between app and Spotify"
    env_vars: []
    dashboard_config:
      - task: "Enable Spotify provider in Supabase Auth"
        location: "Supabase Dashboard -> Authentication -> Providers -> Spotify"
        details: "Toggle ON, paste Client ID and Client Secret from Spotify dashboard"
      - task: "Add redirect URLs to Supabase Auth"
        location: "Supabase Dashboard -> Authentication -> URL Configuration -> Additional Redirect URLs"
        details: "Add: io.runplaylist.app://login-callback (for mobile deep link callback)"

must_haves:
  truths:
    - "Mobile OAuth redirect returns to app (not stuck in browser)"
    - "User can complete full OAuth flow on web browser"
    - "User can complete full OAuth flow on iOS or Android"
    - "Session persists after closing and reopening the app"
    - "Logout returns user to login screen on all platforms"
  artifacts:
    - path: "android/app/src/main/AndroidManifest.xml"
      provides: "Android deep link intent filter for OAuth callback"
      contains: "io.runplaylist.app"
    - path: "ios/Runner/Info.plist"
      provides: "iOS URL scheme for OAuth callback"
      contains: "io.runplaylist.app"
  key_links:
    - from: "android/app/src/main/AndroidManifest.xml"
      to: "Supabase Auth redirect"
      via: "intent-filter scheme matching redirect URL"
      pattern: "android:scheme.*io.runplaylist.app"
    - from: "ios/Runner/Info.plist"
      to: "Supabase Auth redirect"
      via: "CFBundleURLSchemes matching redirect URL"
      pattern: "io.runplaylist.app"
---

<objective>
Configure platform-specific deep links for OAuth redirect callbacks and verify the complete Spotify auth flow end-to-end on web and mobile.

Purpose: Deep links are required for mobile OAuth -- without them, Spotify login completes in the browser but never returns to the app. This plan configures Android and iOS, then verifies the full flow works.
Output: Platform config files with deep link support, verified OAuth flow on web + mobile.
</objective>

<execution_context>
@/Users/tijmen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tijmen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-spotify-authentication/02-RESEARCH.md
@.planning/phases/02-spotify-authentication/02-01-SUMMARY.md

Key existing files to reference:
@android/app/src/main/AndroidManifest.xml
@ios/Runner/Info.plist
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Android and iOS deep links for OAuth callback</name>
  <files>
    android/app/src/main/AndroidManifest.xml
    ios/Runner/Info.plist
  </files>
  <action>
    1. Modify `android/app/src/main/AndroidManifest.xml`:
       - Inside the existing `<activity>` tag (the main Flutter activity), AFTER the existing MAIN intent-filter, add a NEW intent-filter:
         ```xml
         <intent-filter>
             <action android:name="android.intent.action.VIEW" />
             <category android:name="android.intent.category.DEFAULT" />
             <category android:name="android.intent.category.BROWSABLE" />
             <data android:scheme="io.runplaylist.app"
                   android:host="login-callback" />
         </intent-filter>
         ```
       - Verify the activity already has `android:launchMode="singleTop"` (default Flutter template includes this). If missing, add it.
       - The scheme `io.runplaylist.app` and host `login-callback` must EXACTLY match the `spotifyRedirectUrl` constant from Plan 01 (`io.runplaylist.app://login-callback`). Any mismatch = OAuth redirect fails silently (Pitfall 7 from research).

    2. Modify `ios/Runner/Info.plist`:
       - Add URL scheme inside the main `<dict>` section:
         ```xml
         <key>CFBundleURLTypes</key>
         <array>
             <dict>
                 <key>CFBundleTypeRole</key>
                 <string>Editor</string>
                 <key>CFBundleURLSchemes</key>
                 <array>
                     <string>io.runplaylist.app</string>
                 </array>
             </dict>
         </array>
         ```
       - The scheme `io.runplaylist.app` must match the scheme portion of `spotifyRedirectUrl`. iOS strips the `://` and host for custom schemes -- the system matches on scheme alone and delivers the full URL to the app.
       - Do NOT add CFBundleURLTypes if it already exists -- merge into the existing array instead.
  </action>
  <verify>
    - `flutter build web` still succeeds (platform files don't break web build)
    - `flutter build apk --debug` succeeds (validates AndroidManifest.xml is well-formed)
    - `flutter build ios --debug --no-codesign` succeeds (validates Info.plist is well-formed)
    - Grep AndroidManifest.xml for `io.runplaylist.app` scheme -- found
    - Grep Info.plist for `io.runplaylist.app` scheme -- found
  </verify>
  <done>
    Android intent filter and iOS URL scheme configured for `io.runplaylist.app://login-callback` deep link. OAuth redirect from Supabase will open the app instead of staying in browser.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify Spotify OAuth flow end-to-end</name>
  <what-built>
    Complete Spotify authentication system:
    - Auth repository with Supabase OAuth (PKCE)
    - Auth-guarded GoRouter (redirects to login when not authenticated)
    - Login screen with "Log in with Spotify" button
    - Logout button on home screen
    - Deep link configuration for Android and iOS
  </what-built>
  <how-to-verify>
    **Prerequisites (user setup -- do these FIRST if not done):**
    1. Create a Spotify Developer App at https://developer.spotify.com/dashboard
       - App name: "Running Playlist AI"
       - Add Redirect URI: `https://<your-supabase-ref>.supabase.co/auth/v1/callback`
       - Copy the Client ID and Client Secret
    2. Enable Spotify provider in Supabase Dashboard
       - Go to Authentication -> Providers -> Spotify
       - Toggle ON, paste Client ID and Client Secret
    3. Add redirect URLs in Supabase Dashboard
       - Go to Authentication -> URL Configuration -> Additional Redirect URLs
       - Add: `io.runplaylist.app://login-callback`
       - Add: `http://localhost:PORT` (replace PORT with your Flutter web dev server port, visible when running `flutter run -d chrome`)

    **Test on Web (Chrome):**
    1. Run `flutter run -d chrome`
    2. App should show the Login screen (not Home -- you're not authenticated)
    3. Tap "Log in with Spotify"
    4. Should redirect to Spotify login page
    5. Log in with Spotify credentials, authorize the app
    6. Should redirect back to app and show Home screen
    7. Refresh the page (F5) -- should STILL show Home screen (session persisted)
    8. Tap "Log out" -- should return to Login screen
    9. Refresh the page -- should STILL show Login screen (session cleared)

    **Test on Mobile (iOS or Android):**
    1. Run `flutter run -d <device>` (iOS simulator or Android emulator)
    2. App should show Login screen
    3. Tap "Log in with Spotify" -- should open external browser (NOT in-app webview)
    4. Complete Spotify login
    5. Should return to the app showing Home screen
    6. Kill the app (force close) and reopen -- should show Home screen (session persisted)
    7. Tap "Log out" -- should return to Login screen

    **If anything fails:** Describe what happened at which step. Common issues:
    - "Invalid redirect URI" error at Spotify -> Check Supabase callback URL is in Spotify dashboard
    - Login succeeds but stays in browser (mobile) -> Deep link scheme mismatch
    - Blank screen after redirect (web) -> Supabase redirect URL missing localhost entry
    - Error in console about "provider not enabled" -> Spotify not enabled in Supabase auth settings
  </how-to-verify>
  <resume-signal>Type "approved" if auth flow works on web + at least one mobile platform. Otherwise describe the issue.</resume-signal>
</task>

</tasks>

<verification>
1. AndroidManifest.xml has intent-filter with scheme `io.runplaylist.app` and host `login-callback`
2. Info.plist has CFBundleURLSchemes containing `io.runplaylist.app`
3. Platform builds succeed (web, apk, ios)
4. Human-verified: OAuth login works on web
5. Human-verified: OAuth login works on at least one mobile platform
6. Human-verified: Session persists across app restart
7. Human-verified: Logout works and returns to login screen
</verification>

<success_criteria>
- Deep links configured for both Android and iOS
- Platform builds pass
- User has verified full OAuth flow on web and mobile
- Session persistence confirmed across app restart
- Logout confirmed working
- All 4 Phase 2 success criteria met
</success_criteria>

<output>
After completion, create `.planning/phases/02-spotify-authentication/02-02-SUMMARY.md`
</output>
