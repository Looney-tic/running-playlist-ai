---
phase: 05-stride-cadence
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/features/stride/domain/stride_calculator.dart
  - test/features/stride/domain/stride_calculator_test.dart
autonomous: true

must_haves:
  truths:
    - "paceToSpeed converts min/km to m/s correctly for all valid paces"
    - "strideLengthFromHeight returns stride in meters using height * 0.65 / 100"
    - "defaultStrideLengthFromSpeed returns reasonable stride for unknown height"
    - "cadenceFromSpeedAndStride converts speed + stride to steps/min (not strides/min)"
    - "calculateCadence returns cadence clamped to 150-200 spm"
    - "Height adjusts cadence estimate compared to no-height fallback"
    - "parsePace converts M:SS string to decimal minutes"
    - "formatPace converts decimal minutes to M:SS string"
    - "Edge cases (zero pace, negative input, boundary values) handled gracefully"
  artifacts:
    - path: "lib/features/stride/domain/stride_calculator.dart"
      provides: "Pure Dart computation for stride/cadence calculations and pace parsing"
      exports: ["StrideCalculator", "parsePace", "formatPace"]
    - path: "test/features/stride/domain/stride_calculator_test.dart"
      provides: "Comprehensive unit tests for all computation functions"
      min_lines: 80
  key_links:
    - from: "test/features/stride/domain/stride_calculator_test.dart"
      to: "lib/features/stride/domain/stride_calculator.dart"
      via: "import and direct function calls"
      pattern: "StrideCalculator\\."
---

<objective>
Test-drive the pure domain logic for stride length estimation, cadence calculation, and pace parsing.

Purpose: The cadence calculation is the core computational engine of this phase. Getting the formulas right (especially the step-vs-stride distinction) is critical. TDD ensures correctness before any UI work begins.

Output: A fully tested `StrideCalculator` class with static pure functions, plus `parsePace`/`formatPace` helpers — all with zero Flutter dependencies.
</objective>

<execution_context>
@/Users/tijmen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tijmen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-stride-cadence/05-RESEARCH.md
</context>

<feature>
  <name>Stride Calculator Domain Logic</name>
  <files>
    lib/features/stride/domain/stride_calculator.dart
    test/features/stride/domain/stride_calculator_test.dart
  </files>
  <behavior>
    The StrideCalculator class provides pure static functions for running cadence computation.
    No Flutter imports — plain Dart only. This file must NOT import any package:flutter/ libraries.

    **Functions and expected behavior:**

    1. `paceToSpeed(double paceMinPerKm) -> double`
       - 5.0 min/km -> 3.333 m/s (1000 / 300)
       - 4.0 min/km -> 4.167 m/s (1000 / 240)
       - 6.0 min/km -> 2.778 m/s (1000 / 360)
       - 0.0 or negative -> 0.0

    2. `strideLengthFromHeight(double heightCm) -> double`
       - 170 cm -> 1.105 m (170 * 0.65 / 100)
       - 180 cm -> 1.17 m (180 * 0.65 / 100)
       - 160 cm -> 1.04 m (160 * 0.65 / 100)

    3. `defaultStrideLengthFromSpeed(double speedMs) -> double`
       - Uses linear: stride = 0.4 * speed + 0.6
       - Clamped to [1.0, 3.0]
       - 3.33 m/s -> ~1.93 m
       - 2.0 m/s -> ~1.4 m

    4. `cadenceFromSpeedAndStride(double speedMs, double strideLengthM) -> double`
       - speed / stride * 60 * 2 (the *2 converts strides to steps)
       - 3.33 m/s, 1.105 m stride -> ~362 / 1.105 = ~181 spm (unclamped)
       - Zero or negative inputs -> 0.0

    5. `calculateCadence({required double paceMinPerKm, double? heightCm}) -> double`
       - Combines paceToSpeed + stride estimation + cadenceFromSpeedAndStride
       - Uses height-based stride when heightCm provided, speed-based default otherwise
       - **Result clamped to 150-200 spm** (critical)
       - 5:00 min/km without height -> cadence in 150-200 range
       - 5:00 min/km with 190cm height -> different from without height
       - 9:00 min/km (very slow) -> clamps to 150
       - 3:00 min/km (very fast) -> clamps to 200

    6. `parsePace(String input) -> double?` (top-level function)
       - "5:30" -> 5.5
       - "4:00" -> 4.0
       - "6:45" -> 6.75
       - "abc" -> null
       - "" -> null
       - "5:60" -> null (seconds >= 60)
       - "5" -> null (no colon)
       - "-1:30" -> null (negative)

    7. `formatPace(double paceMinPerKm) -> String` (top-level function)
       - 5.5 -> "5:30"
       - 4.0 -> "4:00"
       - 6.75 -> "6:45"

    **Critical correctness check:**
    The step-vs-stride distinction is the #1 pitfall. Cadence = steps per minute (spm).
    One stride = two steps (left-foot-to-left-foot). The formula must multiply stride frequency by 2.
    If tests show cadence values around 80-90, the *2 is missing. If around 340-360, there's a double-multiplication.
  </behavior>
  <implementation>
    Follow the research code patterns in 05-RESEARCH.md closely — the StrideCalculator class is fully specified there.
    Place parsePace and formatPace as top-level functions in the same file (they're closely related to the calculator's purpose).

    Implementation notes:
    - Use `closeTo(expected, tolerance)` matcher for floating-point comparisons in tests (tolerance 0.01)
    - Group tests by function name
    - Include edge cases (zero, negative, boundary) for each function
    - The file MUST NOT import any package:flutter/ library
    - Use `import 'package:flutter_test/flutter_test.dart'` for the test file (this is the standard Flutter test runner, despite the name it works for pure Dart tests too)
    - Import path: `import 'package:running_playlist_ai/features/stride/domain/stride_calculator.dart'`
  </implementation>
</feature>

<verification>
Run: `cd /Users/tijmen/running-playlist-ai && flutter test test/features/stride/domain/stride_calculator_test.dart`

All tests must pass. Expected test count: 15+ tests covering all 7 functions including edge cases.

Verify no Flutter imports in domain file:
`grep -c 'package:flutter' lib/features/stride/domain/stride_calculator.dart` should return 0.
</verification>

<success_criteria>
- All unit tests pass (flutter test returns exit code 0)
- stride_calculator.dart has zero Flutter imports (pure Dart)
- Tests cover: paceToSpeed, strideLengthFromHeight, defaultStrideLengthFromSpeed, cadenceFromSpeedAndStride, calculateCadence, parsePace, formatPace
- Edge cases tested: zero/negative pace, seconds >= 60, clamping at 150 and 200
- calculateCadence produces different results with vs without height (proves height integration works)
</success_criteria>

<output>
After completion, create `.planning/phases/05-stride-cadence/05-01-SUMMARY.md`
</output>
