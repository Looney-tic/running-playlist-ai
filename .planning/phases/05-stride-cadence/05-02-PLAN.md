---
phase: 05-stride-cadence
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - lib/features/stride/providers/stride_providers.dart
  - lib/features/stride/data/stride_preferences.dart
  - lib/features/stride/presentation/stride_screen.dart
  - lib/app/router.dart
  - lib/features/home/presentation/home_screen.dart
autonomous: false

must_haves:
  truths:
    - "User enters target pace (min/km) and sees a calculated cadence (steps/min)"
    - "User enters their height and the cadence estimate adjusts accordingly"
    - "User can perform a real-world calibration (count strides) that overrides the formula estimate"
    - "Calculated cadence falls within realistic running range (150-200 spm)"
    - "User can clear calibration and return to formula-based estimate"
    - "User can navigate to stride screen from home and back"
    - "Height and calibration data persist across app restarts"
  artifacts:
    - path: "lib/features/stride/providers/stride_providers.dart"
      provides: "StrideState, StrideNotifier, strideNotifierProvider"
      exports: ["StrideState", "StrideNotifier", "strideNotifierProvider"]
    - path: "lib/features/stride/data/stride_preferences.dart"
      provides: "Persistence of height and calibration via SharedPreferences"
      exports: ["StridePreferences"]
    - path: "lib/features/stride/presentation/stride_screen.dart"
      provides: "Complete stride/cadence UI with pace, height, calibration, and cadence display"
      exports: ["StrideScreen"]
    - path: "lib/app/router.dart"
      provides: "Route for /stride"
      contains: "path: '/stride'"
    - path: "lib/features/home/presentation/home_screen.dart"
      provides: "Navigation button to stride screen"
      contains: "context.push('/stride')"
  key_links:
    - from: "lib/features/stride/presentation/stride_screen.dart"
      to: "lib/features/stride/providers/stride_providers.dart"
      via: "ref.watch(strideNotifierProvider) and ref.read(strideNotifierProvider.notifier)"
      pattern: "strideNotifierProvider"
    - from: "lib/features/stride/providers/stride_providers.dart"
      to: "lib/features/stride/domain/stride_calculator.dart"
      via: "StrideState.cadence getter calling StrideCalculator.calculateCadence"
      pattern: "StrideCalculator\\.calculateCadence"
    - from: "lib/features/stride/providers/stride_providers.dart"
      to: "lib/features/stride/data/stride_preferences.dart"
      via: "StrideNotifier loads/saves via StridePreferences"
      pattern: "StridePreferences"
    - from: "lib/app/router.dart"
      to: "lib/features/stride/presentation/stride_screen.dart"
      via: "GoRoute builder importing StrideScreen"
      pattern: "StrideScreen"
    - from: "lib/features/home/presentation/home_screen.dart"
      to: "/stride"
      via: "context.push('/stride')"
      pattern: "context\\.push\\('/stride'\\)"
---

<objective>
Build the complete stride & cadence feature: Riverpod state management, persistence layer, full UI screen with pace input, height slider, calibration flow, cadence display, and router integration.

Purpose: This plan delivers the user-facing stride calculator that connects the tested domain logic (05-01) to a working screen. After this plan, users can enter their running pace, optionally their height, optionally calibrate, and see their target cadence — the output consumed by later phases for BPM matching.

Output: A fully functional stride screen accessible from the home screen, with persistent user preferences.
</objective>

<execution_context>
@/Users/tijmen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tijmen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-stride-cadence/05-RESEARCH.md
@.planning/phases/05-stride-cadence/05-01-SUMMARY.md
@lib/app/router.dart
@lib/features/home/presentation/home_screen.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Persistence layer, Riverpod providers, and route wiring</name>
  <files>
    lib/features/stride/data/stride_preferences.dart
    lib/features/stride/providers/stride_providers.dart
    lib/app/router.dart
  </files>
  <action>
    **1. Create `lib/features/stride/data/stride_preferences.dart`:**

    A simple wrapper around SharedPreferences for persisting height and calibrated cadence.

    ```dart
    class StridePreferences {
      static const _heightKey = 'stride_height_cm';
      static const _calibratedCadenceKey = 'stride_calibrated_cadence';

      // Load saved height (returns null if not set)
      static Future<double?> loadHeight() async { ... }

      // Load saved calibrated cadence (returns null if not set)
      static Future<double?> loadCalibratedCadence() async { ... }

      // Save height
      static Future<void> saveHeight(double? heightCm) async { ... }

      // Save calibrated cadence
      static Future<void> saveCalibratedCadence(double? cadence) async { ... }
    }
    ```

    Use `SharedPreferences.getInstance()` in each method. Store doubles. For null values, remove the key.

    **Note:** `shared_preferences` must be added to pubspec.yaml if not already present. Check first with `grep shared_preferences pubspec.yaml`. If missing, add it: `flutter pub add shared_preferences`.

    **2. Create `lib/features/stride/providers/stride_providers.dart`:**

    Follow the research patterns exactly (see 05-RESEARCH.md Pattern 2):
    - `StrideState` class with `paceMinPerKm` (default 5.5), nullable `heightCm`, nullable `calibratedCadence`
    - `cadence` getter: if calibratedCadence is set, return it; otherwise call `StrideCalculator.calculateCadence`
    - `copyWith` using nullable function pattern for optional fields: `double? Function()? heightCm`
    - `StrideNotifier extends StateNotifier<StrideState>` with methods: `setPace`, `setHeight`, `setCalibratedCadence`, `clearCalibration`, `loadFromPreferences`, `_persist`
    - `strideNotifierProvider = StateNotifierProvider<StrideNotifier, StrideState>((ref) => StrideNotifier())`
    - In constructor or via an `init()` method, load saved height and calibration from StridePreferences
    - On every state change that affects height or calibration, persist via StridePreferences

    Import StrideCalculator from `../domain/stride_calculator.dart`.

    **3. Update `lib/app/router.dart`:**

    Add a GoRoute for `/stride`:
    ```dart
    GoRoute(
      path: '/stride',
      builder: (context, state) => const StrideScreen(),
    ),
    ```

    Add the import: `import 'package:running_playlist_ai/features/stride/presentation/stride_screen.dart';`

    Place the route after the `/settings` route in the routes list. The stride screen is behind the existing auth guard (all non-login routes require auth), which is correct.
  </action>
  <verify>
    `flutter analyze lib/features/stride/data/stride_preferences.dart lib/features/stride/providers/stride_providers.dart lib/app/router.dart` passes with no errors.
    `flutter test test/features/stride/domain/stride_calculator_test.dart` still passes (no regressions).
  </verify>
  <done>
    - StridePreferences class persists height and calibration to SharedPreferences
    - StrideState holds pace, height, calibration, and computes cadence via StrideCalculator
    - StrideNotifier manages state mutations and persistence
    - strideNotifierProvider exposes the notifier as a Riverpod provider
    - /stride route registered in GoRouter
  </done>
</task>

<task type="auto">
  <name>Task 2: Stride screen UI with pace, height, calibration, and cadence display</name>
  <files>
    lib/features/stride/presentation/stride_screen.dart
    lib/features/home/presentation/home_screen.dart
  </files>
  <action>
    **1. Create `lib/features/stride/presentation/stride_screen.dart`:**

    A ConsumerStatefulWidget (needs TextEditingControllers for form fields). Structure:

    **AppBar:** Title "Stride Calculator", back button (automatic with GoRouter push)

    **Body sections (scrollable Column in SingleChildScrollView):**

    **Section A — Cadence Display (top, prominent):**
    - Large text showing `${state.cadence.round()} spm`
    - Subtitle: "Calibrated" chip with delete button if calibratedCadence != null, else "Estimated from pace + height" or "Estimated from pace"
    - Use Theme.of(context).textTheme.headlineLarge for the number

    **Section B — Pace Input:**
    - TextFormField with label "Target Pace", hint "5:30", suffix "min/km"
    - keyboardType: TextInputType.datetime (shows : on keyboard)
    - Initialize controller with formatPace(state.paceMinPerKm) from current state
    - On change: parse with parsePace(), if valid call notifier.setPace()
    - Validator: must be M:SS format, must be 3:00-10:00 range
    - Wrap in a Form with a GlobalKey<FormState> for validation

    **Section C — Height Input (optional, collapsible):**
    - A SwitchListTile or ExpansionTile: "Use height for better estimate"
    - When expanded: Slider from 140 to 210 cm, 1cm divisions
    - Display current value: "{height} cm"
    - On change: call notifier.setHeight(value)
    - When collapsed/toggled off: call notifier.setHeight(null) to clear

    **Section D — Calibration (optional, collapsible):**
    - ExpansionTile or section: "Calibrate with real run"
    - Instructions: "Run at your target pace. Count every footstrike (both feet) for 30 seconds."
    - TextFormField: "Steps counted in 30 seconds", number keyboard
    - "Apply calibration" ElevatedButton: takes steps * 2, calls notifier.setCalibratedCadence()
    - Validate: steps must be 50-120 range (realistic for 30 seconds at running cadence)
    - When calibration is active, show "Clear calibration" TextButton

    **Key UX notes:**
    - Cadence display updates in real-time as pace/height change (reactive via ref.watch)
    - When calibration is active, changing pace does NOT change displayed cadence (calibration overrides)
    - Show this clearly: when calibrated, dim the pace/height sections or show "Calibrated cadence active — formula estimate would be {X} spm" for comparison
    - Import parsePace and formatPace from the domain layer

    **2. Update `lib/features/home/presentation/home_screen.dart`:**

    Add a navigation button to the stride screen. In the body Column (before the logout button), add:
    ```dart
    ElevatedButton.icon(
      onPressed: () => context.push('/stride'),
      icon: const Icon(Icons.directions_run),
      label: const Text('Stride Calculator'),
    ),
    const SizedBox(height: 16),
    ```

    This gives users a clear entry point to the stride feature from the home screen.
  </action>
  <verify>
    `flutter analyze` passes with no errors on all stride feature files.
    `flutter build web` succeeds (compile check).
    `flutter test` passes (all existing tests still pass).
  </verify>
  <done>
    - StrideScreen shows real-time cadence from pace input
    - Height slider adjusts cadence when enabled
    - Calibration section accepts step count and overrides formula
    - Clear calibration restores formula-based estimate
    - Home screen has navigation button to stride screen
    - All cadence values display in 150-200 spm range
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete stride & cadence feature: domain logic with tests, Riverpod state management with persistence, and full UI screen with pace input, height adjustment, calibration flow, and real-time cadence display. Accessible from home screen via "Stride Calculator" button.
  </what-built>
  <how-to-verify>
    1. Run `cd /Users/tijmen/running-playlist-ai && flutter run -d chrome`
    2. After login, you should see "Stride Calculator" button on home screen
    3. Tap "Stride Calculator" — stride screen opens
    4. **Test STRIDE-01 (pace to cadence):**
       - Enter pace "5:30" → cadence should display ~165-175 spm
       - Change to "4:00" → cadence should increase (faster pace = higher cadence)
       - Change to "8:00" → cadence should decrease
       - All values should be in 150-200 range
    5. **Test STRIDE-02 (height adjustment):**
       - Enable height input
       - Set height to 190 cm → cadence should change compared to no height
       - Set height to 155 cm → cadence should be different from 190 cm
       - Disable height → cadence returns to pace-only estimate
    6. **Test STRIDE-03 (calibration):**
       - Expand calibration section
       - Enter "82" steps in 30 seconds → tap Apply → cadence shows 164 spm
       - Note that changing pace no longer changes cadence (calibration overrides)
       - Tap "Clear calibration" → cadence returns to formula estimate
    7. **Test persistence:**
       - Set a height value and/or calibrate
       - Refresh the page (Ctrl+R)
       - Height and calibration values should be restored
    8. Press back to return to home screen
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
**Automated checks:**
- `flutter test` — all tests pass (domain logic + any existing tests)
- `flutter analyze` — no errors
- `flutter build web` — compiles successfully

**Phase success criteria verification (from ROADMAP.md):**
1. User enters target pace (min/km) and sees a calculated cadence (steps/min) — verified by pace input + cadence display
2. User enters their height and the cadence estimate adjusts accordingly — verified by height slider integration
3. User can perform a real-world calibration (count strides) that overrides the formula estimate — verified by calibration flow
4. Calculated cadence falls within realistic running range (150-200 spm) — enforced by clamping in StrideCalculator
</verification>

<success_criteria>
- Stride screen accessible from home screen via navigation
- Pace input in M:SS format produces real-time cadence updates
- Height slider adjusts cadence when enabled
- Calibration overrides formula; clear calibration restores it
- All displayed cadence values are 150-200 spm
- Height and calibration persist across page refresh
- All automated tests pass, no analyzer errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-stride-cadence/05-02-SUMMARY.md`
</output>
