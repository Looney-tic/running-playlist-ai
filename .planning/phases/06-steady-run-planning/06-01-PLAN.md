---
phase: 06-steady-run-planning
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/features/run_plan/domain/run_plan.dart
  - lib/features/run_plan/domain/run_plan_calculator.dart
  - test/features/run_plan/domain/run_plan_calculator_test.dart
autonomous: true

must_haves:
  truths:
    - "Duration calculation is correct: distance * pace * 60, rounded to integer seconds"
    - "Target BPM equals cadence from StrideCalculator for given pace + height"
    - "Calibrated cadence overrides formula-based BPM when provided"
    - "Zero or negative distance/pace returns 0 duration"
    - "RunPlan serializes to JSON and deserializes back identically"
    - "A steady run plan has exactly one segment"
  artifacts:
    - path: "lib/features/run_plan/domain/run_plan.dart"
      provides: "RunPlan, RunSegment, RunType data classes with toJson/fromJson"
      contains: "class RunPlan"
    - path: "lib/features/run_plan/domain/run_plan_calculator.dart"
      provides: "Duration calculation, target BPM derivation, steady plan factory"
      contains: "class RunPlanCalculator"
    - path: "test/features/run_plan/domain/run_plan_calculator_test.dart"
      provides: "Unit tests for all calculator methods and model serialization"
      contains: "group('RunPlanCalculator"
  key_links:
    - from: "lib/features/run_plan/domain/run_plan_calculator.dart"
      to: "lib/features/stride/domain/stride_calculator.dart"
      via: "import and call StrideCalculator.calculateCadence()"
      pattern: "StrideCalculator\\.calculateCadence"
---

<objective>
TDD: Build run plan domain model and calculator with unit tests.

Purpose: Establish the segment-based RunPlan data model and pure computation layer that Phase 6 UI and Phase 7 (playlist generation) will consume. The segment-based design enables Phase 8 (intervals, warm-up/cool-down) without restructuring.

Output: Tested domain classes -- RunPlan, RunSegment, RunType, RunPlanCalculator -- with zero Flutter dependencies.
</objective>

<execution_context>
@/Users/tijmen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tijmen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-steady-run-planning/06-RESEARCH.md

# Phase 5 domain code -- the pattern to follow and the API to consume
@lib/features/stride/domain/stride_calculator.dart
@test/features/stride/domain/stride_calculator_test.dart
</context>

<feature>
  <name>Run Plan Domain Model and Calculator</name>
  <files>
    lib/features/run_plan/domain/run_plan.dart
    lib/features/run_plan/domain/run_plan_calculator.dart
    test/features/run_plan/domain/run_plan_calculator_test.dart
  </files>
  <behavior>
    RunPlanCalculator.durationSeconds:
      - (distanceKm: 5.0, paceMinPerKm: 6.0) -> 1800
      - (distanceKm: 10.0, paceMinPerKm: 5.5) -> 3300
      - (distanceKm: 21.1, paceMinPerKm: 5.0) -> 6330
      - (distanceKm: 42.195, paceMinPerKm: 5.0) -> 12659  (marathon, tests rounding)
      - (distanceKm: 0.0, paceMinPerKm: 5.0) -> 0
      - (distanceKm: 5.0, paceMinPerKm: 0.0) -> 0
      - (distanceKm: -1.0, paceMinPerKm: 5.0) -> 0

    RunPlanCalculator.targetBpm:
      - (paceMinPerKm: 5.0, heightCm: 170) -> matches StrideCalculator.calculateCadence(paceMinPerKm: 5.0, heightCm: 170)
      - (paceMinPerKm: 6.0, heightCm: null) -> matches StrideCalculator.calculateCadence(paceMinPerKm: 6.0)
      - (paceMinPerKm: 5.0, calibratedCadence: 175.0) -> 175.0  (calibrated wins)

    RunPlanCalculator.createSteadyPlan:
      - Creates RunPlan with type: steady, exactly 1 segment
      - Segment has correct durationSeconds and targetBpm
      - Plan has correct distanceKm, paceMinPerKm, createdAt

    RunPlan/RunSegment serialization:
      - toJson() -> fromJson() round-trip preserves all fields
      - RunType enum serializes by name ("steady", "warmUpCoolDown", "interval")
      - Null optional fields (name, label, createdAt) omitted from JSON

    formatDuration helper:
      - 1800 -> "30:00"
      - 3661 -> "1:01:01"
      - 90 -> "1:30"
      - 0 -> "0:00"
  </behavior>
  <implementation>
    1. Create lib/features/run_plan/domain/run_plan.dart with:
       - RunType enum: steady, warmUpCoolDown, interval
       - RunSegment class: durationSeconds (int), targetBpm (double), label (String?), toJson/fromJson
       - RunPlan class: type (RunType), distanceKm (double), paceMinPerKm (double), segments (List of RunSegment), name (String?), createdAt (DateTime?), totalDurationSeconds getter, totalDurationMinutes getter, toJson/fromJson
       - formatDuration top-level function: int totalSeconds -> "H:MM:SS" or "MM:SS" string

    2. Create lib/features/run_plan/domain/run_plan_calculator.dart with:
       - Import StrideCalculator from stride feature
       - Import RunPlan/RunSegment/RunType from run_plan.dart
       - static durationSeconds({distanceKm, paceMinPerKm}): returns (distanceKm * paceMinPerKm * 60).round(), 0 for invalid input
       - static targetBpm({paceMinPerKm, heightCm?, calibratedCadence?}): returns calibratedCadence if set, else StrideCalculator.calculateCadence()
       - static createSteadyPlan({distanceKm, paceMinPerKm, targetBpm, name?}): creates RunPlan with single RunSegment

    Follow Phase 5 pattern exactly: pure Dart, zero Flutter imports, static methods, top-level helpers.
  </implementation>
</feature>

<verification>
- `flutter test test/features/run_plan/domain/run_plan_calculator_test.dart` passes all tests
- `dart analyze lib/features/run_plan/domain/` reports no issues
- No Flutter imports in domain files (grep confirms)
</verification>

<success_criteria>
- All duration calculation tests pass with exact expected values
- targetBpm delegates to StrideCalculator correctly, calibrated cadence overrides
- createSteadyPlan produces a valid RunPlan with 1 segment
- JSON round-trip preserves all RunPlan/RunSegment fields
- formatDuration handles both MM:SS and H:MM:SS formats
- Zero Flutter imports in domain layer
</success_criteria>

<output>
After completion, create `.planning/phases/06-steady-run-planning/06-01-SUMMARY.md`
</output>
