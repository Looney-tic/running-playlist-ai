---
phase: 06-steady-run-planning
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - lib/features/run_plan/data/run_plan_preferences.dart
  - lib/features/run_plan/providers/run_plan_providers.dart
  - lib/features/run_plan/presentation/run_plan_screen.dart
  - lib/app/router.dart
  - lib/features/home/presentation/home_screen.dart
autonomous: false

must_haves:
  truths:
    - "User can enter distance (preset chips or custom) and pace (dropdown) for a steady run"
    - "App displays calculated run duration and target BPM in real time"
    - "User can save the run plan and it persists across app restart"
    - "User can navigate to run plan screen from home screen"
    - "/run-plan route is accessible without authentication"
  artifacts:
    - path: "lib/features/run_plan/data/run_plan_preferences.dart"
      provides: "JSON persistence for RunPlan via SharedPreferences"
      contains: "class RunPlanPreferences"
    - path: "lib/features/run_plan/providers/run_plan_providers.dart"
      provides: "RunPlanNotifier StateNotifier and runPlanNotifierProvider"
      contains: "runPlanNotifierProvider"
    - path: "lib/features/run_plan/presentation/run_plan_screen.dart"
      provides: "Run plan creation screen with distance/pace input and duration/BPM display"
      contains: "class RunPlanScreen"
  key_links:
    - from: "lib/features/run_plan/providers/run_plan_providers.dart"
      to: "lib/features/run_plan/data/run_plan_preferences.dart"
      via: "RunPlanNotifier calls RunPlanPreferences.save/load/clear"
      pattern: "RunPlanPreferences\\.(save|load|clear)"
    - from: "lib/features/run_plan/presentation/run_plan_screen.dart"
      to: "lib/features/run_plan/providers/run_plan_providers.dart"
      via: "ref.watch(runPlanNotifierProvider) for reactive state"
      pattern: "runPlanNotifierProvider"
    - from: "lib/features/run_plan/presentation/run_plan_screen.dart"
      to: "lib/features/stride/providers/stride_providers.dart"
      via: "ref.watch(strideNotifierProvider) for height and calibrated cadence"
      pattern: "strideNotifierProvider"
    - from: "lib/app/router.dart"
      to: "lib/features/run_plan/presentation/run_plan_screen.dart"
      via: "GoRoute path /run-plan"
      pattern: "path: '/run-plan'"
    - from: "lib/features/home/presentation/home_screen.dart"
      to: "/run-plan"
      via: "context.push('/run-plan') on Plan Run button"
      pattern: "context\\.push\\('/run-plan'\\)"
---

<objective>
Wire run plan persistence, state management, UI screen, and router integration.

Purpose: Let users create a steady run plan by entering distance and pace, see the calculated duration and target BPM, and save it for later use by the playlist generator (Phase 7).

Output: Working /run-plan screen accessible from home, with persistent run plan storage.
</objective>

<execution_context>
@/Users/tijmen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tijmen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-steady-run-planning/06-RESEARCH.md
@.planning/phases/06-steady-run-planning/06-01-SUMMARY.md

# Phase 5 code -- patterns to replicate exactly
@lib/features/stride/data/stride_preferences.dart
@lib/features/stride/providers/stride_providers.dart
@lib/features/stride/presentation/stride_screen.dart

# Files to modify
@lib/app/router.dart
@lib/features/home/presentation/home_screen.dart

# Domain from plan 01 (will exist after 06-01 completes)
@lib/features/run_plan/domain/run_plan.dart
@lib/features/run_plan/domain/run_plan_calculator.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Persistence, providers, router wiring</name>
  <files>
    lib/features/run_plan/data/run_plan_preferences.dart
    lib/features/run_plan/providers/run_plan_providers.dart
    lib/app/router.dart
    lib/features/home/presentation/home_screen.dart
  </files>
  <action>
    Create RunPlanPreferences (lib/features/run_plan/data/run_plan_preferences.dart):
    - Follow StridePreferences pattern exactly (static methods, async SharedPreferences)
    - Single key 'current_run_plan' storing JSON string
    - static Future<RunPlan?> load() -- get string, jsonDecode, RunPlan.fromJson. Return null if key missing.
    - static Future<void> save(RunPlan plan) -- jsonEncode(plan.toJson()), setString
    - static Future<void> clear() -- remove key

    Create RunPlanNotifier (lib/features/run_plan/providers/run_plan_providers.dart):
    - Follow StrideNotifier pattern exactly (StateNotifier, async load in constructor)
    - RunPlanNotifier extends StateNotifier<RunPlan?>, initial state null
    - _load() in constructor calls RunPlanPreferences.load()
    - setPlan(RunPlan plan) -- sets state, calls RunPlanPreferences.save(plan)
    - clear() -- sets state to null, calls RunPlanPreferences.clear()
    - Export runPlanNotifierProvider = StateNotifierProvider<RunPlanNotifier, RunPlan?>

    Modify router.dart:
    - Import RunPlanScreen
    - Add GoRoute(path: '/run-plan', builder: ... => const RunPlanScreen())
    - Add '/run-plan' to the isPublicRoute check: `state.matchedLocation == '/run-plan'`
    - Create a temporary empty RunPlanScreen placeholder (or import from presentation if creating screen in same task -- but screen is Task 2, so create a minimal placeholder that gets replaced)

    Actually, to avoid a placeholder: instead modify router.dart but do NOT add the GoRoute yet. Just add '/run-plan' to isPublicRoute. The GoRoute will be added in Task 2 when the screen exists. This avoids importing a file that doesn't exist yet.

    Wait -- all files in this task are created atomically in one commit. Better approach: Create a minimal RunPlanScreen placeholder in presentation/run_plan_screen.dart with just a Scaffold(appBar: AppBar(title: Text('Plan Run')), body: Center(child: Text('Loading...'))) so the router can import it. Task 2 replaces this with the full implementation.

    Revised approach: Do NOT create a placeholder screen. Instead, add the router and home screen changes in Task 2 along with the real screen. Task 1 focuses only on data layer + providers (no UI, no router).

    Final approach for Task 1:
    - Create run_plan_preferences.dart
    - Create run_plan_providers.dart
    - Do NOT touch router.dart or home_screen.dart yet (Task 2 handles those)
  </action>
  <verify>
    - `dart analyze lib/features/run_plan/data/run_plan_preferences.dart` -- no issues
    - `dart analyze lib/features/run_plan/providers/run_plan_providers.dart` -- no issues
    - `flutter test` -- existing tests still pass
  </verify>
  <done>
    RunPlanPreferences can save/load/clear a RunPlan via SharedPreferences.
    RunPlanNotifier manages nullable RunPlan state with auto-load and persist-on-change.
    runPlanNotifierProvider exported for UI consumption.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run plan screen, router integration, home navigation</name>
  <files>
    lib/features/run_plan/presentation/run_plan_screen.dart
    lib/app/router.dart
    lib/features/home/presentation/home_screen.dart
  </files>
  <action>
    Create RunPlanScreen (lib/features/run_plan/presentation/run_plan_screen.dart):
    - ConsumerStatefulWidget (same pattern as StrideScreen)
    - Watches runPlanNotifierProvider for current plan state
    - Watches strideNotifierProvider for height and calibrated cadence
    - Local state for form inputs: selectedDistance (double), selectedPace (double, default 5.5)

    Screen layout (SingleChildScrollView, padding 16):

    A. Distance selection section:
       - Title: "Distance" (titleMedium)
       - Wrap widget with ChoiceChips for presets: 5K (5.0), 10K (10.0), Half (21.1), Marathon (42.2)
       - Below chips: TextField for custom distance in km, with InputDecoration(labelText: 'Custom (km)', border: OutlineInputBorder())
       - Use TextEditingController, parse double on change, validate 0.1-100 range
       - When a preset chip is selected, clear the custom field. When custom field has a valid value, deselect preset chips.
       - Spacing: 8 between chips, 12 below wrap before custom field

    B. Pace input section:
       - Title: "Pace" (titleMedium)
       - Reuse exact same dropdown pattern from StrideScreen: 3:00-10:00 in 15s increments
       - Use formatPace() from stride_calculator.dart for display
       - Same InputDecorator + DropdownButtonHideUnderline + DropdownButton<double> pattern

    C. Run summary card (only shown when distance > 0):
       - Card with padding 16
       - Title: "Run Summary" (titleLarge)
       - Compute duration: RunPlanCalculator.durationSeconds(distanceKm: selectedDistance, paceMinPerKm: selectedPace)
       - Compute target BPM: RunPlanCalculator.targetBpm(paceMinPerKm: selectedPace, heightCm: strideState.heightCm, calibratedCadence: strideState.calibratedCadence)
       - Display rows (label: value):
         - "Distance": "{distance} km"
         - "Pace": "{formatPace(pace)} /km"
         - "Duration": "{formatDuration(durationSeconds)}"
         - "Target BPM": "{targetBpm.round()} bpm"
       - Use a simple _SummaryRow helper widget (Text label left, Text value right in a Row)

    D. Save button:
       - Full-width ElevatedButton: "Save Run Plan"
       - Only enabled when distance > 0
       - On press: create plan via RunPlanCalculator.createSteadyPlan(), call notifier.setPlan(plan)
       - Show SnackBar: "Run plan saved!"
       - If plan already exists, button text changes to "Update Run Plan"

    E. Current plan indicator:
       - If runPlanNotifierProvider has a plan, show a subtle banner or chip at the top: "Current plan: {distance}km at {pace}/km"
       - This helps the user see they have an existing plan

    AppBar: title "Plan Run", no extra actions needed

    Modify router.dart:
    - Add import for RunPlanScreen
    - Add GoRoute(path: '/run-plan', builder: (context, state) => const RunPlanScreen())
    - Add '/run-plan' to isPublicRoute: `state.matchedLocation == '/run-plan'`

    Modify home_screen.dart:
    - Add a "Plan Run" ElevatedButton.icon (icon: Icons.timer, label: "Plan Run") between the Stride Calculator button and the Log out button
    - On press: context.push('/run-plan')
    - Use same spacing pattern (SizedBox(height: 16) between buttons)
  </action>
  <verify>
    - `dart analyze lib/features/run_plan/presentation/run_plan_screen.dart` -- no issues
    - `dart analyze lib/app/router.dart` -- no issues
    - `dart analyze lib/features/home/presentation/home_screen.dart` -- no issues
    - `flutter test` -- all existing tests pass
    - `flutter build web` -- builds successfully
  </verify>
  <done>
    RunPlanScreen renders with distance chips, pace dropdown, computed summary, and save button.
    /run-plan route registered and public (no auth required).
    Home screen has "Plan Run" button navigating to /run-plan.
    Saving a plan persists it and shows confirmation.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete steady run planning flow: distance/pace input, real-time duration and BPM calculation, plan persistence, navigation from home screen</what-built>
  <how-to-verify>
    1. Run `flutter run -d chrome` and navigate to the app
    2. On the home screen, tap "Plan Run" button -- should navigate to /run-plan
    3. On the run plan screen:
       a. Tap "5K" chip -- distance should show 5.0 km
       b. Select pace "6:00 min/km" from dropdown
       c. Verify summary card shows: Distance: 5.0 km, Pace: 6:00 /km, Duration: 30:00, Target BPM: ~167-180 bpm (depends on height/calibration from stride screen)
       d. Tap "10K" chip -- duration should update to ~55:00-60:00
       e. Type "7.5" in the custom distance field -- chips should deselect, distance should be 7.5 km
       f. Tap "Save Run Plan" -- should show snackbar "Run plan saved!"
    4. Refresh the browser page, navigate back to /run-plan -- saved plan should be indicated
    5. Navigate to /stride, check that cadence is visible. Go back to /run-plan, verify BPM matches the stride screen's cadence (if same pace is set)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- /run-plan screen accessible from home and directly via URL
- Distance input works with both presets and custom values
- Pace dropdown has options from 3:00 to 10:00 in 15s increments
- Duration and BPM update reactively as inputs change
- Save persists the plan to SharedPreferences (survives refresh)
- BPM derives from StrideCalculator using the run plan's pace + user's height/calibration
- No auth required to access /run-plan
</verification>

<success_criteria>
- User can enter distance and pace for a steady run
- App calculates run duration and target BPM from cadence
- Run plan is saved and available for playlist generation (via runPlanNotifierProvider)
- Plan persists across app restart
- Navigation from home screen works
</success_criteria>

<output>
After completion, create `.planning/phases/06-steady-run-planning/06-02-SUMMARY.md`
</output>
