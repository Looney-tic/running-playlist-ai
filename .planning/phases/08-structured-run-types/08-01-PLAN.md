---
phase: 08-structured-run-types
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/features/run_plan/domain/run_plan_calculator.dart
  - test/features/run_plan/domain/run_plan_calculator_test.dart
autonomous: true

must_haves:
  truths:
    - "createWarmUpCoolDownPlan produces a 3-segment plan (warm-up, main, cool-down)"
    - "createIntervalPlan produces a plan with warm-up + N*(work+rest) + cool-down segments"
    - "Warm-up and cool-down BPMs are 85% of target BPM"
    - "Rest interval BPM is 80% of target BPM"
    - "Main segment duration is clamped to minimum 60s when warm-up+cool-down exceed total"
    - "All generated plans round-trip through JSON serialization"
  artifacts:
    - path: "lib/features/run_plan/domain/run_plan_calculator.dart"
      provides: "createWarmUpCoolDownPlan and createIntervalPlan factory methods"
      contains: "createWarmUpCoolDownPlan"
    - path: "test/features/run_plan/domain/run_plan_calculator_test.dart"
      provides: "Unit tests for both factory methods"
      min_lines: 400
  key_links:
    - from: "lib/features/run_plan/domain/run_plan_calculator.dart"
      to: "lib/features/run_plan/domain/run_plan.dart"
      via: "imports RunPlan, RunSegment, RunType"
      pattern: "import.*run_plan\\.dart"
---

<objective>
Add TDD-driven factory methods to RunPlanCalculator for creating warm-up/cool-down plans and interval training plans.

Purpose: These factory methods are the pure domain logic that generates multi-segment run plans from high-level user parameters (distance, pace, target BPM, warm-up/cool-down durations, interval counts). The UI (Plan 02) will call these methods to create structured plans.

Output: Two new static factory methods on RunPlanCalculator with comprehensive test coverage.
</objective>

<execution_context>
@/Users/tijmen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tijmen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-structured-run-types/08-RESEARCH.md
@lib/features/run_plan/domain/run_plan.dart
@lib/features/run_plan/domain/run_plan_calculator.dart
@test/features/run_plan/domain/run_plan_calculator_test.dart
</context>

<feature>
  <name>Warm-Up/Cool-Down Plan Factory</name>
  <files>
    lib/features/run_plan/domain/run_plan_calculator.dart
    test/features/run_plan/domain/run_plan_calculator_test.dart
  </files>
  <behavior>
    RunPlanCalculator.createWarmUpCoolDownPlan creates a RunPlan with type=warmUpCoolDown and exactly 3 segments:

    Segment 1 (Warm-up):
    - durationSeconds: warmUpSeconds param (default 300)
    - targetBpm: targetBpm * warmUpBpmFraction (default 0.85), rounded via roundToDouble()
    - label: 'Warm-up'

    Segment 2 (Main):
    - durationSeconds: totalDuration - warmUpSeconds - coolDownSeconds, clamped to minimum 60
    - targetBpm: targetBpm (unchanged)
    - label: 'Main'

    Segment 3 (Cool-down):
    - durationSeconds: coolDownSeconds param (default 300)
    - targetBpm: targetBpm * coolDownBpmFraction (default 0.85), rounded via roundToDouble()
    - label: 'Cool-down'

    Test cases (input -> expected output):
    - 5km @ 6:00/km, 170 BPM -> 3 segments, warm-up 300s @ 145 BPM, main 1200s @ 170 BPM, cool-down 300s @ 145 BPM
    - 5km @ 6:00/km, 170 BPM, warmUp=600, coolDown=600 -> main = 600s @ 170 BPM
    - 1km @ 5:00/km, 170 BPM, warmUp=180, coolDown=180 -> main clamped to 60s (since 300-360 = negative)
    - JSON round-trip preserves all fields
    - plan.type == RunType.warmUpCoolDown
    - plan.distanceKm and paceMinPerKm stored correctly
    - totalDurationSeconds equals sum of all segments

    RunPlanCalculator.createIntervalPlan creates a RunPlan with type=interval and segments:
    warm-up + N*(work+rest) + cool-down

    Structure: [Warm-up, Work 1, Rest 1, Work 2, Rest 2, ..., Work N, Rest N, Cool-down]

    Segment details:
    - Warm-up: warmUpSeconds (default 300), targetBpm * warmUpBpmFraction (default 0.85), label 'Warm-up'
    - Work i: workSeconds, targetBpm, label 'Work {i}'
    - Rest i: restSeconds, targetBpm * restBpmFraction (default 0.80), label 'Rest {i}'
    - Cool-down: coolDownSeconds (default 300), targetBpm * coolDownBpmFraction (default 0.85), label 'Cool-down'

    Note on rest after last work: Include rest after every work segment (including the last one) before cool-down. This matches the research recommendation and avoids a large BPM jump from work directly to cool-down.

    Test cases:
    - 5km @ 6:00/km, 170 BPM, 4 intervals, 120s work, 60s rest -> 10 segments (1+4+4+1), work @ 170, rest @ 136, warm-up/cool-down @ 145
    - 3 intervals, 90s work, 90s rest -> 8 segments (1+3+3+1)
    - Work segments all have targetBpm == target
    - Rest segments all have targetBpm == target * 0.80
    - JSON round-trip preserves all fields including labels
    - plan.type == RunType.interval
    - totalDurationSeconds equals warmUp + N*(work+rest) + coolDown
  </behavior>
  <implementation>
    Add two new static methods to RunPlanCalculator class in run_plan_calculator.dart, following the exact same pattern as the existing createSteadyPlan method:

    1. createWarmUpCoolDownPlan - Parameters: distanceKm, paceMinPerKm, targetBpm (required), warmUpSeconds, coolDownSeconds, warmUpBpmFraction, coolDownBpmFraction, name (optional with defaults). Uses durationSeconds() for total, subtracts warm-up/cool-down, clamps main to min 60s.

    2. createIntervalPlan - Parameters: distanceKm, paceMinPerKm, targetBpm, intervalCount, workSeconds, restSeconds (required), warmUpSeconds, coolDownSeconds, restBpmFraction, warmUpBpmFraction, coolDownBpmFraction, name (optional with defaults). Builds segment list with a for loop over intervalCount, adding Work/Rest pairs.

    Both methods return RunPlan with appropriate RunType, store distanceKm/paceMinPerKm, set createdAt to DateTime.now().

    BPM rounding: Use roundToDouble() for all derived BPMs (e.g., (170 * 0.85).roundToDouble() = 145.0).
  </implementation>
</feature>

<verification>
Run: `cd /Users/tijmen/running-playlist-ai && flutter test test/features/run_plan/domain/run_plan_calculator_test.dart`
All tests pass, including all existing tests (no regressions) and all new tests for createWarmUpCoolDownPlan and createIntervalPlan.
</verification>

<success_criteria>
- createWarmUpCoolDownPlan exists and produces correct 3-segment plans
- createIntervalPlan exists and produces correct N*2+2 segment plans
- BPM fractions applied correctly (85% warm-up/cool-down, 80% rest)
- Edge case: short run clamps main segment to 60s minimum
- All new tests pass
- All existing 35 tests still pass (no regressions)
- JSON round-trip works for both new plan types
</success_criteria>

<output>
After completion, create `.planning/phases/08-structured-run-types/08-01-SUMMARY.md`
</output>
