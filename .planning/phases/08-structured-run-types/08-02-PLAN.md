---
phase: 08-structured-run-types
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - lib/features/run_plan/presentation/run_plan_screen.dart
autonomous: false

must_haves:
  truths:
    - "User can select between Steady, Warm-up/Cool-down, and Intervals run types"
    - "Selecting Warm-up/Cool-down shows sliders for warm-up and cool-down duration"
    - "Selecting Intervals shows sliders for interval count, work duration, and rest duration"
    - "Summary card shows per-segment BPM breakdown for structured runs"
    - "Saving a warm-up/cool-down plan calls createWarmUpCoolDownPlan and persists it"
    - "Saving an interval plan calls createIntervalPlan and persists it"
    - "Switching run types preserves distance and pace selections"
  artifacts:
    - path: "lib/features/run_plan/presentation/run_plan_screen.dart"
      provides: "Run type selector, type-specific forms, segment timeline, updated save logic"
      contains: "SegmentedButton<RunType>"
      min_lines: 350
  key_links:
    - from: "lib/features/run_plan/presentation/run_plan_screen.dart"
      to: "lib/features/run_plan/domain/run_plan_calculator.dart"
      via: "calls createWarmUpCoolDownPlan and createIntervalPlan"
      pattern: "RunPlanCalculator\\.create(WarmUpCoolDown|Interval)Plan"
    - from: "lib/features/run_plan/presentation/run_plan_screen.dart"
      to: "lib/features/run_plan/providers/run_plan_providers.dart"
      via: "calls runPlanNotifierProvider.notifier.setPlan"
      pattern: "runPlanNotifierProvider\\.notifier.*setPlan"
---

<objective>
Extend RunPlanScreen to support warm-up/cool-down and interval run types with a type selector, type-specific configuration forms, segment timeline visualization, and updated save logic.

Purpose: Users need to configure structured runs (warm-up/cool-down, intervals) through the same run plan screen they already use for steady runs. The domain logic is in place (Plan 01), this plan wires it to the UI.

Output: Updated run_plan_screen.dart with run type selector, configuration panels, and segment-aware summary card.
</objective>

<execution_context>
@/Users/tijmen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tijmen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-structured-run-types/08-RESEARCH.md
@.planning/phases/08-structured-run-types/08-01-SUMMARY.md
@lib/features/run_plan/presentation/run_plan_screen.dart
@lib/features/run_plan/domain/run_plan_calculator.dart
@lib/features/run_plan/domain/run_plan.dart
@lib/features/run_plan/providers/run_plan_providers.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add run type selector and type-specific configuration forms</name>
  <files>lib/features/run_plan/presentation/run_plan_screen.dart</files>
  <action>
    Extend the existing RunPlanScreen with the following additions to _RunPlanScreenState:

    **New state variables:**
    - `RunType _selectedRunType = RunType.steady;`
    - `int _warmUpMinutes = 5;` (for warm-up/cool-down and intervals)
    - `int _coolDownMinutes = 5;` (for warm-up/cool-down and intervals)
    - `int _intervalCount = 4;` (for intervals)
    - `int _workSeconds = 120;` (for intervals, stored in seconds for slider granularity)
    - `int _restSeconds = 60;` (for intervals)

    **In build() method, insert AFTER the pace dropdown section and BEFORE the summary card:**

    1. Run Type Selector - A `SegmentedButton<RunType>` with three segments:
       - Steady (icon: Icons.trending_flat)
       - Warm-up (icon: Icons.show_chart, value: RunType.warmUpCoolDown)
       - Intervals (icon: Icons.stacked_bar_chart, value: RunType.interval)
       Wrap in Padding with vertical spacing. Use `onSelectionChanged` to update `_selectedRunType`.

    2. Warm-Up/Cool-Down Config (shown when _selectedRunType == RunType.warmUpCoolDown):
       - "Warm-up Duration" label + Slider (min: 1, max: 15, divisions: 14, value: _warmUpMinutes)
       - "Cool-down Duration" label + Slider (min: 1, max: 15, divisions: 14, value: _coolDownMinutes)
       - Show the selected value in minutes as the slider label

    3. Interval Config (shown when _selectedRunType == RunType.interval):
       - "Intervals" label + Slider (min: 2, max: 20, divisions: 18, value: _intervalCount)
       - "Work Duration" label + Slider (min: 30, max: 600, divisions: 19, value: _workSeconds)
         Show formatted duration as label using formatDuration(_workSeconds)
       - "Rest Duration" label + Slider (min: 15, max: 300, divisions: 19, value: _restSeconds)
         Show formatted duration as label using formatDuration(_restSeconds)

    **Update _buildSummaryCard:**

    For steady runs, keep existing single-BPM summary.

    For structured runs (warmUpCoolDown or interval), generate a preview plan using the calculator factory methods with current state, then display:
    - Total duration (sum of all segments)
    - A segment timeline: a `ClipRRect` with `BorderRadius.circular(4)` containing a `Row` of `Expanded` containers. Each segment gets a proportional flex based on `(segment.durationSeconds / totalDurationSeconds * 1000).round()`. Use different colors per segment type:
      - Warm-up: theme.colorScheme.tertiary
      - Main/Work: theme.colorScheme.primary
      - Rest: theme.colorScheme.secondary
      - Cool-down: theme.colorScheme.tertiary
      Height: 24, show BPM value as centered text in each bar (use labelSmall style).
    - Below the bar, list each segment as a _SummaryRow showing "{label}: {formatDuration(durationSeconds)} @ {targetBpm.round()} bpm"

    **Update _savePlan:**

    Branch on `_selectedRunType`:
    - `RunType.steady`: existing createSteadyPlan call (no change)
    - `RunType.warmUpCoolDown`: call `RunPlanCalculator.createWarmUpCoolDownPlan(distanceKm: _selectedDistance, paceMinPerKm: _selectedPace, targetBpm: bpm, warmUpSeconds: _warmUpMinutes * 60, coolDownSeconds: _coolDownMinutes * 60)`
    - `RunType.interval`: call `RunPlanCalculator.createIntervalPlan(distanceKm: _selectedDistance, paceMinPerKm: _selectedPace, targetBpm: bpm, intervalCount: _intervalCount, workSeconds: _workSeconds, restSeconds: _restSeconds, warmUpSeconds: _warmUpMinutes * 60, coolDownSeconds: _coolDownMinutes * 60)`

    Then set via `ref.read(runPlanNotifierProvider.notifier).setPlan(plan)` as before.

    **Important details:**
    - Import RunType from run_plan.dart (already imported)
    - The SegmentedButton label for warmUpCoolDown should be short: "Warm-up" (not "Warm-up/Cool-down")
    - Preserve all existing functionality for steady runs -- the existing UI should work identically when Steady is selected
    - Do NOT change the distance chips, pace dropdown, or custom distance input
    - Use setState() for all slider callbacks
    - All slider label parameters need String type, use `'$_warmUpMinutes min'` for minute sliders, `formatDuration(_workSeconds)` for second sliders, `'$_intervalCount'` for count slider
  </action>
  <verify>
    Run `cd /Users/tijmen/running-playlist-ai && flutter analyze lib/features/run_plan/presentation/run_plan_screen.dart` -- zero errors or warnings.
    Run `cd /Users/tijmen/running-playlist-ai && flutter test` -- all existing tests pass (no regressions).
  </verify>
  <done>
    - SegmentedButton with three run types renders at top of form
    - Warm-up/cool-down config shows/hides based on selection with duration sliders
    - Interval config shows/hides based on selection with count, work, rest sliders
    - Summary card shows segment timeline for structured runs
    - Save button creates correct plan type based on selection
    - Steady run flow unchanged
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete structured run types UI: run type selector, warm-up/cool-down configuration, interval configuration, segment timeline visualization, and save logic for all three run types.</what-built>
  <how-to-verify>
    1. Run `cd /Users/tijmen/running-playlist-ai && flutter run -d chrome`
    2. Navigate to "Plan Run" screen
    3. Verify the run type selector shows three options: Steady, Warm-up, Intervals
    4. Select "Steady" -- verify existing flow works identically (distance, pace, single BPM summary, save)
    5. Select "Warm-up" -- verify warm-up and cool-down duration sliders appear (1-15 min range)
    6. Set distance=5K, pace=6:00/km, warm-up=5min, cool-down=5min -- verify summary shows 3 segments with BPM timeline bar
    7. Verify warm-up/cool-down segments show ~85% of main BPM
    8. Save the warm-up/cool-down plan -- verify snackbar confirms save
    9. Select "Intervals" -- verify interval count, work duration, and rest duration sliders appear
    10. Set 4 intervals, 2:00 work, 1:00 rest -- verify summary shows segment timeline with alternating work/rest segments
    11. Verify work segments show target BPM, rest segments show ~80% of target
    12. Save the interval plan -- verify snackbar confirms save
    13. Switch back to Steady -- verify distance and pace selections are preserved
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with the UI</resume-signal>
</task>

</tasks>

<verification>
1. `flutter analyze` reports zero issues on run_plan_screen.dart
2. `flutter test` -- all existing tests pass
3. Manual verification of all three run types in Chrome
4. Segment timeline renders proportional colored bars with BPM labels
5. Save persists correct plan type (check via hot restart -- plan loads correctly)
</verification>

<success_criteria>
- Run type selector switches between Steady, Warm-up/Cool-down, and Intervals
- Each type shows appropriate configuration controls
- Summary card adapts to show single BPM (steady) or segment timeline (structured)
- All three plan types save correctly via RunPlanNotifier
- No regressions in existing steady run flow
- User approves visual verification
</success_criteria>

<output>
After completion, create `.planning/phases/08-structured-run-types/08-02-SUMMARY.md`
</output>
