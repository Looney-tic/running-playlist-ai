---
phase: 15-playlist-history
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - lib/features/playlist/presentation/widgets/segment_header.dart
  - lib/features/playlist/presentation/widgets/song_tile.dart
  - lib/features/playlist/presentation/playlist_screen.dart
  - lib/features/playlist/presentation/playlist_history_screen.dart
  - lib/features/playlist/presentation/playlist_history_detail_screen.dart
  - lib/app/router.dart
autonomous: false

must_haves:
  truths:
    - "User navigates to /playlist-history and sees a list of previously generated playlists with date, distance, and pace"
    - "User taps a playlist in history and sees all tracks with title, artist, BPM, and segment info"
    - "User swipes to delete a playlist, confirms in dialog, and it disappears from the list"
    - "Empty history shows a friendly message directing user to generate a playlist"
    - "Shared SegmentHeader and SongTile widgets are used by both playlist screen and detail screen"
  artifacts:
    - path: "lib/features/playlist/presentation/playlist_history_screen.dart"
      provides: "History list screen with Dismissible delete"
      contains: "PlaylistHistoryScreen"
    - path: "lib/features/playlist/presentation/playlist_history_detail_screen.dart"
      provides: "Detail screen showing all tracks of a saved playlist"
      contains: "PlaylistHistoryDetailScreen"
    - path: "lib/features/playlist/presentation/widgets/segment_header.dart"
      provides: "Shared SegmentHeader widget"
      contains: "class SegmentHeader"
    - path: "lib/features/playlist/presentation/widgets/song_tile.dart"
      provides: "Shared SongTile widget"
      contains: "class SongTile"
  key_links:
    - from: "lib/app/router.dart"
      to: "lib/features/playlist/presentation/playlist_history_screen.dart"
      via: "GoRoute path '/playlist-history'"
      pattern: "PlaylistHistoryScreen"
    - from: "lib/app/router.dart"
      to: "lib/features/playlist/presentation/playlist_history_detail_screen.dart"
      via: "GoRoute path '/playlist-history/:id'"
      pattern: "PlaylistHistoryDetailScreen"
    - from: "lib/features/playlist/presentation/playlist_history_screen.dart"
      to: "lib/features/playlist/providers/playlist_history_providers.dart"
      via: "ref.watch(playlistHistoryProvider)"
      pattern: "playlistHistoryProvider"
---

<objective>
Build playlist history UI: extract shared widgets, create the history list screen with swipe-to-delete, create the detail screen showing all tracks, and update the router to replace the placeholder.

Purpose: Complete the playlist history feature (HIST-01, HIST-02, HIST-03) with user-facing screens that consume the data layer from Plan 15-01.
Output: PlaylistHistoryScreen, PlaylistHistoryDetailScreen, shared SegmentHeader/SongTile widgets, updated router.
</objective>

<execution_context>
@/Users/tijmen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tijmen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-playlist-history/15-RESEARCH.md
@.planning/phases/15-playlist-history/15-01-SUMMARY.md

@lib/features/playlist/presentation/playlist_screen.dart
@lib/features/playlist/providers/playlist_history_providers.dart
@lib/features/playlist/domain/playlist.dart
@lib/app/router.dart
@lib/features/home/presentation/home_screen.dart
@lib/features/run_plan/domain/run_plan.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract shared widgets and create history screens</name>
  <files>
    lib/features/playlist/presentation/widgets/segment_header.dart
    lib/features/playlist/presentation/widgets/song_tile.dart
    lib/features/playlist/presentation/playlist_screen.dart
    lib/features/playlist/presentation/playlist_history_screen.dart
    lib/features/playlist/presentation/playlist_history_detail_screen.dart
  </files>
  <action>
**1. Extract SegmentHeader** to `lib/features/playlist/presentation/widgets/segment_header.dart`:

Create the file with the widget extracted from `_SegmentHeader` in `playlist_screen.dart`. Make it public (remove underscore):

```dart
import 'package:flutter/material.dart';

/// Segment header row displayed above songs in a playlist section.
///
/// Shared between the playlist generation screen and playlist history
/// detail screen.
class SegmentHeader extends StatelessWidget {
  const SegmentHeader({required this.label, super.key});

  final String label;

  @override
  Widget build(BuildContext context) {
    return Container(
      width: double.infinity,
      padding: const EdgeInsets.fromLTRB(16, 12, 16, 4),
      color: Theme.of(context).colorScheme.surfaceContainerHighest,
      child: Text(
        label,
        style: TextStyle(
          fontSize: 14,
          fontWeight: FontWeight.bold,
          color: Theme.of(context).colorScheme.onSurfaceVariant,
        ),
      ),
    );
  }
}
```

**2. Extract SongTile** to `lib/features/playlist/presentation/widgets/song_tile.dart`:

Extract from `_SongTile` in `playlist_screen.dart`. Make it public. Keep all the bottom sheet and URL launching logic:

```dart
import 'package:flutter/material.dart';
import 'package:running_playlist_ai/features/bpm_lookup/domain/bpm_song.dart';
import 'package:running_playlist_ai/features/playlist/domain/playlist.dart';
import 'package:url_launcher/url_launcher.dart';

/// Individual song tile with tap-to-open external link.
///
/// Shared between the playlist generation screen and playlist history
/// detail screen.
class SongTile extends StatelessWidget {
  const SongTile({required this.song, super.key});

  final PlaylistSong song;

  @override
  Widget build(BuildContext context) {
    return ListTile(
      title: Text(
        song.title,
        maxLines: 1,
        overflow: TextOverflow.ellipsis,
      ),
      subtitle: Text(
        '${song.artistName}  ${_matchLabel(song.matchType)}',
        maxLines: 1,
        overflow: TextOverflow.ellipsis,
      ),
      trailing: Text(
        '${song.bpm} BPM',
        style: TextStyle(
          color: Theme.of(context).colorScheme.primary,
          fontWeight: FontWeight.w500,
        ),
      ),
      onTap: () => _showPlayOptions(context),
    );
  }

  String _matchLabel(BpmMatchType type) {
    switch (type) {
      case BpmMatchType.exact:
        return '';
      case BpmMatchType.halfTime:
        return '(half-time)';
      case BpmMatchType.doubleTime:
        return '(double-time)';
    }
  }

  void _showPlayOptions(BuildContext context) {
    showModalBottomSheet<void>(
      context: context,
      builder: (context) => SafeArea(
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Padding(
              padding: const EdgeInsets.all(16),
              child: Text(
                '${song.title} - ${song.artistName}',
                style: const TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.bold,
                ),
                textAlign: TextAlign.center,
              ),
            ),
            const Divider(height: 1),
            if (song.spotifyUrl != null)
              ListTile(
                leading: const Icon(Icons.music_note),
                title: const Text('Open in Spotify'),
                onTap: () {
                  Navigator.pop(context);
                  _launchUrl(context, song.spotifyUrl!);
                },
              ),
            if (song.youtubeUrl != null)
              ListTile(
                leading: const Icon(Icons.play_circle_outline),
                title: const Text('Open in YouTube Music'),
                onTap: () {
                  Navigator.pop(context);
                  _launchUrl(context, song.youtubeUrl!);
                },
              ),
            const SizedBox(height: 8),
          ],
        ),
      ),
    );
  }

  Future<void> _launchUrl(BuildContext context, String url) async {
    final uri = Uri.parse(url);
    if (!await launchUrl(uri, mode: LaunchMode.externalApplication)) {
      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('Could not open link')),
        );
      }
    }
  }
}
```

**3. Update playlist_screen.dart** to use the shared widgets:

Replace the private `_SegmentHeader` and `_SongTile` classes with imports of the shared widgets:

- Add imports at the top:
```dart
import 'package:running_playlist_ai/features/playlist/presentation/widgets/segment_header.dart';
import 'package:running_playlist_ai/features/playlist/presentation/widgets/song_tile.dart';
```

- Remove the import that is no longer needed directly (but keep it if other code uses it -- check):
  - `import 'package:url_launcher/url_launcher.dart';` -- REMOVE (moved into SongTile)
  - `import 'package:running_playlist_ai/features/bpm_lookup/domain/bpm_song.dart';` -- REMOVE (moved into SongTile)

- In `_PlaylistView.build()`, replace `_SegmentHeader(label: song.segmentLabel)` with `SegmentHeader(label: song.segmentLabel)` and `_SongTile(song: song)` with `SongTile(song: song)`.

- DELETE the entire `_SegmentHeader` class (lines 347-368 approximately).
- DELETE the entire `_SongTile` class (lines 370-465 approximately).

After these changes, `playlist_screen.dart` should still compile and function identically. The `_NoRunPlanView`, `_LoadingView`, `_ErrorView`, `_IdleView`, and `_PlaylistView` classes remain private in the file.

**4. Create PlaylistHistoryScreen** at `lib/features/playlist/presentation/playlist_history_screen.dart`:

```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';
import 'package:running_playlist_ai/features/playlist/domain/playlist.dart';
import 'package:running_playlist_ai/features/playlist/providers/playlist_history_providers.dart';

/// Screen displaying a list of previously generated playlists.
///
/// Each entry shows the run plan name, date, distance, and pace.
/// Swipe left to delete with confirmation dialog. Tap to view details.
class PlaylistHistoryScreen extends ConsumerWidget {
  const PlaylistHistoryScreen({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final playlists = ref.watch(playlistHistoryProvider);

    return Scaffold(
      appBar: AppBar(title: const Text('Playlist History')),
      body: playlists.isEmpty
          ? const _EmptyHistoryView()
          : ListView.builder(
              itemCount: playlists.length,
              itemBuilder: (context, index) {
                final playlist = playlists[index];
                return Dismissible(
                  key: Key(playlist.id ?? index.toString()),
                  direction: DismissDirection.endToStart,
                  confirmDismiss: (_) => _confirmDelete(context),
                  onDismissed: (_) {
                    if (playlist.id != null) {
                      ref
                          .read(playlistHistoryProvider.notifier)
                          .deletePlaylist(playlist.id!);
                    }
                    ScaffoldMessenger.of(context).showSnackBar(
                      const SnackBar(
                        content: Text('Playlist deleted'),
                      ),
                    );
                  },
                  background: Container(
                    color: Colors.red,
                    alignment: Alignment.centerRight,
                    padding: const EdgeInsets.only(right: 16),
                    child:
                        const Icon(Icons.delete, color: Colors.white),
                  ),
                  child: ListTile(
                    title: Text(
                      playlist.runPlanName ?? 'Untitled Run',
                    ),
                    subtitle: Text(_formatSubtitle(playlist)),
                    trailing: Text(
                      '${playlist.songs.length} songs',
                      style: TextStyle(
                        color: Theme.of(context).colorScheme.primary,
                      ),
                    ),
                    onTap: () {
                      if (playlist.id != null) {
                        context.push(
                          '/playlist-history/${playlist.id}',
                        );
                      }
                    },
                  ),
                );
              },
            ),
    );
  }

  Future<bool?> _confirmDelete(BuildContext context) {
    return showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Delete Playlist'),
        content: const Text(
          'Are you sure you want to delete this playlist?',
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: const Text('Cancel'),
          ),
          TextButton(
            onPressed: () => Navigator.pop(context, true),
            child: const Text('Delete'),
          ),
        ],
      ),
    );
  }

  String _formatSubtitle(Playlist playlist) {
    final date = playlist.createdAt.toLocal();
    final dateStr = '${date.day}/${date.month}/${date.year}';
    final parts = <String>[dateStr];
    if (playlist.distanceKm != null) {
      parts.add('${playlist.distanceKm!.toStringAsFixed(1)} km');
    }
    if (playlist.paceMinPerKm != null) {
      final mins = playlist.paceMinPerKm!.floor();
      final secs =
          ((playlist.paceMinPerKm! - mins) * 60).round();
      parts.add("$mins'${secs.toString().padLeft(2, '0')}\"/km");
    }
    return parts.join(' - ');
  }
}

/// Shown when the user has no saved playlists.
class _EmptyHistoryView extends StatelessWidget {
  const _EmptyHistoryView();

  @override
  Widget build(BuildContext context) {
    return Center(
      child: Padding(
        padding: const EdgeInsets.all(24),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const Icon(Icons.history, size: 64, color: Colors.grey),
            const SizedBox(height: 16),
            const Text(
              'No Playlists Yet',
              style: TextStyle(
                fontSize: 20,
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: 8),
            const Text(
              'Generated playlists will appear here. '
              'Go generate your first playlist!',
              textAlign: TextAlign.center,
              style: TextStyle(fontSize: 16, color: Colors.grey),
            ),
            const SizedBox(height: 24),
            ElevatedButton.icon(
              onPressed: () => context.push('/playlist'),
              icon: const Icon(Icons.queue_music),
              label: const Text('Generate Playlist'),
            ),
          ],
        ),
      ),
    );
  }
}
```

**5. Create PlaylistHistoryDetailScreen** at `lib/features/playlist/presentation/playlist_history_detail_screen.dart`:

```dart
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:running_playlist_ai/features/playlist/domain/playlist.dart';
import 'package:running_playlist_ai/features/playlist/presentation/widgets/segment_header.dart';
import 'package:running_playlist_ai/features/playlist/presentation/widgets/song_tile.dart';
import 'package:running_playlist_ai/features/playlist/providers/playlist_history_providers.dart';
import 'package:running_playlist_ai/features/run_plan/domain/run_plan.dart';

/// Detail screen for a saved playlist from history.
///
/// Displays run metadata (date, distance, pace, duration) and all
/// tracks grouped by segment, using the shared [SegmentHeader] and
/// [SongTile] widgets.
class PlaylistHistoryDetailScreen extends ConsumerWidget {
  const PlaylistHistoryDetailScreen({
    required this.playlistId,
    super.key,
  });

  final String playlistId;

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final playlists = ref.watch(playlistHistoryProvider);
    final playlist =
        playlists.where((p) => p.id == playlistId).firstOrNull;

    if (playlist == null) {
      return Scaffold(
        appBar: AppBar(title: const Text('Playlist')),
        body: const Center(child: Text('Playlist not found')),
      );
    }

    return Scaffold(
      appBar: AppBar(
        title: Text(playlist.runPlanName ?? 'Playlist'),
        actions: [
          IconButton(
            onPressed: () => _copyPlaylist(context, playlist),
            icon: const Icon(Icons.copy),
            tooltip: 'Copy playlist to clipboard',
          ),
        ],
      ),
      body: Column(
        children: [
          _PlaylistSummaryHeader(playlist: playlist),
          const Divider(),
          Expanded(
            child: ListView.builder(
              padding: const EdgeInsets.only(bottom: 16),
              itemCount: playlist.songs.length,
              itemBuilder: (context, index) {
                final song = playlist.songs[index];
                final showSegmentHeader = index == 0 ||
                    playlist.songs[index - 1].segmentLabel !=
                        song.segmentLabel;

                return Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    if (showSegmentHeader)
                      SegmentHeader(label: song.segmentLabel),
                    SongTile(song: song),
                  ],
                );
              },
            ),
          ),
        ],
      ),
    );
  }

  Future<void> _copyPlaylist(
    BuildContext context,
    Playlist playlist,
  ) async {
    await Clipboard.setData(
      ClipboardData(text: playlist.toClipboardText()),
    );
    if (context.mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Playlist copied to clipboard!'),
        ),
      );
    }
  }
}

/// Summary header showing run metadata for the saved playlist.
class _PlaylistSummaryHeader extends StatelessWidget {
  const _PlaylistSummaryHeader({required this.playlist});

  final Playlist playlist;

  @override
  Widget build(BuildContext context) {
    final date = playlist.createdAt.toLocal();
    final dateStr =
        '${date.day}/${date.month}/${date.year} at '
        '${date.hour.toString().padLeft(2, '0')}:'
        '${date.minute.toString().padLeft(2, '0')}';

    return Padding(
      padding: const EdgeInsets.fromLTRB(16, 16, 16, 0),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            '${playlist.songs.length} songs',
            style: const TextStyle(
              fontSize: 16,
              fontWeight: FontWeight.bold,
            ),
          ),
          const SizedBox(height: 4),
          Text(
            _buildMetaLine(dateStr),
            style: const TextStyle(
              fontSize: 14,
              color: Colors.grey,
            ),
          ),
        ],
      ),
    );
  }

  String _buildMetaLine(String dateStr) {
    final parts = <String>[dateStr];
    if (playlist.distanceKm != null) {
      parts.add(
        '${playlist.distanceKm!.toStringAsFixed(1)} km',
      );
    }
    if (playlist.paceMinPerKm != null) {
      final mins = playlist.paceMinPerKm!.floor();
      final secs =
          ((playlist.paceMinPerKm! - mins) * 60).round();
      parts.add(
        "$mins'${secs.toString().padLeft(2, '0')}\"/km",
      );
    }
    parts.add(formatDuration(playlist.totalDurationSeconds));
    return parts.join(' - ');
  }
}
```

**IMPORTANT NOTES for Task 1:**
- Create the `widgets/` directory under `lib/features/playlist/presentation/` before creating files in it.
- When removing `_SegmentHeader` and `_SongTile` from `playlist_screen.dart`, make sure you remove the `url_launcher` and `bpm_song.dart` imports ONLY if no other code in that file uses them. Since `_SongTile` was the only user of both, they can be safely removed.
- The `PlaylistScreen._copyPlaylist` still uses `Clipboard` from `flutter/services.dart`, so that import stays.
- The `PlaylistScreen` still uses `go_router` for navigation, so that import stays.
  </action>
  <verify>
Run static analysis on all modified files:
```bash
cd /Users/tijmen/running-playlist-ai && flutter analyze lib/features/playlist/presentation/ lib/app/router.dart
```

No errors. Then run existing playlist tests to confirm nothing broke:
```bash
cd /Users/tijmen/running-playlist-ai && flutter test test/features/playlist/
```

All tests pass.
  </verify>
  <done>
- SegmentHeader and SongTile extracted to shared widgets
- playlist_screen.dart uses shared widgets (no duplication)
- PlaylistHistoryScreen shows list with date/distance/pace, swipe-to-delete with confirmation
- PlaylistHistoryDetailScreen shows all tracks grouped by segment with shared widgets
- Empty history shows friendly message with button to generate
  </done>
</task>

<task type="auto">
  <name>Task 2: Update router and remove placeholder</name>
  <files>
    lib/app/router.dart
  </files>
  <action>
**1. Update router.dart** to replace the `_ComingSoonScreen` placeholder with real screens:

Add imports at the top:
```dart
import 'package:running_playlist_ai/features/playlist/presentation/playlist_history_screen.dart';
import 'package:running_playlist_ai/features/playlist/presentation/playlist_history_detail_screen.dart';
```

Replace the existing `/playlist-history` GoRoute:
```dart
GoRoute(
  path: '/playlist-history',
  builder: (context, state) =>
      const _ComingSoonScreen(title: 'Playlist History'),
),
```

With a nested route structure:
```dart
GoRoute(
  path: '/playlist-history',
  builder: (context, state) => const PlaylistHistoryScreen(),
  routes: [
    GoRoute(
      path: ':id',
      builder: (context, state) {
        final id = state.pathParameters['id']!;
        return PlaylistHistoryDetailScreen(playlistId: id);
      },
    ),
  ],
),
```

**2. Remove the `_ComingSoonScreen` class** entirely (it was only used by the playlist-history route). It spans approximately lines 51-64.

**3. Clean up unused imports**: After removing `_ComingSoonScreen`, check if any imports are no longer needed. The `flutter/material.dart` import is still needed by GoRouter builders, so it stays. The `flutter_riverpod` import is still needed by routerProvider, so it stays.
  </action>
  <verify>
Run static analysis:
```bash
cd /Users/tijmen/running-playlist-ai && flutter analyze lib/app/router.dart
```

No errors or warnings. No references to `_ComingSoonScreen` remain.

Verify the route structure is valid:
```bash
cd /Users/tijmen/running-playlist-ai && grep -n "ComingSoon" lib/app/router.dart
```

Should produce zero matches.
  </verify>
  <done>
- `/playlist-history` route points to PlaylistHistoryScreen
- `/playlist-history/:id` nested route points to PlaylistHistoryDetailScreen
- `_ComingSoonScreen` placeholder removed
- Router compiles without errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete playlist history feature: history list screen with swipe-to-delete, detail screen with segment-grouped tracks, auto-save after generation, shared widgets.
  </what-built>
  <how-to-verify>
1. Run the app: `flutter run`
2. Generate a playlist (go to Generate Playlist, tap Generate)
3. Navigate back to home, tap "Playlist History"
4. Verify: The generated playlist appears in the list with run plan name, date, distance, and pace
5. Tap the playlist entry
6. Verify: Detail screen shows all tracks grouped by segment with title, artist, BPM, and segment headers. Tapping a song shows Spotify/YouTube bottom sheet.
7. Navigate back to history list
8. Swipe left on the playlist entry
9. Verify: Confirmation dialog appears ("Delete this playlist?")
10. Tap "Delete"
11. Verify: Playlist disappears from the list, empty state shows "No Playlists Yet"
12. Generate another playlist, go back to history
13. Verify: New playlist appears in the list (auto-save works)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
Run full test suite:
```bash
cd /Users/tijmen/running-playlist-ai && flutter test
```

Run static analysis:
```bash
cd /Users/tijmen/running-playlist-ai && flutter analyze
```

Both must pass with zero errors.
</verification>

<success_criteria>
1. History list screen shows all previously generated playlists with date, distance, pace (HIST-01)
2. Tapping a playlist shows all tracks with title, artist, BPM, segment info (HIST-02)
3. Swipe-to-delete with confirmation removes playlist from list (HIST-03)
4. Shared SegmentHeader and SongTile widgets eliminate code duplication
5. Router uses nested `/playlist-history/:id` for detail navigation
6. `_ComingSoonScreen` placeholder is removed
7. All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/15-playlist-history/15-02-SUMMARY.md`
</output>
