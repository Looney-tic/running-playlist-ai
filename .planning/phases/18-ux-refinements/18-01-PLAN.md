---
phase: 18-ux-refinements
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/features/taste_profile/domain/taste_profile.dart
  - lib/features/song_quality/domain/song_quality_scorer.dart
  - lib/features/stride/providers/stride_providers.dart
  - test/features/taste_profile/domain/taste_profile_test.dart
  - test/features/song_quality/domain/song_quality_scorer_test.dart
autonomous: true

must_haves:
  truths:
    - "TasteProfile can store vocal preference, tempo variance tolerance, and disliked artists"
    - "Existing TasteProfile JSON without new fields deserializes without error (backward compatibility)"
    - "Disliked artists receive a -15 penalty in SongQualityScorer"
    - "Strict tempo variance tolerance reduces half/double-time BPM scores to 0"
    - "Loose tempo variance tolerance boosts half/double-time BPM scores close to exact"
    - "StrideNotifier.nudgeCadence adjusts cadence by the given delta and persists"
    - "Nudged cadence is clamped within 150-200 spm range"
  artifacts:
    - path: "lib/features/taste_profile/domain/taste_profile.dart"
      provides: "VocalPreference enum, TempoVarianceTolerance enum, extended TasteProfile model"
      contains: "VocalPreference"
    - path: "lib/features/song_quality/domain/song_quality_scorer.dart"
      provides: "Disliked artist scoring + tempo-variance-aware BPM scoring"
      contains: "dislikedArtistPenalty"
    - path: "lib/features/stride/providers/stride_providers.dart"
      provides: "nudgeCadence method"
      contains: "nudgeCadence"
    - path: "test/features/taste_profile/domain/taste_profile_test.dart"
      provides: "Tests for new enums, fromJson backward compatibility, copyWith, toJson"
    - path: "test/features/song_quality/domain/song_quality_scorer_test.dart"
      provides: "Tests for disliked artist penalty + tempo variance scoring"
  key_links:
    - from: "lib/features/song_quality/domain/song_quality_scorer.dart"
      to: "lib/features/taste_profile/domain/taste_profile.dart"
      via: "TasteProfile.dislikedArtists and tempoVarianceTolerance used in scoring"
      pattern: "tasteProfile\\.dislikedArtists"
---

<objective>
Extend TasteProfile with three new preference fields (vocal preference, tempo variance tolerance, disliked artists), add disliked-artist and tempo-variance-aware scoring to SongQualityScorer, and add a nudgeCadence method to StrideNotifier -- all test-driven.

Purpose: These domain/scoring changes are the foundation for Phase 18 UX features. The UI plans depend on these models and methods existing.
Output: Extended TasteProfile model, enhanced SongQualityScorer, StrideNotifier.nudgeCadence, with comprehensive unit tests.
</objective>

<execution_context>
@/Users/tijmen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tijmen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/features/taste_profile/domain/taste_profile.dart
@lib/features/song_quality/domain/song_quality_scorer.dart
@lib/features/stride/providers/stride_providers.dart
@test/features/taste_profile/domain/taste_profile_test.dart
@test/features/song_quality/domain/song_quality_scorer_test.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD - Extend TasteProfile model with new preference fields</name>
  <files>
    lib/features/taste_profile/domain/taste_profile.dart
    test/features/taste_profile/domain/taste_profile_test.dart
  </files>
  <action>
RED: Write failing tests first in taste_profile_test.dart:
- VocalPreference enum: test fromJson for all 3 values (noPreference, preferVocals, preferInstrumental), test fromJson with unknown string falls back to noPreference
- TempoVarianceTolerance enum: test fromJson for all 3 values (strict, moderate, loose), test fromJson with unknown string falls back to moderate
- TasteProfile.fromJson backward compatibility: test that JSON with only original 3 fields (genres, artists, energyLevel) deserializes successfully, new fields default to VocalPreference.noPreference, TempoVarianceTolerance.moderate, and empty dislikedArtists
- TasteProfile.fromJson with all fields: test that JSON with all 6 fields deserializes correctly
- TasteProfile.toJson roundtrip: test that toJson includes new fields, and fromJson(toJson) roundtrips correctly
- TasteProfile.copyWith: test updating vocalPreference, tempoVarianceTolerance, and dislikedArtists individually
- Disliked/favorite mutual exclusivity is NOT enforced in the model (it's a UI/notifier concern) -- do NOT test for it here

GREEN: Implement in taste_profile.dart:
1. Add VocalPreference enum with values: noPreference, preferVocals, preferInstrumental. Include static fromJson method using firstWhere with orElse fallback to noPreference.
2. Add TempoVarianceTolerance enum with values: strict, moderate, loose. Include static fromJson method with orElse fallback to moderate.
3. Add three new fields to TasteProfile constructor with defaults:
   - vocalPreference = VocalPreference.noPreference
   - tempoVarianceTolerance = TempoVarianceTolerance.moderate
   - dislikedArtists = const []
4. Update fromJson: use null-safe access for new fields: `json['vocalPreference'] != null ? VocalPreference.fromJson(json['vocalPreference'] as String) : VocalPreference.noPreference` (same pattern for tempoVarianceTolerance). For dislikedArtists: `(json['dislikedArtists'] as List<dynamic>?)?.map((a) => a as String).toList() ?? const []`
5. Update toJson: add vocalPreference.name, tempoVarianceTolerance.name, dislikedArtists
6. Update copyWith: add nullable parameters for all three new fields

Run tests: `flutter test test/features/taste_profile/domain/taste_profile_test.dart`
  </action>
  <verify>All taste_profile_test.dart tests pass including the new backward-compatibility tests. Run `flutter test test/features/taste_profile/domain/taste_profile_test.dart` -- all green.</verify>
  <done>TasteProfile has VocalPreference, TempoVarianceTolerance, dislikedArtists fields. Old JSON without these fields deserializes without error. toJson/fromJson roundtrips. copyWith works for new fields.</done>
</task>

<task type="auto">
  <name>Task 2: TDD - Add disliked artist penalty and tempo-variance-aware BPM scoring to SongQualityScorer, and nudgeCadence to StrideNotifier</name>
  <files>
    lib/features/song_quality/domain/song_quality_scorer.dart
    test/features/song_quality/domain/song_quality_scorer_test.dart
    lib/features/stride/providers/stride_providers.dart
  </files>
  <action>
RED: Write failing tests in song_quality_scorer_test.dart:

Disliked artist tests:
- Song by a disliked artist gets -15 penalty (test score with a BpmSong whose artistName is in tasteProfile.dislikedArtists)
- Bidirectional substring match: disliked "Drake" matches song artist "Drake feat. Rihanna", and disliked "Drake feat. Rihanna" matches song artist "Drake"
- Song by a non-disliked artist gets 0 penalty
- Empty dislikedArtists list: no penalty applied
- Null tasteProfile: no penalty applied

Tempo variance scoring tests:
- With TempoVarianceTolerance.strict: exact BPM song gets exactBpmWeight (3), half-time/double-time song gets 0
- With TempoVarianceTolerance.moderate (default): exact BPM song gets exactBpmWeight (3), half-time/double-time song gets tempoVariantWeight (1) -- this is the current behavior, should not change
- With TempoVarianceTolerance.loose: exact BPM song gets exactBpmWeight (3), half-time/double-time song gets 2 (closer to exact)
- Null tasteProfile: moderate behavior (unchanged from current)

GREEN: Implement in song_quality_scorer.dart:
1. Add constant: `static const dislikedArtistPenalty = -15;`
2. Add constant: `static const looseTempoVariantWeight = 2;`
3. Add `_dislikedArtistScore` static method: takes BpmSong and TasteProfile?. If tasteProfile null or dislikedArtists empty, return 0. Otherwise, use same bidirectional substring match as _artistMatchScore but check against dislikedArtists. Return dislikedArtistPenalty if matched, 0 otherwise.
4. Modify `_bpmMatchScore` to accept TasteProfile? parameter: if tasteProfile?.tempoVarianceTolerance is strict, return 0 for non-exact matches. If loose, return looseTempoVariantWeight for non-exact. If moderate or null, return existing tempoVariantWeight (1). Exact always returns exactBpmWeight (3).
5. Update `score()` method: add `total += _dislikedArtistScore(song, tasteProfile);` and pass tasteProfile to `_bpmMatchScore`.

StrideNotifier.nudgeCadence (NOT TDD -- simple mutation, add directly):
1. Add `nudgeCadence(int deltaBpm)` method to StrideNotifier:
   - Compute `newCadence = (state.cadence + deltaBpm).clamp(150.0, 200.0)`
   - Set state via `state = state.copyWith(calibratedCadence: () => newCadence)`
   - Call `_persist()`
2. This reuses the calibratedCadence mechanism -- nudging is equivalent to setting a calibrated override.

Run tests: `flutter test test/features/song_quality/domain/song_quality_scorer_test.dart`
  </action>
  <verify>All song_quality_scorer_test.dart tests pass including the new disliked artist and tempo variance tests. Run `flutter test test/features/song_quality/domain/song_quality_scorer_test.dart` -- all green. Also run `flutter test` to confirm no regressions across the full test suite.</verify>
  <done>SongQualityScorer applies -15 penalty for disliked artists using bidirectional substring match. BPM scoring respects TempoVarianceTolerance (strict=0, moderate=1, loose=2 for non-exact). StrideNotifier has nudgeCadence(int deltaBpm) that clamps to 150-200 and persists. All existing tests still pass.</done>
</task>

</tasks>

<verification>
1. `flutter test test/features/taste_profile/domain/taste_profile_test.dart` -- all tests pass
2. `flutter test test/features/song_quality/domain/song_quality_scorer_test.dart` -- all tests pass
3. `flutter test` -- full suite passes with no regressions
4. `flutter analyze` -- no analysis issues
</verification>

<success_criteria>
- TasteProfile model extended with 3 new fields + 2 new enums
- Backward-compatible JSON deserialization (old profiles load without crash)
- SongQualityScorer scores disliked artists with -15 penalty
- SongQualityScorer BPM scoring varies by TempoVarianceTolerance
- StrideNotifier.nudgeCadence exists and clamps to 150-200
- All tests pass including new TDD tests
</success_criteria>

<output>
After completion, create `.planning/phases/18-ux-refinements/18-01-SUMMARY.md`
</output>
