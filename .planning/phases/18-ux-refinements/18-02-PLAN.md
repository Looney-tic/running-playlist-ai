---
phase: 18-ux-refinements
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - lib/features/playlist/presentation/widgets/song_tile.dart
  - lib/features/home/presentation/home_screen.dart
  - lib/features/playlist/presentation/playlist_screen.dart
  - lib/features/taste_profile/presentation/taste_profile_screen.dart
  - lib/features/taste_profile/providers/taste_profile_providers.dart
  - lib/app/router.dart
autonomous: false

must_haves:
  truths:
    - "User can tap +/- buttons to nudge cadence by 2-3 BPM from the playlist screen header area"
    - "User can tap +/- buttons to nudge cadence from the home screen"
    - "Returning user sees a quick-regenerate card on home screen when a run plan exists"
    - "Tapping quick-regenerate navigates to playlist screen and auto-triggers generation"
    - "Songs with runningQuality >= 20 display a quality star icon in the song list"
    - "User can set vocal preference via SegmentedButton on taste profile screen"
    - "User can set tempo variance tolerance via SegmentedButton on taste profile screen"
    - "User can add/remove disliked artists on taste profile screen"
    - "Adding an artist to disliked removes them from favorites (mutual exclusivity)"
    - "Taste profile Save button includes all new fields"
  artifacts:
    - path: "lib/features/playlist/presentation/widgets/song_tile.dart"
      provides: "Quality badge icon for high-scoring songs"
      contains: "runningQuality"
    - path: "lib/features/home/presentation/home_screen.dart"
      provides: "Quick-regenerate card + cadence nudge row"
      contains: "nudgeCadence"
    - path: "lib/features/playlist/presentation/playlist_screen.dart"
      provides: "Cadence nudge row in playlist header + auto-trigger support"
      contains: "nudgeCadence"
    - path: "lib/features/taste_profile/presentation/taste_profile_screen.dart"
      provides: "Vocal preference, tempo variance, disliked artists sections"
      contains: "VocalPreference"
    - path: "lib/features/taste_profile/providers/taste_profile_providers.dart"
      provides: "Disliked artist add/remove with mutual exclusivity enforcement"
      contains: "addDislikedArtist"
    - path: "lib/app/router.dart"
      provides: "Query parameter support for /playlist?auto=true"
      contains: "queryParameters"
  key_links:
    - from: "lib/features/home/presentation/home_screen.dart"
      to: "lib/features/stride/providers/stride_providers.dart"
      via: "ref.read(strideNotifierProvider.notifier).nudgeCadence(delta)"
      pattern: "nudgeCadence"
    - from: "lib/features/home/presentation/home_screen.dart"
      to: "lib/app/router.dart"
      via: "context.push('/playlist?auto=true')"
      pattern: "auto=true"
    - from: "lib/features/playlist/presentation/playlist_screen.dart"
      to: "lib/features/playlist/providers/playlist_providers.dart"
      via: "Auto-trigger generatePlaylist on mount when auto query param present"
      pattern: "auto.*generatePlaylist"
    - from: "lib/features/taste_profile/presentation/taste_profile_screen.dart"
      to: "lib/features/taste_profile/providers/taste_profile_providers.dart"
      via: "setProfile includes new TasteProfile fields"
      pattern: "vocalPreference|tempoVarianceTolerance|dislikedArtists"
---

<objective>
Wire all four UX requirements into the UI: cadence nudge buttons on home + playlist screens, quick-regenerate card on home screen, quality badges on song tiles, and extended taste preference controls.

Purpose: Deliver the user-facing experience for all Phase 18 requirements (UX-01 through UX-04).
Output: Updated screens and widgets, with all UX requirements visible and functional.
</objective>

<execution_context>
@/Users/tijmen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tijmen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-ux-refinements/18-01-SUMMARY.md
@lib/features/playlist/presentation/widgets/song_tile.dart
@lib/features/home/presentation/home_screen.dart
@lib/features/playlist/presentation/playlist_screen.dart
@lib/features/taste_profile/presentation/taste_profile_screen.dart
@lib/features/taste_profile/providers/taste_profile_providers.dart
@lib/app/router.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Quality badge, cadence nudge widget, quick-regenerate, taste profile UI, and auto-trigger wiring</name>
  <files>
    lib/features/playlist/presentation/widgets/song_tile.dart
    lib/features/home/presentation/home_screen.dart
    lib/features/playlist/presentation/playlist_screen.dart
    lib/features/taste_profile/presentation/taste_profile_screen.dart
    lib/features/taste_profile/providers/taste_profile_providers.dart
    lib/app/router.dart
  </files>
  <action>
**1. Quality badge on SongTile (UX-03):**
In song_tile.dart, add a leading widget to the ListTile that displays a quality indicator:
- If `song.runningQuality != null && song.runningQuality! >= 20`, show `Icon(Icons.star, size: 20, color: Colors.amber)` as the leading widget
- If below threshold or null, set leading to null (no indicator)
- The threshold of 20 out of max 36 surfaces songs with multiple positive scoring signals

**2. TasteProfile provider extensions (UX-04):**
In taste_profile_providers.dart, add to TasteProfileNotifier:
- `Future<void> addDislikedArtist(String artist)`: validates non-empty, max 10, no case-insensitive duplicates. ALSO: remove the artist from favorites if present (mutual exclusivity). Add to dislikedArtists, persist via setProfile.
- `Future<void> removeDislikedArtist(String artist)`: remove from dislikedArtists, persist via setProfile.
- `Future<void> setVocalPreference(VocalPreference pref)`: update profile via copyWith, persist.
- `Future<void> setTempoVarianceTolerance(TempoVarianceTolerance tolerance)`: update profile via copyWith, persist.
- Update existing `addArtist` method: also remove the artist from dislikedArtists if present (mutual exclusivity in both directions).

**3. Taste profile screen extensions (UX-04):**
In taste_profile_screen.dart, add three new sections between the Energy Level section and the Save button:
- **Vocal Preference section:** Title "Vocal Preference", SegmentedButton<VocalPreference> with three segments: "No Preference" (Icons.remove), "Prefer Vocals" (Icons.mic), "Prefer Instrumental" (Icons.piano). Local state variable `_selectedVocalPreference`, synced from profile on init like other fields.
- **Tempo Tolerance section:** Title "Tempo Matching", SegmentedButton<TempoVarianceTolerance> with three segments: "Strict" (Icons.gps_fixed), "Moderate" (Icons.adjust), "Loose" (Icons.all_inclusive). Local state variable `_selectedTempoVarianceTolerance`, synced from profile.
- **Disliked Artists section:** Title "Disliked Artists", subtitle "Songs by these artists will be excluded ({count}/10)". Same TextField + InputChip pattern as the favorite artists section, but using a separate `_dislikedArtists` list and `_dislikedArtistController`. InputChips with delete icons.
- Update `_saveProfile()` to include new fields: `TasteProfile(genres: ..., artists: ..., energyLevel: ..., vocalPreference: _selectedVocalPreference, tempoVarianceTolerance: _selectedTempoVarianceTolerance, dislikedArtists: List.of(_dislikedArtists))`
- Update the initialization block to also sync `_selectedVocalPreference`, `_selectedTempoVarianceTolerance`, and `_dislikedArtists` from the loaded profile.

**4. Router update for auto-trigger (UX-02):**
In router.dart, update the /playlist GoRoute to pass query parameters to PlaylistScreen:
```dart
GoRoute(
  path: '/playlist',
  builder: (context, state) => PlaylistScreen(
    autoGenerate: state.uri.queryParameters['auto'] == 'true',
  ),
),
```

**5. Playlist screen: auto-trigger and cadence nudge (UX-01, UX-02):**
In playlist_screen.dart:
- Add `autoGenerate` parameter to PlaylistScreen constructor (default false). Convert to ConsumerStatefulWidget to handle initState for auto-trigger.
- In initState: if `widget.autoGenerate` is true and a run plan exists, call `ref.read(playlistGenerationProvider.notifier).generatePlaylist()` via `WidgetsBinding.instance.addPostFrameCallback`.
- Add a cadence nudge row to the _PlaylistView above the song list (between the summary header and the Divider). Row with: `-3` IconButton, `-1` IconButton, Text showing current cadence from strideNotifierProvider (e.g., "172 spm"), `+1` IconButton, `+3` IconButton. Each button calls `ref.read(strideNotifierProvider.notifier).nudgeCadence(delta)`. Use compact IconButton with Icons.remove and Icons.add. Style the nudge row with a subtle background using Theme.of(context).colorScheme.surfaceVariant.
- Note: nudging cadence does NOT regenerate the playlist automatically. The user sees the updated cadence and can tap "Regenerate" if they want a new playlist at the new cadence.

**6. Home screen: quick-regenerate card and cadence nudge (UX-01, UX-02):**
In home_screen.dart:
- Import strideNotifierProvider and runPlanNotifierProvider
- Restructure the body: replace the Center+Column layout with a SingleChildScrollView+Column that has both the existing navigation buttons AND new cards.
- Above the existing buttons, add a conditional section:
  - Watch `runPlanNotifierProvider`. If a RunPlan exists, show a Card with: ListTile leading Icon(Icons.replay), title "Regenerate Playlist", subtitle showing run plan summary ("{distance} km at {cadence} spm"), onTap navigates to `/playlist?auto=true`.
  - Below the quick-regenerate card, show a cadence nudge row: Row with `-3` button, `-1` button, cadence Text from strideNotifierProvider, `+1` button, `+3` button. Same widget pattern as playlist screen. Wrap in a Card for visual consistency.
- Keep all existing navigation buttons below the new cards.
  </action>
  <verify>
1. `flutter analyze` -- no analysis issues
2. `flutter test` -- no regressions in existing tests
3. Manual: Navigate to taste profile, verify three new sections appear (vocal preference, tempo tolerance, disliked artists)
4. Manual: Save taste profile with new preferences, restart app, verify they persist
5. Manual: Generate a playlist, verify quality stars appear on high-scoring songs
6. Manual: On home screen with a run plan, verify quick-regenerate card appears and tapping it navigates to playlist and auto-generates
7. Manual: Verify cadence nudge buttons on both home and playlist screens adjust the displayed cadence
  </verify>
  <done>All four UX requirements are visible and functional: cadence nudge on home+playlist screens, quick-regenerate card on home, quality badges on songs, extended taste preferences with all new controls.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 18 UX Refinements: cadence nudge buttons, quick-regenerate, quality badges, and extended taste preferences.</what-built>
  <how-to-verify>
    1. Start the app and verify the home screen shows a "Regenerate Playlist" card if you have a saved run plan. Tap it and confirm it navigates to the playlist screen and auto-starts generation.
    2. On the home screen, verify +/- cadence nudge buttons appear showing your current cadence. Tap +3 and -1 buttons to confirm cadence changes.
    3. On the playlist screen (after generation), verify songs with gold star icons appear (these are high-quality songs with score >= 20).
    4. On the playlist screen, verify cadence nudge buttons appear above the song list.
    5. Navigate to Taste Profile. Verify three new sections: Vocal Preference (3-way toggle), Tempo Matching (3-way toggle), and Disliked Artists (text input + chips).
    6. Add a disliked artist that is also in your favorites list. Verify it is removed from favorites.
    7. Save the taste profile, force-restart the app, and verify all new preferences persisted.
    8. Generate a new playlist and verify disliked artists do not appear (or appear much lower in the list due to the -15 penalty).
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
1. `flutter analyze` -- clean
2. `flutter test` -- all tests pass (including new TDD tests from Plan 01)
3. All four requirements verified:
   - UX-01: Cadence nudge +/- buttons on home and playlist screens
   - UX-02: Quick-regenerate card on home screen with auto-trigger
   - UX-03: Quality star badges on high-scoring songs
   - UX-04: Vocal preference, tempo variance, and disliked artists on taste profile screen
</verification>

<success_criteria>
- Cadence nudge buttons visible and functional on both home and playlist screens
- Quick-regenerate card appears on home screen when run plan exists
- Auto-trigger navigates to playlist and starts generation
- Quality star icon visible on songs with runningQuality >= 20
- Three new taste preference sections in taste profile screen
- Disliked artist / favorite artist mutual exclusivity enforced
- All preferences persist across app restarts
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/18-ux-refinements/18-02-SUMMARY.md`
</output>
