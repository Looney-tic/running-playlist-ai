---
phase: 19-regeneration-reliability
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - lib/features/playlist/presentation/playlist_screen.dart
autonomous: true

must_haves:
  truths:
    - "Tapping 'Shuffle' on a generated playlist produces a different song order instantly without showing a loading spinner"
    - "Tapping 'Generate' after switching run plan or taste profile via inline selector uses the updated selection"
    - "Home screen 'Regenerate' navigates to playlist screen which generates with current provider state"
  artifacts:
    - path: "lib/features/playlist/presentation/playlist_screen.dart"
      provides: "Shuffle button wired to shufflePlaylist(), Generate button wired to generatePlaylist()"
      contains: "shufflePlaylist"
  key_links:
    - from: "lib/features/playlist/presentation/playlist_screen.dart"
      to: "PlaylistGenerationNotifier.shufflePlaylist()"
      via: "onRegenerate callback in _PlaylistView"
      pattern: "shufflePlaylist"
    - from: "lib/features/playlist/presentation/playlist_screen.dart"
      to: "PlaylistGenerationNotifier.generatePlaylist()"
      via: "onGenerate callback in _IdleView and 'Generate' button in _PlaylistView"
      pattern: "generatePlaylist"
---

<objective>
Wire the playlist screen UI to use shufflePlaylist() for instant shuffle and generatePlaylist() for fresh generation.

Purpose: Complete REGEN-01 by connecting the "Shuffle" button to the new instant shufflePlaylist() method, and ensure REGEN-03 by adding a "Generate" button alongside "Shuffle" in the playlist view so users can trigger a full regeneration after changing selections. The home screen auto-generate flow (REGEN-02) already works correctly because it calls generatePlaylist() which now has readiness guards from Plan 01.

Output: Updated playlist_screen.dart with correct button wiring.
</objective>

<execution_context>
@/Users/tijmen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tijmen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-regeneration-reliability/19-01-SUMMARY.md
@lib/features/playlist/presentation/playlist_screen.dart
@lib/features/playlist/providers/playlist_providers.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire Shuffle button to shufflePlaylist() and add Generate button</name>
  <files>
    lib/features/playlist/presentation/playlist_screen.dart
  </files>
  <action>
Three changes in playlist_screen.dart:

**A) Change _PlaylistView to accept separate shuffle and generate callbacks:**

Update `_PlaylistView` to take two callbacks instead of one:
```dart
class _PlaylistView extends ConsumerWidget {
  const _PlaylistView({
    required this.playlist,
    required this.onShuffle,
    required this.onGenerate,
  });

  final Playlist playlist;
  final VoidCallback onShuffle;
  final VoidCallback onGenerate;
```

**B) Wire the existing "Shuffle" button (FilledButton.tonalIcon) to onShuffle:**

In the summary header card, the existing button:
```dart
FilledButton.tonalIcon(
  onPressed: onShuffle,  // was: onRegenerate
  icon: const Icon(Icons.refresh_rounded, size: 18),
  label: const Text('Shuffle'),
),
```

**C) Add a "Generate" button next to the selectors:**

After the run plan + taste profile selector row (the `Padding` with `Row` containing two `Expanded` children), add a "Generate" button that triggers a full fresh generation. Place it in the same Padding area:

```dart
// Selectors
Padding(
  padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
  child: Row(
    children: [
      Expanded(child: _RunPlanSelector()),
      const SizedBox(width: 8),
      Expanded(child: _TasteProfileSelector()),
      const SizedBox(width: 8),
      FilledButton.tonalIcon(
        onPressed: onGenerate,
        icon: const Icon(Icons.play_arrow_rounded, size: 18),
        label: const Text('Generate'),
      ),
    ],
  ),
),
```

This makes the flow clear: selectors to change inputs, "Generate" to create a fresh playlist with those inputs, "Shuffle" to re-arrange the current songs.

**D) Update _buildBody to pass both callbacks:**

In `_buildBody`, where `_PlaylistView` is constructed:
```dart
return _PlaylistView(
  playlist: state.playlist!,
  onShuffle: () => ref
      .read(playlistGenerationProvider.notifier)
      .shufflePlaylist(),
  onGenerate: () => ref
      .read(playlistGenerationProvider.notifier)
      .generatePlaylist(),
);
```

The _IdleView's onGenerate callback stays the same (calls generatePlaylist()). The _ErrorView's onRetry stays the same (calls generatePlaylist()). Only the _PlaylistView changes.
  </action>
  <verify>
Run `dart analyze lib/features/playlist/presentation/playlist_screen.dart` -- no errors.
Run `flutter test` to check no regressions (expect pre-existing widget_test failure only).
Grep for `shufflePlaylist` in playlist_screen.dart to confirm wiring exists.
  </verify>
  <done>
- "Shuffle" button in _PlaylistView calls shufflePlaylist() (instant, no spinner)
- "Generate" button next to selectors calls generatePlaylist() (fetches fresh songs with current selections)
- _IdleView "Generate Playlist" button still calls generatePlaylist()
- Home screen auto-generate path unchanged (calls generatePlaylist() which has readiness guards)
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify full integration with build and analysis</name>
  <files>
    lib/features/playlist/presentation/playlist_screen.dart
    lib/features/playlist/providers/playlist_providers.dart
    lib/features/run_plan/providers/run_plan_providers.dart
    lib/features/taste_profile/providers/taste_profile_providers.dart
  </files>
  <action>
Run full project analysis and build to confirm all changes integrate cleanly:

1. `dart analyze lib/` -- entire lib directory must pass with no errors (warnings OK).
2. `flutter build web --no-pub` (or `flutter build apk --debug` if web fails) -- confirms no compilation errors across the full dependency graph.
3. `flutter test` -- all tests pass except pre-existing widget_test.dart failure.

If any issues are found, fix them. Common things to watch for:
- Missing import for `dart:async` (Completer) in provider files
- Type mismatch if curatedRunnabilityProvider returns different type than expected
- Widget constructor parameter changes causing callers to break (only _PlaylistView changes, and it's private to playlist_screen.dart so no external callers)

This is a verification task, not a coding task. Only fix issues discovered during verification.
  </action>
  <verify>
`dart analyze lib/` exits with 0 errors.
`flutter test` output shows only the pre-existing widget_test failure.
  </verify>
  <done>
All modified files compile cleanly. No new test failures introduced. The three REGEN requirements are fully implemented at both provider and UI layers.
  </done>
</task>

</tasks>

<verification>
1. `dart analyze lib/` -- zero errors across all modified files.
2. `flutter test` -- no new failures beyond pre-existing widget_test.
3. Manual verification checklist (for user):
   - Launch app, generate a playlist, tap "Shuffle" -- instant new arrangement, no spinner.
   - Close app fully, reopen, tap "Regenerate" from home -- no crash, playlist generates.
   - On playlist screen, switch taste profile via selector, tap "Generate" -- new playlist reflects the selected profile.
</verification>

<success_criteria>
- "Shuffle" button calls shufflePlaylist() (grep confirms)
- "Generate" button exists next to selectors and calls generatePlaylist()
- Full project builds and analyzes without errors
- All three REGEN requirements are addressed end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/19-regeneration-reliability/19-02-SUMMARY.md`
</output>
