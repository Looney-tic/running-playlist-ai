---
phase: 21-onboarding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/features/onboarding/data/onboarding_preferences.dart
  - lib/features/onboarding/providers/onboarding_providers.dart
  - lib/features/onboarding/presentation/onboarding_screen.dart
  - lib/main.dart
  - lib/app/router.dart
autonomous: true

must_haves:
  truths:
    - "A brand-new user (no stored data) sees a guided onboarding flow on first launch -- not the regular home screen"
    - "User can pick genres, set pace/distance, and arrive at a generated playlist"
    - "User can skip any onboarding step and still reach playlist generation with sensible defaults (pop+rock, balanced energy, 5km at 5:30/km)"
    - "After completing onboarding the user is marked as onboarded and never sees the flow again"
    - "A returning user who has already completed onboarding goes directly to the home screen"
  artifacts:
    - path: "lib/features/onboarding/data/onboarding_preferences.dart"
      provides: "SharedPreferences persistence for onboarding-completed flag"
      contains: "onboarding_completed"
    - path: "lib/features/onboarding/providers/onboarding_providers.dart"
      provides: "Riverpod provider for sync onboarding state"
    - path: "lib/features/onboarding/presentation/onboarding_screen.dart"
      provides: "Multi-step onboarding flow UI"
      min_lines: 80
    - path: "lib/main.dart"
      provides: "Pre-loads onboarding flag before GoRouter init"
    - path: "lib/app/router.dart"
      provides: "Redirect logic: if not onboarded, redirect to /onboarding"
  key_links:
    - from: "lib/main.dart"
      to: "lib/features/onboarding/data/onboarding_preferences.dart"
      via: "Pre-loads onboarding flag synchronously before runApp"
      pattern: "OnboardingPreferences"
    - from: "lib/app/router.dart"
      to: "lib/features/onboarding/providers/onboarding_providers.dart"
      via: "GoRouter redirect reads onboarding state"
      pattern: "onboardingProvider"
    - from: "lib/features/onboarding/presentation/onboarding_screen.dart"
      to: "lib/features/taste_profile/providers/taste_profile_providers.dart"
      via: "Creates taste profile using TasteProfileLibraryNotifier.addProfile()"
      pattern: "tasteProfileLibraryProvider"
    - from: "lib/features/onboarding/presentation/onboarding_screen.dart"
      to: "lib/features/run_plan/providers/run_plan_providers.dart"
      via: "Creates run plan using RunPlanLibraryNotifier.addPlan()"
      pattern: "runPlanLibraryProvider"
---

<objective>
Build the complete onboarding flow: data persistence, GoRouter redirect, and multi-step onboarding screens that create a taste profile and run plan, then navigate to playlist generation.

Purpose: First-time users should be guided from launch to their first generated playlist without needing to discover the app's workflow. Covers ONBD-01 and ONBD-02.

Output: Onboarding data layer, provider, multi-step onboarding screen, updated main.dart and router.dart with redirect logic.
</objective>

<execution_context>
@/Users/tijmen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tijmen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@lib/main.dart
@lib/app/app.dart
@lib/app/router.dart
@lib/features/taste_profile/domain/taste_profile.dart
@lib/features/taste_profile/providers/taste_profile_providers.dart
@lib/features/run_plan/domain/run_plan.dart
@lib/features/run_plan/domain/run_plan_calculator.dart
@lib/features/run_plan/providers/run_plan_providers.dart
@lib/features/stride/providers/stride_providers.dart
@lib/features/playlist/providers/playlist_providers.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Onboarding data layer, provider, and GoRouter redirect</name>
  <files>
    lib/features/onboarding/data/onboarding_preferences.dart
    lib/features/onboarding/providers/onboarding_providers.dart
    lib/main.dart
    lib/app/router.dart
  </files>
  <action>
    **1. Create `lib/features/onboarding/data/onboarding_preferences.dart`:**
    - Static class `OnboardingPreferences` with SharedPreferences key `onboarding_completed` (bool).
    - `static Future<bool> isCompleted()` — reads the flag (defaults to false).
    - `static Future<void> markCompleted()` — sets the flag to true.
    - `static Future<void> preload()` — called in main.dart before GoRouter init. Reads the flag and stores it in a static `bool completedSync` field so the GoRouter redirect can read it synchronously without async. This is the pattern from the planning context ("Onboarding flag pre-loaded in main.dart before GoRouter init (sync redirect)").

    **2. Create `lib/features/onboarding/providers/onboarding_providers.dart`:**
    - A `StateProvider<bool>` named `onboardingCompletedProvider` initialized from `OnboardingPreferences.completedSync`.
    - This lets the router redirect read onboarding state synchronously.

    **3. Update `lib/main.dart`:**
    - After `WidgetsFlutterBinding.ensureInitialized()` and before `runApp()`, call `await OnboardingPreferences.preload()`.
    - Import the onboarding preferences file.

    **4. Update `lib/app/router.dart`:**
    - Add a `redirect` callback to GoRouter that checks `ref.read(onboardingCompletedProvider)`.
    - If NOT completed and location is NOT `/onboarding`, redirect to `/onboarding`.
    - If completed and location IS `/onboarding`, redirect to `/` (prevent returning to onboarding).
    - Add a new GoRoute for `/onboarding` that builds `OnboardingScreen`.
    - Import the onboarding provider and screen files.

    **Important:** The router redirect must be synchronous — no async. That's why we pre-load the flag in main.dart. The redirect reads from the StateProvider which was initialized from the pre-loaded sync value.
  </action>
  <verify>
    Run `dart analyze lib/features/onboarding/ lib/main.dart lib/app/router.dart` — no errors or warnings (except pre-existing ones).
    Verify `OnboardingPreferences.completedSync` is initialized in main.dart before GoRouter.
  </verify>
  <done>
    - OnboardingPreferences persists a boolean flag via SharedPreferences
    - Pre-loaded sync flag available before GoRouter init
    - GoRouter redirects new users (not onboarded) to /onboarding
    - GoRouter redirects returning users away from /onboarding to /
    - Provider exposes onboarding state for router and widgets
  </done>
</task>

<task type="auto">
  <name>Task 2: Multi-step onboarding screen with profile/plan creation and skip support</name>
  <files>
    lib/features/onboarding/presentation/onboarding_screen.dart
  </files>
  <action>
    **Create `lib/features/onboarding/presentation/onboarding_screen.dart`:**

    Build a `ConsumerStatefulWidget` with a `PageView` (or equivalent stepper) for these steps:

    **Step 0 — Welcome:**
    - Headline: "Running Playlist AI"
    - Subtitle: "Create playlists that match your running rhythm"
    - Single "Get Started" button to advance to Step 1.

    **Step 1 — Pick Genres:**
    - Reuse the `RunningGenre.values` chip pattern from TasteProfileScreen.
    - FilterChip wrap for genre selection (1-5 genres). Pre-select `pop` and `rock` as defaults.
    - "Next" button to advance. "Skip" text button to skip (keeps defaults: pop+rock).

    **Step 2 — Set Pace & Distance:**
    - Distance preset chips (5K, 10K, Half, Marathon) — pre-select 5K (5.0 km).
    - Pace dropdown (reuse same _paceOptions pattern from RunPlanScreen) — pre-select 5:30/km (5.5).
    - "Next" button. "Skip" text button (keeps defaults: 5km, 5:30/km).

    **Step 3 — Finish & Generate:**
    - Summary: "Ready to generate your first playlist!"
    - Show selected genres (chips) and run info (distance, pace).
    - "Generate My Playlist" button that:
      1. Creates a TasteProfile with the selected genres (and sensible defaults for other fields: balanced energy, noPreference vocal, moderate tempo tolerance, empty artists/dislikedArtists/decades) using `ref.read(tasteProfileLibraryProvider.notifier).addProfile(profile)`.
      2. Creates a RunPlan using `RunPlanCalculator.createSteadyPlan()` with selected distance, pace, and BPM derived from `RunPlanCalculator.targetBpm(paceMinPerKm: pace)` — then saves via `ref.read(runPlanLibraryProvider.notifier).addPlan(plan)`.
      3. Marks onboarding complete: `await OnboardingPreferences.markCompleted()` and `ref.read(onboardingCompletedProvider.notifier).state = true`.
      4. Navigates to `/playlist?auto=true` (which triggers auto-generation on mount via the existing PlaylistScreen autoGenerate logic).

    **Skip-all behavior:** Each skip button advances to the next step with defaults intact. If user hits "Skip" on every step, the final "Generate My Playlist" button still works because defaults are pre-populated (pop+rock genres, 5km, 5:30/km, balanced energy).

    **Navigation:** Use PageController for smooth transitions between steps. Show a LinearProgressIndicator or step indicator at the top (step N of 4). Back button on steps 1-3 goes to previous step. AppBar back arrow on step 0 does nothing (no prior screen).

    **Styling:** Use Material 3 patterns consistent with the rest of the app. Keep it clean and focused — no heavy illustrations or animations (the app uses useMaterial3: true with deepPurple colorSchemeSeed).
  </action>
  <verify>
    Run `dart analyze lib/features/onboarding/presentation/onboarding_screen.dart` — no errors.
    Verify the file imports TasteProfile, RunPlanCalculator, RunPlanLibraryNotifier, TasteProfileLibraryNotifier, OnboardingPreferences, and onboardingCompletedProvider.
    Verify "Skip" buttons exist for steps 1 and 2.
    Verify "Generate My Playlist" button calls addProfile(), addPlan(), markCompleted(), and navigates to /playlist?auto=true.
  </verify>
  <done>
    - Four-step onboarding flow: Welcome -> Genres -> Pace/Distance -> Generate
    - Genres default to pop+rock, distance to 5K, pace to 5:30/km
    - Skip buttons on steps 1 and 2 preserve defaults and advance
    - Final step creates TasteProfile and RunPlan via existing notifiers
    - Marks onboarding complete and navigates to /playlist?auto=true
    - Step indicator visible throughout
  </done>
</task>

</tasks>

<verification>
1. `dart analyze lib/` — no new errors introduced
2. Verify new user redirect: GoRouter redirect sends unboarded users to /onboarding
3. Verify returning user bypass: GoRouter redirect sends onboarded users to /
4. Verify skip path: default profile has pop+rock genres, balanced energy; default plan has 5km, 5:30/km
5. Verify completion path: onboarding creates profile + plan, marks complete, navigates to playlist with auto=true
</verification>

<success_criteria>
- Brand-new user (no SharedPreferences data) is redirected to /onboarding on first launch
- User sees 4-step flow: Welcome -> Genres -> Pace -> Generate
- User can skip genre and pace steps, keeping sensible defaults
- "Generate My Playlist" creates a TasteProfile and RunPlan, marks onboarding complete, and navigates to /playlist?auto=true
- Returning user (onboarding_completed = true) goes directly to home screen and cannot navigate back to /onboarding
</success_criteria>

<output>
After completion, create `.planning/phases/21-onboarding/21-01-SUMMARY.md`
</output>
