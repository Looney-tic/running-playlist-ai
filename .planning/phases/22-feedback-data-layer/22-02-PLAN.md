---
phase: 22-feedback-data-layer
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - lib/features/song_feedback/providers/song_feedback_providers.dart
  - test/features/song_feedback/domain/song_feedback_test.dart
  - test/features/song_feedback/song_feedback_lifecycle_test.dart
autonomous: true

must_haves:
  truths:
    - "SongFeedback entries survive app restart without data loss"
    - "Feedback lookup by song key returns the correct state in constant time"
    - "Adding, updating, and removing feedback all persist across provider disposal and reload"
  artifacts:
    - path: "lib/features/song_feedback/providers/song_feedback_providers.dart"
      provides: "SongFeedbackNotifier StateNotifier with CRUD + ensureLoaded + Riverpod provider"
      exports: ["songFeedbackProvider", "SongFeedbackNotifier"]
    - path: "test/features/song_feedback/domain/song_feedback_test.dart"
      provides: "Unit tests for SongKey.normalize and SongFeedback model"
      contains: "SongKey.normalize"
    - path: "test/features/song_feedback/song_feedback_lifecycle_test.dart"
      provides: "Lifecycle and persistence round-trip tests for SongFeedbackNotifier"
      contains: "persistence round-trip"
  key_links:
    - from: "lib/features/song_feedback/providers/song_feedback_providers.dart"
      to: "lib/features/song_feedback/data/song_feedback_preferences.dart"
      via: "load and save calls in notifier"
      pattern: "SongFeedbackPreferences\\.(load|save)"
    - from: "lib/features/song_feedback/providers/song_feedback_providers.dart"
      to: "lib/features/song_feedback/domain/song_feedback.dart"
      via: "Map<String, SongFeedback> state type"
      pattern: "Map<String, SongFeedback>"
---

<objective>
Create the SongFeedbackNotifier state management provider and comprehensive test suite covering the entire feedback data layer (model, persistence, notifier, key normalization).

Purpose: Completes the feedback data layer by wiring persistence to reactive state management. The test suite proves all three phase success criteria: persistence survives restart, O(1) lookup works, and key normalization is consistent.

Output: SongFeedbackNotifier + songFeedbackProvider + full unit/lifecycle test suite.
</objective>

<execution_context>
@/Users/tijmen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tijmen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-feedback-data-layer/22-RESEARCH.md
@.planning/phases/22-feedback-data-layer/22-01-SUMMARY.md

@lib/features/taste_profile/providers/taste_profile_providers.dart
@test/features/taste_profile/taste_profile_lifecycle_test.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: SongFeedbackNotifier and provider</name>
  <files>lib/features/song_feedback/providers/song_feedback_providers.dart</files>
  <action>
Create `lib/features/song_feedback/providers/song_feedback_providers.dart` following the TasteProfileLibraryNotifier pattern exactly.

**SongFeedbackNotifier** (extends `StateNotifier<Map<String, SongFeedback>>`):
- Constructor: `super({})` then call `_load()` (private async init)
- `final Completer<void> _loadCompleter = Completer<void>()` (from dart:async)
- `Future<void> ensureLoaded() => _loadCompleter.future` (idempotent readiness guard)
- `Future<void> _load()`:
  - try: `state = await SongFeedbackPreferences.load()`
  - finally: `if (!_loadCompleter.isCompleted) _loadCompleter.complete()`
  - Check `mounted` before setting state (see PlaylistHistoryNotifier pattern for async safety)
- `Future<void> addFeedback(SongFeedback feedback)`:
  - Optimistic update: `state = {...state, feedback.songKey: feedback}`
  - Persist: `await SongFeedbackPreferences.save(state)`
- `Future<void> removeFeedback(String songKey)`:
  - `state = Map.from(state)..remove(songKey)`
  - `await SongFeedbackPreferences.save(state)`
- `SongFeedback? getFeedback(String songKey) => state[songKey]` (O(1) lookup convenience method)

**Provider declaration:**
```dart
final songFeedbackProvider =
    StateNotifierProvider<SongFeedbackNotifier, Map<String, SongFeedback>>(
  (ref) => SongFeedbackNotifier(),
);
```

Import SongFeedback, SongFeedbackPreferences, dart:async, flutter_riverpod.
  </action>
  <verify>Run `dart analyze lib/features/song_feedback/providers/song_feedback_providers.dart` with zero errors.</verify>
  <done>SongFeedbackNotifier exists with addFeedback, removeFeedback, getFeedback, ensureLoaded. Provider declared. File compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Full test suite for feedback data layer</name>
  <files>
    test/features/song_feedback/domain/song_feedback_test.dart
    test/features/song_feedback/song_feedback_lifecycle_test.dart
  </files>
  <action>
Create two test files following the established test patterns (see taste_profile_lifecycle_test.dart).

**Test file 1: `test/features/song_feedback/domain/song_feedback_test.dart`**

Unit tests for SongKey and SongFeedback model:

group 'SongKey.normalize':
- 'lowercases and trims artist and title': `SongKey.normalize('  Eminem ', ' Lose Yourself ')` equals `'eminem|lose yourself'`
- 'handles already normalized input': `SongKey.normalize('eminem', 'lose yourself')` equals `'eminem|lose yourself'`
- 'produces identical keys for curated vs API format': both produce same key for same song

group 'SongFeedback':
- 'toJson/fromJson round-trip preserves all fields': create feedback, serialize, deserialize, compare all fields
- 'toJson excludes null genre': verify genre key not present when null
- 'toJson includes non-null genre': verify genre key present when set
- 'copyWith toggles isLiked': create liked, copyWith(isLiked: false), verify flipped
- 'copyWith updates feedbackDate': verify date change

**Test file 2: `test/features/song_feedback/song_feedback_lifecycle_test.dart`**

Lifecycle and persistence tests following taste_profile_lifecycle_test.dart pattern:

setUp: `SharedPreferences.setMockInitialValues({})` and create ProviderContainer.
tearDown: dispose container.
Helper: `_notifier()` reads provider notifier and calls ensureLoaded().

group 'SongFeedbackNotifier lifecycle':
- 'starts with empty map': read provider state, expect isEmpty
- 'addFeedback stores entry': add one feedback, state has length 1, lookup returns correct isLiked
- 'addFeedback updates existing entry': add liked, then add same songKey as disliked, state still length 1, isLiked is false
- 'removeFeedback removes entry': add then remove, state is empty
- 'removeFeedback ignores missing key': remove non-existent key, no crash, state still empty
- 'getFeedback returns null for unknown key': verify null return
- 'getFeedback returns entry for known key': add feedback, getFeedback returns it

group 'Persistence round-trip':
- 'feedback survives dispose and reload': add 2 feedbacks (one liked, one disliked), dispose container, create new container WITHOUT calling setMockInitialValues again, ensureLoaded, verify both entries present with correct isLiked values
- 'empty state persists as empty': ensure loaded, dispose, reload, still empty

All test imports: flutter_test, shared_preferences, flutter_riverpod, song_feedback, song_feedback_providers, song_feedback_preferences (as needed).
  </action>
  <verify>Run `flutter test test/features/song_feedback/` -- all tests pass. Then run `flutter test` to verify no regressions across the full suite (the pre-existing widget_test.dart failure is expected and is NOT a regression).</verify>
  <done>All song_feedback tests pass. SongKey normalization consistency proven. JSON round-trip proven. Persistence round-trip proven (survives dispose+reload). O(1) lookup via Map confirmed. No regressions in existing test suite.</done>
</task>

</tasks>

<verification>
1. `flutter test test/features/song_feedback/domain/song_feedback_test.dart` -- all SongKey and SongFeedback model tests pass
2. `flutter test test/features/song_feedback/song_feedback_lifecycle_test.dart` -- all lifecycle and persistence tests pass
3. `flutter test test/features/song_feedback/` -- entire song_feedback test suite green
4. `flutter test test/features/playlist/` -- no regressions from Plan 01 refactor (double-check)
5. `flutter test` -- full suite passes (except pre-existing widget_test.dart failure)
</verification>

<success_criteria>
- SongFeedbackNotifier provides reactive Map<String, SongFeedback> state
- addFeedback persists through SharedPreferences and survives container disposal + reload
- removeFeedback removes entry and persists the removal
- getFeedback returns correct entry in O(1) for known keys, null for unknown
- ensureLoaded() guards async init correctly (Completer pattern)
- All phase success criteria proven by tests:
  1. Entries survive app restart (persistence round-trip test)
  2. O(1) lookup works (getFeedback test + Map state type)
  3. Key normalization consistent (SongKey.normalize tests)
</success_criteria>

<output>
After completion, create `.planning/phases/22-feedback-data-layer/22-02-SUMMARY.md`
</output>
