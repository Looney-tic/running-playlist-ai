---
phase: 23-feedback-ui-scoring
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/features/playlist/domain/playlist.dart
  - lib/features/song_quality/domain/song_quality_scorer.dart
  - lib/features/playlist/domain/playlist_generator.dart
  - lib/features/playlist/providers/playlist_providers.dart
  - test/features/song_quality/domain/song_quality_scorer_test.dart
  - test/features/playlist/domain/playlist_generator_test.dart
autonomous: true

must_haves:
  truths:
    - "Disliked songs never appear in subsequently generated playlists"
    - "Liked songs rank noticeably higher than equivalent unrated songs"
    - "A liked song with poor running metrics does not outrank an unrated song with excellent running metrics"
  artifacts:
    - path: "lib/features/playlist/domain/playlist.dart"
      provides: "PlaylistSong.lookupKey getter"
      contains: "String get lookupKey"
    - path: "lib/features/song_quality/domain/song_quality_scorer.dart"
      provides: "Liked-song scoring dimension (+5)"
      contains: "likedSongWeight"
    - path: "lib/features/playlist/domain/playlist_generator.dart"
      provides: "Hard-filter disliked songs, pass isLiked to scorer"
      contains: "dislikedSongKeys"
    - path: "lib/features/playlist/providers/playlist_providers.dart"
      provides: "Feedback-aware playlist generation wiring"
      contains: "songFeedbackProvider"
  key_links:
    - from: "lib/features/playlist/providers/playlist_providers.dart"
      to: "lib/features/song_feedback/providers/song_feedback_providers.dart"
      via: "ref.read(songFeedbackProvider)"
      pattern: "songFeedbackProvider"
    - from: "lib/features/playlist/domain/playlist_generator.dart"
      to: "lib/features/song_quality/domain/song_quality_scorer.dart"
      via: "isLiked parameter in score() call"
      pattern: "isLiked:"
---

<objective>
Add feedback-aware scoring and filtering to the playlist generation pipeline: PlaylistSong.lookupKey getter, liked-song scoring boost (+5) in SongQualityScorer, hard-filter for disliked songs in PlaylistGenerator, and provider wiring to pass feedback data through generatePlaylist/shufflePlaylist/regeneratePlaylist.

Purpose: Requirements FEED-03 (disliked songs excluded) and FEED-04 (liked songs rank higher) depend on the generation pipeline being feedback-aware. This plan completes the backend so Plan 02 can wire the UI.

Output: Updated scorer, generator, playlist model, and providers with full test coverage via TDD.
</objective>

<execution_context>
@/Users/tijmen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tijmen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-feedback-data-layer/22-01-SUMMARY.md
@.planning/phases/22-feedback-data-layer/22-02-SUMMARY.md
@lib/features/song_feedback/domain/song_feedback.dart
@lib/features/song_feedback/providers/song_feedback_providers.dart
@lib/features/playlist/domain/playlist.dart
@lib/features/song_quality/domain/song_quality_scorer.dart
@lib/features/playlist/domain/playlist_generator.dart
@lib/features/playlist/providers/playlist_providers.dart
@test/features/song_quality/domain/song_quality_scorer_test.dart
@test/features/playlist/domain/playlist_generator_test.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD — Liked-song scoring boost and disliked hard-filter</name>
  <files>
    lib/features/playlist/domain/playlist.dart
    lib/features/song_quality/domain/song_quality_scorer.dart
    lib/features/playlist/domain/playlist_generator.dart
    test/features/song_quality/domain/song_quality_scorer_test.dart
    test/features/playlist/domain/playlist_generator_test.dart
  </files>
  <action>
**RED phase — write failing tests first:**

1. In `song_quality_scorer_test.dart`, add a new test group `'liked-song boost'` with these tests:
   - `'liked song scores +5 higher than equivalent unrated song'`: Call `SongQualityScorer.score()` twice with identical BpmSong, once with `isLiked: true` and once with `isLiked: false`. Assert difference equals 5.
   - `'liked song with poor metrics does NOT outrank unrated with excellent metrics'`: Create a song with danceability:10, call score with `isLiked: true, runnability: 5`. Create another with danceability:85, call score with `isLiked: false, runnability: 90`. Assert the unrated excellent score is greater.
   - `'isLiked defaults to false (backward compatible)'`: Call score without isLiked parameter, assert it equals calling with `isLiked: false`.

2. In `playlist_generator_test.dart`, add tests:
   - `'disliked songs are excluded from generated playlist'`: Create a plan with 1 segment, a songsByBpm map with 2 songs (one of which has a key in `dislikedSongKeys`). Assert the generated playlist contains only the non-disliked song.
   - `'liked songs receive isLiked boost in scoring'`: Create 2 songs with same BPM and identical attributes. Put one in `likedSongKeys`. Assert that the liked song appears first in the playlist (higher rank). Use a fixed Random seed for determinism.

3. Run tests — they must fail (RED):
   ```bash
   dart test test/features/song_quality/domain/song_quality_scorer_test.dart test/features/playlist/domain/playlist_generator_test.dart
   ```

**GREEN phase — implement to pass:**

4. In `playlist.dart`, add to `PlaylistSong`:
   ```dart
   /// Normalized lookup key for matching against feedback map.
   String get lookupKey => SongKey.normalize(artistName, title);
   ```
   Add the import for `song_feedback.dart`.

5. In `song_quality_scorer.dart`:
   - Add constant: `static const likedSongWeight = 5;`
   - Add `bool isLiked = false` optional parameter to `score()` method.
   - Add at the end of score() before return: `if (isLiked) total += likedSongWeight;`
   - Update the doc comment to reflect 9 dimensions and max score 51 (46 + 5 when liked).

6. In `playlist_generator.dart`:
   - Add two optional parameters to `generate()`: `Set<String>? dislikedSongKeys` and `Set<String>? likedSongKeys`.
   - After filtering out `usedSongIds` in the segment loop, add a hard filter for disliked songs:
     ```dart
     if (dislikedSongKeys != null && dislikedSongKeys.isNotEmpty) {
       available = available
           .where((s) => !dislikedSongKeys.contains(s.lookupKey))
           .toList();
     }
     ```
   - In `_scoreAndRank`, add optional `Set<String>? likedSongKeys` parameter. When calling `SongQualityScorer.score()`, pass `isLiked: likedSongKeys?.contains(song.lookupKey) ?? false`.
   - Update the `_scoreAndRank` call in `generate()` to pass `likedSongKeys`.

7. Run tests — they must pass (GREEN):
   ```bash
   dart test test/features/song_quality/domain/song_quality_scorer_test.dart test/features/playlist/domain/playlist_generator_test.dart
   ```

**Important notes:**
- `isLiked` MUST be optional with default `false` to maintain backward compatibility with all existing callers.
- `dislikedSongKeys` and `likedSongKeys` MUST be optional to maintain backward compatibility.
- Do NOT change the existing "best case" composite score test. The existing test calls without `isLiked` so it still expects 46 (correct since default is false).
  </action>
  <verify>
    `dart test test/features/song_quality/domain/song_quality_scorer_test.dart` passes (all existing + 3 new).
    `dart test test/features/playlist/domain/playlist_generator_test.dart` passes (all existing + 2 new).
  </verify>
  <done>
    SongQualityScorer.score() accepts isLiked parameter and adds +5 when true.
    PlaylistGenerator.generate() accepts dislikedSongKeys (hard-filters them out) and likedSongKeys (passes isLiked to scorer).
    PlaylistSong.lookupKey getter delegates to SongKey.normalize().
    All existing tests still pass (backward compatible).
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire feedback into PlaylistGenerationNotifier</name>
  <files>
    lib/features/playlist/providers/playlist_providers.dart
  </files>
  <action>
Wire the songFeedbackProvider into all three generation paths (generatePlaylist, shufflePlaylist, regeneratePlaylist) in PlaylistGenerationNotifier.

1. Add import for `song_feedback_providers.dart` at top of file.

2. Create a private helper method on PlaylistGenerationNotifier:
   ```dart
   /// Reads current feedback and splits into disliked/liked key sets.
   ({Set<String> disliked, Set<String> liked}) _readFeedbackSets() {
     final feedbackMap = ref.read(songFeedbackProvider);
     final disliked = <String>{};
     final liked = <String>{};
     for (final entry in feedbackMap.entries) {
       if (entry.value.isLiked) {
         liked.add(entry.key);
       } else {
         disliked.add(entry.key);
       }
     }
     return (disliked: disliked, liked: liked);
   }
   ```

3. In `generatePlaylist()`:
   - After `await ref.read(tasteProfileLibraryProvider.notifier).ensureLoaded();`, add:
     `await ref.read(songFeedbackProvider.notifier).ensureLoaded();`
   - Before the `PlaylistGenerator.generate()` call, add:
     `final feedback = _readFeedbackSets();`
   - Pass to generate:
     `dislikedSongKeys: feedback.disliked.isNotEmpty ? feedback.disliked : null,`
     `likedSongKeys: feedback.liked.isNotEmpty ? feedback.liked : null,`

4. In `shufflePlaylist()`:
   - Before the `PlaylistGenerator.generate()` call, add:
     `final feedback = _readFeedbackSets();`
   - Pass same dislikedSongKeys and likedSongKeys to generate.

5. In `regeneratePlaylist()`:
   - After the curatedRunnability block, add:
     `await ref.read(songFeedbackProvider.notifier).ensureLoaded();`
     `final feedback = _readFeedbackSets();`
   - Pass same dislikedSongKeys and likedSongKeys to generate.

**Important: All three generation paths MUST be updated.** This prevents the pitfall where disliked songs reappear only when shuffling (Pitfall 1 from research).
  </action>
  <verify>
    `dart analyze lib/features/playlist/providers/playlist_providers.dart` passes with no errors.
    `dart test` passes (all existing tests still work since feedback provider defaults to empty map).
  </verify>
  <done>
    All three generation paths (generatePlaylist, shufflePlaylist, regeneratePlaylist) read songFeedbackProvider and pass disliked/liked sets to PlaylistGenerator.generate().
    ensureLoaded() is called before reading feedback state in async paths.
  </done>
</task>

</tasks>

<verification>
1. Run full test suite: `dart test` -- all tests pass including new scoring/filtering tests
2. `dart analyze` -- no lint errors
3. Verify backward compatibility: existing tests call score() and generate() without new params and still pass
4. Verify liked boost math: +5 liked boost cannot overcome a large runnability/danceability gap (proven by test)
5. Verify hard filter: disliked song keys are never present in generated playlist output (proven by test)
</verification>

<success_criteria>
- SongQualityScorer.score(isLiked: true) returns exactly 5 more than score(isLiked: false) for same song
- PlaylistGenerator.generate(dislikedSongKeys: {...}) produces a playlist with zero songs matching those keys
- PlaylistGenerator.generate(likedSongKeys: {...}) ranks liked songs higher than equivalent unrated songs
- All 3 generation methods in PlaylistGenerationNotifier pass feedback to generator
- All existing tests pass without modification (backward compatible)
</success_criteria>

<output>
After completion, create `.planning/phases/23-feedback-ui-scoring/23-01-SUMMARY.md`
</output>
