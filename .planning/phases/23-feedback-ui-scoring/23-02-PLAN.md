---
phase: 23-feedback-ui-scoring
plan: 02
type: execute
wave: 2
depends_on: [23-01]
files_modified:
  - lib/features/playlist/presentation/widgets/song_tile.dart
autonomous: true

must_haves:
  truths:
    - "User can tap a like or dislike icon on any song in the generated playlist view and see immediate visual confirmation"
    - "Tapping a selected icon again toggles it off (removes feedback)"
  artifacts:
    - path: "lib/features/playlist/presentation/widgets/song_tile.dart"
      provides: "Feedback icons with reactive state display"
      contains: "ConsumerWidget"
  key_links:
    - from: "lib/features/playlist/presentation/widgets/song_tile.dart"
      to: "lib/features/song_feedback/providers/song_feedback_providers.dart"
      via: "ref.watch(songFeedbackProvider) and ref.read(songFeedbackProvider.notifier)"
      pattern: "songFeedbackProvider"
    - from: "lib/features/playlist/presentation/widgets/song_tile.dart"
      to: "lib/features/playlist/domain/playlist.dart"
      via: "song.lookupKey for feedback map lookup"
      pattern: "song.lookupKey"
---

<objective>
Add inline like/dislike icons to the SongTile widget so users can give feedback on any song in the playlist view. Icons show reactive visual state (neutral, liked in green, disliked in red) and toggle on re-tap.

Purpose: Requirement FEED-01 (user can like or dislike any song in the generated playlist view via inline icons) is the primary user-facing feature of Phase 23. This completes the feedback loop: user taps icon -> feedback stored (Phase 22 data layer) -> future playlists adjusted (Plan 01 scoring/filtering).

Output: Updated SongTile as ConsumerWidget with feedback icons working in both PlaylistScreen and PlaylistHistoryDetailScreen.
</objective>

<execution_context>
@/Users/tijmen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tijmen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-feedback-ui-scoring/23-01-SUMMARY.md
@lib/features/playlist/presentation/widgets/song_tile.dart
@lib/features/playlist/domain/playlist.dart
@lib/features/song_feedback/domain/song_feedback.dart
@lib/features/song_feedback/providers/song_feedback_providers.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert SongTile to ConsumerWidget with feedback icons</name>
  <files>
    lib/features/playlist/presentation/widgets/song_tile.dart
  </files>
  <action>
Convert SongTile from StatelessWidget to ConsumerWidget and add inline like/dislike icons.

1. **Change class declaration:**
   - `class SongTile extends ConsumerWidget` (was StatelessWidget)
   - Update `build` signature to `Widget build(BuildContext context, WidgetRef ref)`

2. **Add imports:**
   ```dart
   import 'package:flutter_riverpod/flutter_riverpod.dart';
   import 'package:running_playlist_ai/features/song_feedback/domain/song_feedback.dart';
   import 'package:running_playlist_ai/features/song_feedback/providers/song_feedback_providers.dart';
   ```

3. **Read feedback state in build():**
   At the top of build, after `final theme = ...`:
   ```dart
   final feedbackMap = ref.watch(songFeedbackProvider);
   final feedback = feedbackMap[song.lookupKey];
   // null = no feedback, true = liked, false = disliked
   final isLiked = feedback?.isLiked;
   ```

4. **Add feedback icons to the Row layout:**
   Insert between the Expanded song info column and the BPM chip (before `const SizedBox(width: 8)` that precedes the BPM container). Add:
   ```dart
   // Feedback icons
   SizedBox(
     width: 64,
     child: Row(
       mainAxisSize: MainAxisSize.min,
       children: [
         _feedbackIcon(
           context: context,
           ref: ref,
           icon: isLiked == true ? Icons.thumb_up : Icons.thumb_up_outlined,
           color: isLiked == true ? Colors.green : theme.colorScheme.onSurfaceVariant.withOpacity(0.5),
           tooltip: 'Like',
           onPressed: () => _onToggleLike(ref),
           size: 18,
         ),
         _feedbackIcon(
           context: context,
           ref: ref,
           icon: isLiked == false ? Icons.thumb_down : Icons.thumb_down_outlined,
           color: isLiked == false ? theme.colorScheme.error : theme.colorScheme.onSurfaceVariant.withOpacity(0.5),
           tooltip: 'Dislike',
           onPressed: () => _onToggleDislike(ref),
           size: 18,
         ),
       ],
     ),
   ),
   ```

5. **Add the _feedbackIcon helper method:**
   ```dart
   Widget _feedbackIcon({
     required BuildContext context,
     required WidgetRef ref,
     required IconData icon,
     required Color color,
     required String tooltip,
     required VoidCallback onPressed,
     required double size,
   }) {
     return SizedBox(
       width: 32,
       height: 32,
       child: IconButton(
         padding: EdgeInsets.zero,
         constraints: const BoxConstraints(),
         iconSize: size,
         icon: Icon(icon, color: color),
         tooltip: tooltip,
         onPressed: onPressed,
       ),
     );
   }
   ```

6. **Add toggle handlers:**
   ```dart
   void _onToggleLike(WidgetRef ref) {
     final notifier = ref.read(songFeedbackProvider.notifier);
     final key = song.lookupKey;
     final existing = notifier.getFeedback(key);

     if (existing != null && existing.isLiked) {
       // Already liked -- toggle off
       notifier.removeFeedback(key);
     } else {
       // Set to liked (overrides disliked if present)
       notifier.addFeedback(SongFeedback(
         songKey: key,
         isLiked: true,
         feedbackDate: DateTime.now(),
         songTitle: song.title,
         songArtist: song.artistName,
       ));
     }
   }

   void _onToggleDislike(WidgetRef ref) {
     final notifier = ref.read(songFeedbackProvider.notifier);
     final key = song.lookupKey;
     final existing = notifier.getFeedback(key);

     if (existing != null && !existing.isLiked) {
       // Already disliked -- toggle off
       notifier.removeFeedback(key);
     } else {
       // Set to disliked (overrides liked if present)
       notifier.addFeedback(SongFeedback(
         songKey: key,
         isLiked: false,
         feedbackDate: DateTime.now(),
         songTitle: song.title,
         songArtist: song.artistName,
       ));
     }
   }
   ```

**Layout considerations (Pitfall 2 from research):**
- Use compact 32x32 SizedBox with 18px icons and zero padding to fit within the existing Row.
- Total feedback area: 64px (32px per icon). The existing Row has ~28px track number + 10px gap + expanded text + 8px gap + ~60px BPM chip. Adding 64px + 4px gap before BPM = fits at 320px minimum width.
- Neutral icons use `onSurfaceVariant.withOpacity(0.5)` to be visible but unobtrusive.
- Active like uses `Colors.green`, active dislike uses `theme.colorScheme.error` (red).

**Do NOT:**
- Auto-remove the song from the visible playlist on dislike (research anti-pattern)
- Conflict with the existing Dismissible swipe-to-remove (icons are taps, not swipes)
- Break the existing bottom sheet on tap behavior -- the InkWell onTap for _showPlayOptions stays as-is
  </action>
  <verify>
    `dart analyze lib/features/playlist/presentation/widgets/song_tile.dart` passes with no errors.
    `dart test` passes (no existing tests depend on SongTile being StatelessWidget).
  </verify>
  <done>
    SongTile is a ConsumerWidget that shows thumb_up/thumb_down icons for each song.
    Icons reactively reflect current feedback state (neutral/liked/disliked) via ref.watch(songFeedbackProvider).
    Tapping an active icon toggles it off (removes feedback). Tapping an inactive icon sets the feedback.
    Both PlaylistScreen and PlaylistHistoryDetailScreen get feedback icons automatically (shared SongTile).
    Layout fits on narrow screens without overflow.
  </done>
</task>

</tasks>

<verification>
1. `dart analyze` -- no lint errors across the project
2. `dart test` -- all tests pass
3. Visual check: SongTile shows two small thumb icons between song info and BPM chip
4. Functional check: tapping like turns icon green and filled, tapping again toggles off
5. Functional check: tapping dislike turns icon red and filled, tapping again toggles off
6. Functional check: liking a disliked song switches it to liked (and vice versa)
7. Check both PlaylistScreen and PlaylistHistoryDetailScreen show feedback icons
</verification>

<success_criteria>
- SongTile extends ConsumerWidget (not StatelessWidget)
- Two feedback icons visible on every song tile
- Feedback state persists via songFeedbackProvider (SharedPreferences through Phase 22 data layer)
- Three visual states: neutral (outlined, dim), liked (filled thumb_up, green), disliked (filled thumb_down, red)
- Toggle behavior: tap active icon to remove feedback, tap inactive icon to set feedback
- No layout overflow on 320px-wide screens
- dart analyze and dart test both pass
</success_criteria>

<output>
After completion, create `.planning/phases/23-feedback-ui-scoring/23-02-SUMMARY.md`
</output>
