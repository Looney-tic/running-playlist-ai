---
phase: 24-feedback-library
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/features/song_feedback/presentation/song_feedback_library_screen.dart
  - lib/app/router.dart
  - lib/features/home/presentation/home_screen.dart
autonomous: true

must_haves:
  truths:
    - "User can navigate to a feedback library screen from the home screen"
    - "Feedback library shows all liked songs in one tab and all disliked songs in another tab"
    - "User can flip a liked song to disliked (and vice versa) from the library screen"
    - "User can remove feedback entirely from the library screen"
    - "Changes made in the feedback library take effect in the next playlist generation"
    - "Empty states are shown when there are no liked or disliked songs"
  artifacts:
    - path: "lib/features/song_feedback/presentation/song_feedback_library_screen.dart"
      provides: "Tabbed feedback library screen with liked/disliked views and mutation actions"
      contains: "SongFeedbackLibraryScreen"
    - path: "lib/app/router.dart"
      provides: "Route registration for /song-feedback"
      contains: "/song-feedback"
    - path: "lib/features/home/presentation/home_screen.dart"
      provides: "Navigation button to feedback library"
      contains: "song-feedback"
  key_links:
    - from: "lib/features/song_feedback/presentation/song_feedback_library_screen.dart"
      to: "songFeedbackProvider"
      via: "ref.watch for display, ref.read(.notifier) for mutations"
      pattern: "ref\\.watch\\(songFeedbackProvider\\)"
    - from: "lib/features/home/presentation/home_screen.dart"
      to: "/song-feedback"
      via: "context.push navigation"
      pattern: "context\\.push.*song-feedback"
    - from: "lib/app/router.dart"
      to: "SongFeedbackLibraryScreen"
      via: "GoRoute builder"
      pattern: "SongFeedbackLibraryScreen"
---

<objective>
Build a dedicated feedback library screen where users can browse all liked and disliked songs in separate tabs, flip feedback between like/dislike, or remove feedback entirely. Wire the screen into the router and add home screen navigation.

Purpose: Satisfies FEED-05 (browse all feedback) and FEED-06 (change or remove feedback). Users currently can only see feedback inline on playlist songs -- this gives them a centralized management view.
Output: New SongFeedbackLibraryScreen, updated router, updated home screen navigation.
</objective>

<execution_context>
@/Users/tijmen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tijmen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-feedback-library/24-RESEARCH.md

# Key source files to read before implementing
@lib/features/song_feedback/domain/song_feedback.dart
@lib/features/song_feedback/providers/song_feedback_providers.dart
@lib/app/router.dart
@lib/features/home/presentation/home_screen.dart
@lib/features/playlist/presentation/playlist_history_screen.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SongFeedbackLibraryScreen with tabbed liked/disliked views</name>
  <files>lib/features/song_feedback/presentation/song_feedback_library_screen.dart</files>
  <action>
Create `SongFeedbackLibraryScreen` as a `ConsumerWidget` in `lib/features/song_feedback/presentation/song_feedback_library_screen.dart`.

**Screen structure:**
- Watch `songFeedbackProvider` to get the `Map<String, SongFeedback>` state
- Derive `liked` and `disliked` lists inline in build method by filtering `feedbackMap.values` with `.where((f) => f.isLiked)` / `.where((f) => !f.isLiked)`, then sort by `feedbackDate` descending (newest first)
- If `allFeedback.isEmpty`, show a `Scaffold` with `AppBar(title: Text('Song Feedback'))` and a centered empty state (`_EmptyFeedbackView`) showing `Icons.thumbs_up_down` (size 64), "No Feedback Yet" title, and subtitle "Like or dislike songs in your playlists to build your feedback library." -- follow the empty state pattern from `_EmptyHistoryView` in `playlist_history_screen.dart`
- If feedback exists, wrap with `DefaultTabController(length: 2)` containing a `Scaffold` with:
  - `AppBar` title "Song Feedback", `bottom: TabBar` with tabs `'Liked (${liked.length})'` and `'Disliked (${disliked.length})'`
  - `TabBarView` with two `_FeedbackListView` children (one for liked, one for disliked)

**_FeedbackListView** (private StatelessWidget):
- Takes `List<SongFeedback> items` and `WidgetRef ref` parameters
- If `items.isEmpty`, show centered text: "No liked songs yet" or "No disliked songs yet" (derive from context or pass as parameter). Use a generic "No songs in this category" message, styled with `onSurfaceVariant` color.
- If items exist, render `ListView.builder` with `itemCount: items.length`, using `ValueKey(item.songKey)` on each item for correct widget identity across state changes

**_FeedbackCard** (private StatelessWidget):
- Takes `SongFeedback feedback`, `VoidCallback onFlip`, `VoidCallback onRemove`
- Layout: `Card` with `margin: EdgeInsets.symmetric(horizontal: 12, vertical: 3)`, `elevation: 0`, `borderRadius: 10`, `color: theme.colorScheme.surfaceContainerLow`
- Inside: `Padding(horizontal: 12, vertical: 10)` containing a `Row`:
  1. Leading icon: `Icons.thumb_up` (green, size 20) if liked, `Icons.thumb_down` (theme.colorScheme.error, size 20) if disliked
  2. `SizedBox(width: 12)`
  3. `Expanded` Column (crossAxisAlignment: start):
     - Song title: `Text(feedback.songTitle)` with `titleSmall` style, `maxLines: 1`, `overflow: ellipsis`
     - Artist + date: `Text('${feedback.songArtist} â€¢ ${_formatDate(feedback.feedbackDate)}')` with `bodySmall` style, `onSurfaceVariant` color
  4. Flip button: `IconButton` with `feedback.isLiked ? Icons.thumb_down_outlined : Icons.thumb_up_outlined`, tooltip "Change to dislike"/"Change to like", onPressed: onFlip. Use compact 32x32 `SizedBox` with `padding: EdgeInsets.zero` and 18px icon size (matching decision 23-02).
  5. Remove button: `IconButton` with `Icons.close`, tooltip "Remove feedback", onPressed: onRemove. Same compact sizing.

**Mutation handlers** (top-level or methods on the screen widget):
- `_onFlipFeedback(WidgetRef ref, SongFeedback feedback)`: calls `ref.read(songFeedbackProvider.notifier).addFeedback(feedback.copyWith(isLiked: !feedback.isLiked, feedbackDate: DateTime.now()))`
- `_onRemoveFeedback(WidgetRef ref, SongFeedback feedback)`: calls `ref.read(songFeedbackProvider.notifier).removeFeedback(feedback.songKey)`

**Date formatting helper:**
- `_formatDate(DateTime date)`: return `'${date.day.toString().padLeft(2, '0')}/${date.month.toString().padLeft(2, '0')}/${date.year}'` (dd/MM/yyyy format, consistent with codebase)

**Important anti-patterns to avoid:**
- Do NOT create separate providers for liked/disliked lists -- derive inline from watched state
- Do NOT use `Dismissible` for remove -- use explicit IconButton for consistency with existing library screens
- Do NOT use `withOpacity()` -- use `withValues(alpha:)` per decision 23-02
- Use `Icons.thumbs_up_down` (NOT `Icons.thumb_up_down`) -- verify the correct icon name exists in material icons; fall back to `Icons.rate_review` if not available
  </action>
  <verify>
Run `dart analyze lib/features/song_feedback/presentation/song_feedback_library_screen.dart` -- must report 0 issues.
Verify file exists and contains: SongFeedbackLibraryScreen class, DefaultTabController, TabBar, TabBarView, _FeedbackCard, songFeedbackProvider references, addFeedback, removeFeedback.
  </verify>
  <done>
SongFeedbackLibraryScreen file exists with: tabbed liked/disliked views derived from songFeedbackProvider, feedback cards showing song title + artist + date, flip and remove action buttons using existing notifier methods, empty states for no-feedback and empty-tab cases. Passes dart analyze.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire router route and home screen navigation button</name>
  <files>lib/app/router.dart, lib/features/home/presentation/home_screen.dart</files>
  <action>
**Router (lib/app/router.dart):**
1. Add import: `import 'package:running_playlist_ai/features/song_feedback/presentation/song_feedback_library_screen.dart';`
2. Add a new `GoRoute` in the `routes` list (after the `/playlist-history` route):
```dart
GoRoute(
  path: '/song-feedback',
  builder: (context, state) => const SongFeedbackLibraryScreen(),
),
```

**Home screen (lib/features/home/presentation/home_screen.dart):**
Add a "Song Feedback" navigation button after the "Playlist History" button (the last navigation button in the current list). Follow the exact same pattern:
```dart
const SizedBox(height: 16),
ElevatedButton.icon(
  onPressed: () => context.push('/song-feedback'),
  icon: const Icon(Icons.thumb_up_alt_outlined),
  label: const Text('Song Feedback'),
),
```
Place it after the existing `'Playlist History'` button's `SizedBox(height: 16)` + `ElevatedButton.icon` block, maintaining the same spacing pattern.
  </action>
  <verify>
Run `dart analyze lib/app/router.dart lib/features/home/presentation/home_screen.dart` -- must report 0 issues.
Verify router.dart contains `/song-feedback` route pointing to SongFeedbackLibraryScreen.
Verify home_screen.dart contains a "Song Feedback" button with `context.push('/song-feedback')`.
  </verify>
  <done>
Router has /song-feedback route pointing to SongFeedbackLibraryScreen. Home screen has a "Song Feedback" ElevatedButton.icon that navigates to /song-feedback. Both files pass dart analyze.
  </done>
</task>

</tasks>

<verification>
1. `dart analyze` on all 3 modified/created files reports 0 issues
2. `flutter test` -- all existing tests pass (except pre-existing failures in widget_test.dart and 2 playlist error message tests)
3. Manual check: grep for `songFeedbackProvider` in the new screen file -- must appear (proves wired to existing state)
4. Manual check: grep for `addFeedback` and `removeFeedback` in the new screen file -- must appear (proves mutation actions use existing notifier)
5. Manual check: grep for `/song-feedback` in router.dart and home_screen.dart -- must appear in both
</verification>

<success_criteria>
- SongFeedbackLibraryScreen shows liked and disliked songs in separate tabs with counts in tab labels
- Each feedback entry displays song title, artist, date, and has flip + remove action buttons
- Empty states shown for no feedback at all and for empty individual tabs
- Navigation from home screen to feedback library works via /song-feedback route
- All mutations use existing songFeedbackProvider.notifier (addFeedback for flip, removeFeedback for remove) -- no new data layer code
- Changes propagate to next playlist generation because the same songFeedbackProvider is the single source of truth
</success_criteria>

<output>
After completion, create `.planning/phases/24-feedback-library/24-01-SUMMARY.md`
</output>
