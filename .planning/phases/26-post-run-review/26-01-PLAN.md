---
phase: 26-post-run-review
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/features/post_run_review/data/post_run_review_preferences.dart
  - lib/features/post_run_review/providers/post_run_review_providers.dart
  - lib/features/post_run_review/presentation/post_run_review_screen.dart
  - lib/features/home/presentation/home_screen.dart
  - lib/app/router.dart

autonomous: true

must_haves:
  truths:
    - "When an unreviewed recent playlist exists, the home screen shows a review prompt card"
    - "Tapping the review prompt navigates to a dedicated review screen listing all songs from the most recent playlist"
    - "User can like or dislike each song using the same SongTile feedback buttons used elsewhere"
    - "Tapping Done or Skip marks the playlist as reviewed and returns to the home screen"
    - "The review prompt disappears after the user completes or dismisses the review"
    - "Feedback given during review persists and affects future playlist generation (shared songFeedbackProvider)"
  artifacts:
    - path: "lib/features/post_run_review/data/post_run_review_preferences.dart"
      provides: "SharedPreferences persistence for last-reviewed playlist ID"
      contains: "PostRunReviewPreferences"
    - path: "lib/features/post_run_review/providers/post_run_review_providers.dart"
      provides: "StateNotifier tracking reviewed status + derived unreviewedPlaylistProvider"
      exports: ["postRunReviewProvider", "unreviewedPlaylistProvider"]
    - path: "lib/features/post_run_review/presentation/post_run_review_screen.dart"
      provides: "Review screen with song list and Done/Skip actions"
      contains: "PostRunReviewScreen"
  key_links:
    - from: "lib/features/post_run_review/providers/post_run_review_providers.dart"
      to: "playlistHistoryProvider"
      via: "ref.watch in unreviewedPlaylistProvider"
      pattern: "ref\\.watch\\(playlistHistoryProvider\\)"
    - from: "lib/features/post_run_review/presentation/post_run_review_screen.dart"
      to: "SongTile"
      via: "reuse of existing feedback widget"
      pattern: "SongTile\\("
    - from: "lib/features/home/presentation/home_screen.dart"
      to: "unreviewedPlaylistProvider"
      via: "ref.watch to show/hide review prompt card"
      pattern: "ref\\.watch\\(unreviewedPlaylistProvider\\)"
---

<objective>
Add a post-run review flow: a home screen prompt card that appears when an unreviewed playlist exists, leading to a dedicated review screen where the user can like/dislike all songs from their most recent playlist.

Purpose: Let users rate songs in a focused review context after a run, improving feedback coverage and future playlist quality.
Output: PostRunReviewPreferences, PostRunReviewNotifier, unreviewedPlaylistProvider, PostRunReviewScreen, home screen review card, /post-run-review route.
</objective>

<execution_context>
@/Users/tijmen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tijmen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/features/home/presentation/home_screen.dart
@lib/features/playlist/providers/playlist_history_providers.dart
@lib/features/playlist/domain/playlist.dart
@lib/features/playlist/presentation/widgets/song_tile.dart
@lib/features/playlist/presentation/widgets/segment_header.dart
@lib/features/playlist/presentation/playlist_history_detail_screen.dart
@lib/features/onboarding/data/onboarding_preferences.dart
@lib/features/song_feedback/providers/song_feedback_providers.dart
@lib/app/router.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create review state persistence and providers</name>
  <files>
    lib/features/post_run_review/data/post_run_review_preferences.dart
    lib/features/post_run_review/providers/post_run_review_providers.dart
  </files>
  <action>
Create `PostRunReviewPreferences` following the `OnboardingPreferences` pattern (static class, single SharedPreferences key):
- Key: `'last_reviewed_playlist_id'` (String?)
- Methods: `loadLastReviewedId()` -> Future<String?>, `saveLastReviewedId(String)` -> Future<void>, `clear()` -> Future<void>

Create `PostRunReviewNotifier` extending `StateNotifier<String?>` following the `SongFeedbackNotifier` pattern:
- Constructor calls `_load()` to read from preferences
- Uses `Completer<void>` + `ensureLoaded()` pattern (from `playlist_freshness_providers.dart`)
- `markReviewed(String playlistId)` sets state and persists
- Check `mounted` before setting state in `_load()`

Create `postRunReviewProvider` as `StateNotifierProvider<PostRunReviewNotifier, String?>`.

Create `unreviewedPlaylistProvider` as `Provider<Playlist?>`:
- Watch `playlistHistoryProvider` to get playlists (newest first)
- Watch `postRunReviewProvider` to get last-reviewed ID
- Return null if: playlists empty, most recent has null ID, most recent ID matches last-reviewed ID
- Otherwise return the most recent playlist

Import `dart:async` for Completer. Import playlist_history_providers and post_run_review_preferences.
  </action>
  <verify>
Run `dart analyze lib/features/post_run_review/` -- no errors.
  </verify>
  <done>
PostRunReviewPreferences persists a single string key. PostRunReviewNotifier loads and updates reviewed state. unreviewedPlaylistProvider returns the most recent unreviewed playlist or null.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create review screen, home prompt card, and router registration</name>
  <files>
    lib/features/post_run_review/presentation/post_run_review_screen.dart
    lib/features/home/presentation/home_screen.dart
    lib/app/router.dart
  </files>
  <action>
**PostRunReviewScreen** (`ConsumerWidget`):
- Watch `unreviewedPlaylistProvider`. If null, use `addPostFrameCallback` to pop back (guard with `context.mounted`). Return `Scaffold(body: SizedBox.shrink())` as fallback.
- AppBar title: `'Rate Your Playlist'`. AppBar action: `TextButton` with "Skip" that calls `_dismiss`.
- Body: `Column` with:
  1. Padding(16) header text: `'How did these songs feel during your run?'` using `bodyLarge` style
  2. Expanded `ListView.builder` over `playlist.songs` with segment headers (follow `PlaylistHistoryDetailScreen` pattern: compare `segmentLabel` with previous song, show `SegmentHeader` when different) and `SongTile(song: song)` (no index parameter -- track numbers are not needed in review context)
  3. `SafeArea` bottom with Padding(16) containing `FilledButton.icon` with `Icons.check` icon and "Done" label, calling `_dismiss`
- `_dismiss` method: call `context.pop()` FIRST, then call `ref.read(postRunReviewProvider.notifier).markReviewed(playlist.id!)` -- pop before state change to avoid the reactive rebuild pitfall (Pitfall 2 from research). Guard with `playlist.id != null`.

**HomeScreen modification:**
- Add import for `post_run_review_providers.dart`
- In `build()`, add `final unreviewedPlaylist = ref.watch(unreviewedPlaylistProvider);`
- After the `if (!hasPlan) _SetupCard(...)` block and before the `if (hasPlan) ...[` block, insert:
  ```
  if (unreviewedPlaylist != null)
    _SetupCard(
      icon: Icons.rate_review,
      title: 'Rate your last playlist',
      subtitle: '${unreviewedPlaylist.songs.length} songs from '
          '${unreviewedPlaylist.runPlanName ?? "your run"}',
      color: theme.colorScheme.tertiaryContainer,
      onTap: () => context.push('/post-run-review'),
    ),
  ```

**Router modification:**
- Add import for `PostRunReviewScreen`
- Add route entry before the `/playlist-history` route:
  ```
  GoRoute(
    path: '/post-run-review',
    builder: (context, state) => const PostRunReviewScreen(),
  ),
  ```
  </action>
  <verify>
Run `dart analyze lib/features/post_run_review/ lib/features/home/ lib/app/router.dart` -- no errors.
Run `flutter test` -- existing tests still pass (pre-existing failures excluded).
  </verify>
  <done>
PostRunReviewScreen displays all songs from the most recent playlist with segment headers and SongTile feedback buttons. Home screen shows a review prompt card when an unreviewed playlist exists. The /post-run-review route is registered in the router. Tapping Done or Skip marks the playlist as reviewed and returns to home.
  </done>
</task>

</tasks>

<verification>
1. `dart analyze lib/` -- no new analysis errors
2. `flutter test` -- no new test failures (pre-existing failures acceptable)
3. Manual verification checklist:
   - Generate a playlist, navigate home -- review prompt card appears
   - Tap review prompt -- navigates to review screen showing all songs with segment headers
   - Like/dislike a song -- feedback icon updates (uses shared songFeedbackProvider)
   - Tap Done -- returns to home, review prompt disappears
   - Navigate to Song Feedback library -- feedback from review is visible
   - Generate a new playlist -- review prompt reappears for the new playlist
   - Tap Skip on review screen -- returns to home, review prompt disappears
</verification>

<success_criteria>
- Home screen conditionally shows a review prompt card when unreviewedPlaylistProvider returns non-null
- /post-run-review route leads to PostRunReviewScreen
- PostRunReviewScreen lists songs with segment headers and SongTile (reusing existing feedback widget)
- Done and Skip both mark the playlist as reviewed via PostRunReviewNotifier and navigate back
- Review state persists across app restarts via SharedPreferences
- All feedback flows through the shared songFeedbackProvider (no separate mechanism)
</success_criteria>

<output>
After completion, create `.planning/phases/26-post-run-review/26-01-SUMMARY.md`
</output>
