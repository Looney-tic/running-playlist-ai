---
phase: 28-songs-i-run-to-data-layer
plan: 02
type: execute
wave: 2
depends_on: [28-01]
files_modified:
  - lib/features/running_songs/presentation/running_songs_screen.dart
  - lib/features/playlist/presentation/widgets/song_tile.dart
  - lib/app/router.dart
  - lib/features/home/presentation/home_screen.dart
autonomous: true

must_haves:
  truths:
    - "User can view all songs in their 'Songs I Run To' list sorted by most recently added"
    - "User can remove a song from the list and it disappears immediately"
    - "When the list is empty, user sees an icon, heading, and guidance text on how to add songs"
    - "User can add a song to 'Songs I Run To' from the SongTile play options bottom sheet"
    - "User can navigate to the running songs screen from the home screen"
  artifacts:
    - path: "lib/features/running_songs/presentation/running_songs_screen.dart"
      provides: "List view with song cards, remove action, and empty state"
      contains: "class RunningSongsScreen"
    - path: "lib/features/playlist/presentation/widgets/song_tile.dart"
      provides: "'Add to Songs I Run To' action in play options bottom sheet"
      contains: "Songs I Run To"
    - path: "lib/app/router.dart"
      provides: "GoRoute for /running-songs"
      contains: "/running-songs"
    - path: "lib/features/home/presentation/home_screen.dart"
      provides: "Navigation button for Songs I Run To"
      contains: "/running-songs"
  key_links:
    - from: "lib/features/running_songs/presentation/running_songs_screen.dart"
      to: "lib/features/running_songs/providers/running_song_providers.dart"
      via: "ref.watch(runningSongProvider) for reactive list display"
      pattern: "runningSongProvider"
    - from: "lib/features/playlist/presentation/widgets/song_tile.dart"
      to: "lib/features/running_songs/providers/running_song_providers.dart"
      via: "ref.read(runningSongProvider.notifier).addSong() from bottom sheet"
      pattern: "runningSongProvider\\.notifier"
    - from: "lib/app/router.dart"
      to: "lib/features/running_songs/presentation/running_songs_screen.dart"
      via: "GoRoute builder imports and instantiates RunningSongsScreen"
      pattern: "RunningSongsScreen"
    - from: "lib/features/home/presentation/home_screen.dart"
      to: "lib/app/router.dart"
      via: "context.push('/running-songs')"
      pattern: "context\\.push\\('/running-songs'\\)"
---

<objective>
Create the RunningSongsScreen with list view and empty state, add "Add to Songs I Run To" action to SongTile's play options bottom sheet, register the route, and add home screen navigation.

Purpose: Completes the user-facing feature for Phase 28. Users can add songs from generated playlists, view their collection, and remove songs -- satisfying all four success criteria.

Output: RunningSongsScreen, updated SongTile with add action, /running-songs route, home screen button.
</objective>

<execution_context>
@/Users/tijmen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tijmen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-songs-i-run-to-data-layer/28-RESEARCH.md
@.planning/phases/28-songs-i-run-to-data-layer/28-01-SUMMARY.md

@lib/features/running_songs/domain/running_song.dart
@lib/features/running_songs/providers/running_song_providers.dart
@lib/features/song_feedback/presentation/song_feedback_library_screen.dart
@lib/features/playlist/presentation/widgets/song_tile.dart
@lib/app/router.dart
@lib/features/home/presentation/home_screen.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: RunningSongsScreen with list view, remove action, and empty state</name>
  <files>lib/features/running_songs/presentation/running_songs_screen.dart</files>
  <action>
Create `lib/features/running_songs/presentation/running_songs_screen.dart`:

Follow the `SongFeedbackLibraryScreen` pattern closely.

**RunningSongsScreen (ConsumerWidget):**
- AppBar title: "Songs I Run To"
- Watch `runningSongProvider` for reactive updates
- If map is empty, show `_EmptyRunningSongsView` (full screen empty state)
- If map has entries:
  - Sort songs by `addedDate` descending (most recently added first)
  - Display in a `ListView.builder` with `_RunningSongCard` widgets

**_EmptyRunningSongsView (StatelessWidget):**
- Centered column with:
  - `Icon(Icons.favorite_border, size: 64, color: Colors.grey)` (heart outline for "songs I love")
  - SizedBox(height: 16)
  - Text: "No Running Songs Yet" (fontSize: 20, fontWeight: bold)
  - SizedBox(height: 8)
  - Text: "Add songs from your generated playlists to build your personal running music collection." (fontSize: 16, color: grey, textAlign: center)
  - Padding: EdgeInsets.all(24)

**_RunningSongCard (StatelessWidget):**
- Follow `_FeedbackCard` visual style from SongFeedbackLibraryScreen:
  - Card with surfaceContainerLow background, rounded corners (10), zero elevation
  - Horizontal layout: icon | song info | remove button
  - Leading icon: `Icons.music_note` in primary color (not feedback thumbs)
  - Song info: title (titleSmall, 1 line ellipsis), subtitle showing "artist . formatted date"
  - Trailing: remove IconButton with `Icons.close`, tooltip "Remove from Songs I Run To"
  - On remove: call `ref.read(runningSongProvider.notifier).removeSong(song.songKey)`
  - Include source badge if source is not curated: small text label like "Spotify" in onSurfaceVariant (future-proofing, currently all songs will be curated)

Include a `_formatDate(DateTime)` helper matching the dd/MM/yyyy pattern used in SongFeedbackLibraryScreen.

Accept `ref` parameter in the card for remove action (same pattern as `_FeedbackListView`).
  </action>
  <verify>Run `dart analyze lib/features/running_songs/presentation/running_songs_screen.dart` with zero errors.</verify>
  <done>RunningSongsScreen renders a sorted list of running songs with remove buttons, or an empty state with icon/heading/guidance text when no songs exist.</done>
</task>

<task type="auto">
  <name>Task 2: Add-to-running-songs action in SongTile and route/navigation wiring</name>
  <files>
    lib/features/playlist/presentation/widgets/song_tile.dart
    lib/app/router.dart
    lib/features/home/presentation/home_screen.dart
  </files>
  <action>
**Update SongTile bottom sheet** (`lib/features/playlist/presentation/widgets/song_tile.dart`):

Add a new import for `running_song_providers.dart` and `running_song.dart`.

In `_showPlayOptions`, add a new `ListTile` action BEFORE the Spotify/YouTube options:
- Icon: `Icons.favorite_border` (or `Icons.favorite` if already added)
- Read `runningSongProvider` to check if song is already in the list via `containsSong(song.lookupKey)`
- If NOT in list:
  - Title: "Add to Songs I Run To"
  - Icon: `Icons.favorite_border`
  - OnTap:
    1. `Navigator.pop(context)` (close bottom sheet)
    2. Create `RunningSong` with:
       - `songKey: song.lookupKey` (already normalized via SongKey)
       - `artist: song.artistName`
       - `title: song.title`
       - `addedDate: DateTime.now()`
       - `bpm: song.bpm`
       - `source: RunningSongSource.curated` (all songs from playlist generation are from curated/API data)
    3. `ref.read(runningSongProvider.notifier).addSong(runningSong)`
    4. Show a SnackBar: "Added to Songs I Run To"
- If ALREADY in list:
  - Title: "Remove from Songs I Run To"
  - Icon: `Icons.favorite` (filled)
  - OnTap:
    1. `Navigator.pop(context)`
    2. `ref.read(runningSongProvider.notifier).removeSong(song.lookupKey)`
    3. Show a SnackBar: "Removed from Songs I Run To"

IMPORTANT: The bottom sheet's `builder` closure does NOT have access to `ref` from ConsumerWidget. The `_showPlayOptions` method is an instance method on `SongTile` which IS a ConsumerWidget, but the bottom sheet runs in a different build context. You need to capture `ref` BEFORE calling `showModalBottomSheet` and pass it into the builder closure. Read the current `_showPlayOptions` to see how it works -- it already uses `context` from the outer scope. Add a `WidgetRef ref` parameter to `_showPlayOptions` and call it as `_showPlayOptions(context, ref)`.

**Register route** (`lib/app/router.dart`):

1. Add import for `RunningSongsScreen`
2. Add GoRoute:
   ```dart
   GoRoute(
     path: '/running-songs',
     builder: (context, state) => const RunningSongsScreen(),
   ),
   ```
   Place it near the `/song-feedback` route for logical grouping.

**Add home screen button** (`lib/features/home/presentation/home_screen.dart`):

Add a new `ElevatedButton.icon` in the navigation buttons section, between "Song Feedback" and the end of the list (or after "Playlist History" and before "Song Feedback"):
```dart
ElevatedButton.icon(
  onPressed: () => context.push('/running-songs'),
  icon: const Icon(Icons.favorite),
  label: const Text('Songs I Run To'),
),
const SizedBox(height: 16),
```

Place it logically after "Song Feedback" since it's a closely related concept (both are song-curation features).
  </action>
  <verify>
1. `dart analyze lib/features/playlist/presentation/widgets/song_tile.dart lib/app/router.dart lib/features/home/presentation/home_screen.dart` -- zero errors
2. `flutter test` -- no regressions (pre-existing failures excepted)
  </verify>
  <done>SongTile play options bottom sheet includes "Add to Songs I Run To" (or "Remove from Songs I Run To" if already added) with SnackBar confirmation. Route /running-songs registered in GoRouter. Home screen has "Songs I Run To" navigation button.</done>
</task>

</tasks>

<verification>
1. `dart analyze lib/features/running_songs/` -- zero errors on all new files
2. `dart analyze lib/features/playlist/presentation/widgets/song_tile.dart lib/app/router.dart lib/features/home/presentation/home_screen.dart` -- zero errors on modified files
3. `flutter test` -- no regressions (pre-existing failures excepted: widget_test.dart, 2 playlist error message tests)
4. Manual check: home screen shows "Songs I Run To" button
5. Manual check: /running-songs route renders empty state when no songs added
6. Manual check: SongTile bottom sheet shows "Add to Songs I Run To" option
</verification>

<success_criteria>
- Navigating to /running-songs shows RunningSongsScreen
- Empty state displays icon, "No Running Songs Yet" heading, and guidance text
- After adding a song via SongTile bottom sheet, the song appears in /running-songs
- Removing a song via the close button on RunningSongsScreen makes it disappear immediately
- After removing, the "Add to Songs I Run To" option reappears in SongTile bottom sheet
- SnackBar confirmation appears on add and remove from bottom sheet
- Home screen has a "Songs I Run To" navigation button that navigates to /running-songs
</success_criteria>

<output>
After completion, create `.planning/phases/28-songs-i-run-to-data-layer/28-02-SUMMARY.md`
</output>
