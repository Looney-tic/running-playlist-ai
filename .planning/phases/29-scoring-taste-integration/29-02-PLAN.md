---
phase: 29-scoring-taste-integration
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/features/running_songs/domain/bpm_compatibility.dart
  - test/features/running_songs/domain/bpm_compatibility_test.dart
  - lib/features/running_songs/presentation/running_songs_screen.dart
autonomous: true

must_haves:
  truths:
    - "Each running song with a known BPM shows a green, amber, or gray indicator relative to the user's current cadence"
    - "Running songs without BPM data show no indicator at all"
    - "Green means exact, half, or double-time match; amber means within 5%; gray means no match"
  artifacts:
    - path: "lib/features/running_songs/domain/bpm_compatibility.dart"
      provides: "Pure BPM compatibility function"
      exports: ["BpmCompatibility", "bpmCompatibility"]
    - path: "test/features/running_songs/domain/bpm_compatibility_test.dart"
      provides: "Unit tests for BPM compatibility logic"
      contains: "bpmCompatibility"
    - path: "lib/features/running_songs/presentation/running_songs_screen.dart"
      provides: "BPM compatibility chip on running song cards"
      contains: "BpmCompatibility"
  key_links:
    - from: "lib/features/running_songs/presentation/running_songs_screen.dart"
      to: "lib/features/running_songs/domain/bpm_compatibility.dart"
      via: "import and call bpmCompatibility()"
      pattern: "bpmCompatibility\\("
    - from: "lib/features/running_songs/presentation/running_songs_screen.dart"
      to: "strideNotifierProvider"
      via: "ref.watch for current cadence"
      pattern: "ref\\.watch\\(strideNotifierProvider\\)"
---

<objective>
Create a BPM compatibility indicator on running song cards that shows green/amber/gray relative to the user's cadence, using TDD for the pure computation function.

Purpose: Users need visual feedback on how well each saved song matches their running cadence so they can curate their collection effectively.
Output: New bpm_compatibility.dart with TDD tests, updated running_songs_screen.dart with colored BPM chips.
</objective>

<execution_context>
@/Users/tijmen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tijmen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-scoring-taste-integration/29-RESEARCH.md

@lib/features/running_songs/presentation/running_songs_screen.dart
@lib/features/running_songs/domain/running_song.dart
@lib/features/stride/providers/stride_providers.dart
</context>

<feature>
  <name>BPM Compatibility Indicator</name>
  <files>
    lib/features/running_songs/domain/bpm_compatibility.dart
    test/features/running_songs/domain/bpm_compatibility_test.dart
    lib/features/running_songs/presentation/running_songs_screen.dart
  </files>
  <behavior>
    Pure function `bpmCompatibility({required int? songBpm, required int cadence})` returns `BpmCompatibility` enum:

    - `match` (green): songBpm equals cadence, cadence~/2, or cadence*2 exactly
    - `close` (amber): songBpm within ceil(target * 0.05) of cadence, cadence~/2, or cadence*2
    - `none` (gray): songBpm outside range
    - `none`: songBpm is null (but UI hides indicator entirely for null BPM)

    Test cases:
    - `bpmCompatibility(songBpm: 170, cadence: 170)` -> match (exact)
    - `bpmCompatibility(songBpm: 85, cadence: 170)` -> match (half-time)
    - `bpmCompatibility(songBpm: 340, cadence: 170)` -> match (double-time)
    - `bpmCompatibility(songBpm: 172, cadence: 170)` -> close (within 5% of 170 = 9 BPM tolerance)
    - `bpmCompatibility(songBpm: 88, cadence: 170)` -> close (within 5% of 85 = 5 BPM tolerance)
    - `bpmCompatibility(songBpm: 120, cadence: 170)` -> none (no match)
    - `bpmCompatibility(songBpm: null, cadence: 170)` -> none (null BPM)
    - `bpmCompatibility(songBpm: 160, cadence: 160)` -> match (exact, different cadence)
    - `bpmCompatibility(songBpm: 162, cadence: 160)` -> close (within 5% of 160 = 8 BPM tolerance)
    - `bpmCompatibility(songBpm: 180, cadence: 170)` -> close (within 5% of 170 = 9 BPM tolerance)
    - `bpmCompatibility(songBpm: 179, cadence: 170)` -> close (9 away, tolerance is ceil(170*0.05)=9)
    - `bpmCompatibility(songBpm: 150, cadence: 170)` -> none (20 away from 170, too far)
  </behavior>
  <implementation>
    **RED phase:**
    1. Create `lib/features/running_songs/domain/bpm_compatibility.dart` with the `BpmCompatibility` enum and a stub `bpmCompatibility()` function that always returns `BpmCompatibility.none`.
    2. Create `test/features/running_songs/domain/bpm_compatibility_test.dart` with all test cases above.
    3. Run tests -- most should FAIL (only null/none cases pass).

    **GREEN phase:**
    4. Implement the full `bpmCompatibility()` function:
       - Return `none` if songBpm is null.
       - Compute targets: `[cadence, cadence ~/ 2, cadence * 2]`.
       - First pass: check exact match against each target -> return `match`.
       - Second pass: check within `ceil(target * 0.05)` of each target -> return `close`.
       - Otherwise: return `none`.
    5. Run tests -- all should PASS.

    **UI integration (after GREEN):**
    6. Modify `running_songs_screen.dart`:
       - Add imports for `bpm_compatibility.dart` and `stride_providers.dart`.
       - In `RunningSongsScreen.build()`, read the current cadence: `final cadence = ref.watch(strideNotifierProvider).cadence.round();`
       - Pass `cadence` as an `int` parameter to `_RunningSongCard` (keep card decoupled from stride provider).
       - Update `_RunningSongCard` constructor to accept `int cadence`.
       - In `_RunningSongCard.build()`, if `song.bpm != null`, compute compatibility and render a colored chip:
         - `BpmCompatibility.match` -> green chip showing BPM value
         - `BpmCompatibility.close` -> amber chip showing BPM value
         - `BpmCompatibility.none` -> gray chip showing BPM value
         - If `song.bpm == null` -> hide the chip entirely (no indicator)
       - Chip style: Container with colored background at 15% opacity, 8px horizontal / 4px vertical padding, border radius 8, containing a Row with a small colored dot icon (14px) and BPM text (13px, semibold).
       - Place the chip between the text content and the close button, with 8px spacing.
  </implementation>
</feature>

<verification>
1. `flutter test test/features/running_songs/domain/bpm_compatibility_test.dart` -- all tests pass
2. `dart analyze lib/features/running_songs/domain/ lib/features/running_songs/presentation/` -- zero errors
3. `flutter test` -- no regressions
4. Code review: songs with null BPM show no indicator chip
5. Code review: chip colors are green (match), amber (close), gray (none)
6. Code review: cadence is passed as int parameter to card, not read from provider inside card
</verification>

<success_criteria>
- `bpmCompatibility()` pure function correctly classifies exact, half-time, double-time, close, and no-match BPMs
- All TDD test cases pass (12+ cases covering match, close, none, null)
- Running song cards show colored BPM chip when BPM is known
- Running song cards hide BPM chip when BPM is null
- Cadence is read once in the screen and passed down to cards (decoupled)
</success_criteria>

<output>
After completion, create `.planning/phases/29-scoring-taste-integration/29-02-SUMMARY.md`
</output>
