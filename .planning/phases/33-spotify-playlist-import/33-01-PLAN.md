---
phase: 33-spotify-playlist-import
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/features/spotify_import/domain/spotify_playlist_service.dart
  - lib/features/spotify_import/data/mock_spotify_playlist_service.dart
  - lib/features/spotify_import/data/real_spotify_playlist_service.dart
  - lib/features/spotify_import/providers/spotify_import_providers.dart
  - lib/features/running_songs/providers/running_song_providers.dart
  - lib/core/constants/spotify_constants.dart
  - test/features/spotify_import/domain/spotify_playlist_service_test.dart
autonomous: true

must_haves:
  truths:
    - "SpotifyPlaylistService abstract interface defines getUserPlaylists() and getPlaylistTracks(playlistId)"
    - "MockSpotifyPlaylistService returns realistic mock data with multiple playlists and varied tracks"
    - "RunningSongNotifier.addSongs() batch method updates state once and persists once"
    - "OAuth scopes include playlist-read-private and playlist-read-collaborative"
  artifacts:
    - path: "lib/features/spotify_import/domain/spotify_playlist_service.dart"
      provides: "SpotifyPlaylistInfo, SpotifyPlaylistTrack data classes and SpotifyPlaylistService abstract interface"
      contains: "abstract class SpotifyPlaylistService"
    - path: "lib/features/spotify_import/data/mock_spotify_playlist_service.dart"
      provides: "Mock implementation with hardcoded playlists and tracks"
      contains: "class MockSpotifyPlaylistService"
    - path: "lib/features/spotify_import/data/real_spotify_playlist_service.dart"
      provides: "Real Spotify API implementation using spotify 0.15.0 package"
      contains: "class RealSpotifyPlaylistService"
    - path: "lib/features/spotify_import/providers/spotify_import_providers.dart"
      provides: "Riverpod provider for SpotifyPlaylistService"
      contains: "spotifyPlaylistServiceProvider"
    - path: "lib/core/constants/spotify_constants.dart"
      provides: "Updated OAuth scopes with playlist-read-private"
      contains: "playlist-read-private"
    - path: "test/features/spotify_import/domain/spotify_playlist_service_test.dart"
      provides: "Unit tests for mock service and batch import"
  key_links:
    - from: "lib/features/spotify_import/providers/spotify_import_providers.dart"
      to: "lib/features/spotify_auth/providers/spotify_auth_providers.dart"
      via: "reads spotifyConnectionStatusSyncProvider to return mock or real service"
      pattern: "spotifyConnectionStatusSyncProvider"
    - from: "lib/features/running_songs/providers/running_song_providers.dart"
      to: "lib/features/running_songs/data/running_song_preferences.dart"
      via: "addSongs batch method persists once"
      pattern: "addSongs"
---

<objective>
Create the SpotifyPlaylistService domain layer with abstract interface, mock implementation, real Spotify API implementation, Riverpod providers, batch import on RunningSongNotifier, and OAuth scope update.

Purpose: Provides the data foundation for Plan 02's UI screens. Follows the established mock-first pattern (SpotifyAuthService, SongSearchService) so development works without Spotify credentials.

Output: Domain types, mock/real service implementations, provider, batch addSongs method, updated scopes, and tests.
</objective>

<execution_context>
@/Users/tijmen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tijmen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-spotify-playlist-import/33-RESEARCH.md

@lib/features/song_search/domain/song_search_service.dart
@lib/features/spotify_auth/domain/spotify_auth_service.dart
@lib/features/spotify_auth/providers/spotify_auth_providers.dart
@lib/features/running_songs/domain/running_song.dart
@lib/features/running_songs/providers/running_song_providers.dart
@lib/features/running_songs/data/running_song_preferences.dart
@lib/features/song_search/data/mock_spotify_search_service.dart
@lib/core/constants/spotify_constants.dart
@lib/features/song_feedback/domain/song_feedback.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: SpotifyPlaylistService interface, data classes, mock, real implementation, and provider</name>
  <files>
    lib/features/spotify_import/domain/spotify_playlist_service.dart
    lib/features/spotify_import/data/mock_spotify_playlist_service.dart
    lib/features/spotify_import/data/real_spotify_playlist_service.dart
    lib/features/spotify_import/providers/spotify_import_providers.dart
    lib/core/constants/spotify_constants.dart
    test/features/spotify_import/domain/spotify_playlist_service_test.dart
  </files>
  <action>
    **1. Domain layer** (`spotify_playlist_service.dart`):
    - Create `SpotifyPlaylistInfo` immutable data class with fields: `id` (String), `name` (String), `description` (String?), `imageUrl` (String?), `trackCount` (int?), `ownerName` (String?). Use `const` constructor.
    - Create `SpotifyPlaylistTrack` immutable data class with fields: `title` (String), `artist` (String), `spotifyUri` (String?), `durationMs` (int?), `albumName` (String?), `imageUrl` (String?). Use `const` constructor.
    - Create `abstract class SpotifyPlaylistService` (NOT `abstract interface class` -- matching SongSearchService pattern) with two methods:
      - `Future<List<SpotifyPlaylistInfo>> getUserPlaylists()`
      - `Future<List<SpotifyPlaylistTrack>> getPlaylistTracks(String playlistId)`

    **2. Mock implementation** (`mock_spotify_playlist_service.dart`):
    - Create `MockSpotifyPlaylistService implements SpotifyPlaylistService`.
    - `getUserPlaylists()`: return 5 hardcoded playlists after 300ms delay. Include variety: "Running Hits" (25 tracks), "Morning Run" (15 tracks), "Discover Weekly" (30 tracks, owner "Spotify"), "Workout Mix" (40 tracks), "Chill Run" (12 tracks).
    - `getPlaylistTracks(playlistId)`: return different track lists per playlist ID after 300ms delay. Use a static `Map<String, List<SpotifyPlaylistTrack>>` for per-playlist data. Include 8-12 tracks per playlist with realistic artist/title combos. Include at least 3 songs that overlap with the curated catalog (e.g., "Lose Yourself" by "Eminem", "Blinding Lights" by "The Weeknd") for dedup testing in Plan 02. Give all tracks mock `spotifyUri` values.

    **3. Real implementation** (`real_spotify_playlist_service.dart`):
    - Create `RealSpotifyPlaylistService implements SpotifyPlaylistService` taking a `SpotifyApi` constructor parameter (from `spotify` package).
    - `getUserPlaylists()`: Use `_spotifyApi.playlists.me.all(50)` to fetch all user playlists. Map each `PlaylistSimple` to `SpotifyPlaylistInfo` extracting: `p.id ?? ''`, `p.name ?? 'Untitled'`, `p.description`, first image URL from `p.images`, `p.tracksLink?.total`, `p.owner?.displayName`. Filter out entries where id is empty. Wrap in try/catch returning `[]` on any Exception (use `catch(_)` per project convention).
    - `getPlaylistTracks(playlistId)`: Use `_spotifyApi.playlists.getPlaylistTracks(playlistId).all(50)`. Filter out local tracks (`pt.isLocal ?? false`), filter out null `pt.track`. Map each `PlaylistTrack` to `SpotifyPlaylistTrack` extracting: `pt.track!.name ?? ''`, artist names joined with comma (reuse the `_artistName` pattern from SpotifySongSearchService), `pt.track!.uri`, `pt.track!.durationMs`, `pt.track!.album?.name`, first album image URL. Filter out entries with empty title. Wrap in try/catch returning `[]`.

    **4. Provider** (`spotify_import_providers.dart`):
    - Create `spotifyPlaylistServiceProvider` as a `Provider<SpotifyPlaylistService>`. Read `spotifyConnectionStatusSyncProvider`. If `connected`, return `MockSpotifyPlaylistService()` (since real Spotify credentials unavailable -- same pattern as `songSearchServiceProvider` using mock). Add a comment noting to swap to `RealSpotifyPlaylistService` when Dashboard available.
    - Import from spotify_auth providers for connection status check.

    **5. OAuth scopes update** (`spotify_constants.dart`):
    - Add `playlist-read-private playlist-read-collaborative` to the `spotifyScopes` constant string. Place them before the existing `playlist-modify-public playlist-modify-private`. The result should be:
      `'user-read-email user-read-private user-top-read user-library-read playlist-read-private playlist-read-collaborative playlist-modify-public playlist-modify-private'`

    **6. Tests** (`spotify_playlist_service_test.dart`):
    - Test MockSpotifyPlaylistService:
      - `getUserPlaylists` returns 5 playlists with valid data
      - `getPlaylistTracks` returns tracks for known playlist IDs
      - `getPlaylistTracks` returns default tracks for unknown playlist IDs
      - All tracks have non-empty title and artist
    - No test for real implementation (requires Spotify API -- tested when credentials available)
  </action>
  <verify>
    Run `dart analyze lib/features/spotify_import/ lib/core/constants/spotify_constants.dart` -- no errors.
    Run `dart test test/features/spotify_import/` -- all tests pass.
    Verify `spotify_constants.dart` contains `playlist-read-private`.
  </verify>
  <done>
    SpotifyPlaylistService abstract interface defined with getUserPlaylists and getPlaylistTracks. Mock returns 5 realistic playlists and per-playlist tracks. Real implementation uses spotify 0.15.0 package API. Provider wired with connection status check. OAuth scopes include playlist-read-private and playlist-read-collaborative. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add batch addSongs method to RunningSongNotifier</name>
  <files>
    lib/features/running_songs/providers/running_song_providers.dart
    test/features/running_songs/running_song_lifecycle_test.dart
  </files>
  <action>
    **1. Batch method** (`running_song_providers.dart`):
    - Add `Future<int> addSongs(List<RunningSong> songs)` to `RunningSongNotifier`.
    - Implementation: Create a new map from current state. Loop through songs, skip any where `newState.containsKey(song.songKey)` (already in collection). Count additions. If `added > 0`, update `state` once with the new map and call `RunningSongPreferences.save(state)` once. Return `added` count.
    - This method updates state ONCE and persists ONCE regardless of input size (compared to calling addSong N times which persists N times).
    - Keep the existing `addSong` method unchanged for single-add use cases.

    **2. Tests** (add to `running_song_lifecycle_test.dart`):
    - Test `addSongs` with 3 new songs: verify all 3 added, returns 3.
    - Test `addSongs` with 2 songs where 1 already exists: verify only 1 new added, returns 1.
    - Test `addSongs` with empty list: verify returns 0, state unchanged.
    - Test `addSongs` with all duplicates: verify returns 0, state unchanged.
  </action>
  <verify>
    Run `dart test test/features/running_songs/running_song_lifecycle_test.dart` -- all tests pass (existing + new).
    Run `dart analyze lib/features/running_songs/providers/running_song_providers.dart` -- no errors.
  </verify>
  <done>
    RunningSongNotifier has addSongs(List) batch method that updates state once and persists once. Returns count of newly added songs. Deduplicates against existing collection. All existing and new tests pass.
  </done>
</task>

</tasks>

<verification>
1. `dart analyze lib/features/spotify_import/ lib/features/running_songs/providers/ lib/core/constants/` -- no errors
2. `dart test test/features/spotify_import/ test/features/running_songs/` -- all tests pass
3. `spotify_constants.dart` contains `playlist-read-private playlist-read-collaborative`
4. `spotifyPlaylistServiceProvider` exists and reads connection status
5. `RunningSongNotifier.addSongs()` method exists with batch semantics
</verification>

<success_criteria>
- SpotifyPlaylistService abstract interface with two methods
- MockSpotifyPlaylistService returns 5 playlists and per-playlist tracks
- RealSpotifyPlaylistService uses spotify 0.15.0 API methods
- Provider returns mock (with documented swap-to-real comment)
- OAuth scopes updated for playlist access
- Batch addSongs method on RunningSongNotifier
- All tests pass, no analysis errors
</success_criteria>

<output>
After completion, create `.planning/phases/33-spotify-playlist-import/33-01-SUMMARY.md`
</output>
