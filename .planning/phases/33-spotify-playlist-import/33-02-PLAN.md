---
phase: 33-spotify-playlist-import
plan: 02
type: execute
wave: 2
depends_on: ["33-01"]
files_modified:
  - lib/features/spotify_import/presentation/spotify_playlists_screen.dart
  - lib/features/spotify_import/presentation/spotify_playlist_tracks_screen.dart
  - lib/features/running_songs/presentation/running_songs_screen.dart
  - lib/app/router.dart
autonomous: true

must_haves:
  truths:
    - "User can see a list of their Spotify playlists when connected"
    - "User can open a playlist and see its tracks with selection controls"
    - "User can select songs from a Spotify playlist and import them into Songs I Run To"
    - "Imported songs are available for scoring, taste learning, and BPM indicators just like manually added songs"
  artifacts:
    - path: "lib/features/spotify_import/presentation/spotify_playlists_screen.dart"
      provides: "Browseable list of user's Spotify playlists"
      contains: "class SpotifyPlaylistsScreen"
    - path: "lib/features/spotify_import/presentation/spotify_playlist_tracks_screen.dart"
      provides: "Track list with multi-select and import action"
      contains: "class SpotifyPlaylistTracksScreen"
    - path: "lib/app/router.dart"
      provides: "Routes for /spotify-playlists and /spotify-playlists/:id"
      contains: "spotify-playlists"
    - path: "lib/features/running_songs/presentation/running_songs_screen.dart"
      provides: "Import from Spotify button (visible when connected)"
      contains: "Icons.cloud_download"
  key_links:
    - from: "lib/features/spotify_import/presentation/spotify_playlists_screen.dart"
      to: "lib/features/spotify_import/providers/spotify_import_providers.dart"
      via: "reads spotifyPlaylistServiceProvider to fetch playlists"
      pattern: "spotifyPlaylistServiceProvider"
    - from: "lib/features/spotify_import/presentation/spotify_playlist_tracks_screen.dart"
      to: "lib/features/running_songs/providers/running_song_providers.dart"
      via: "calls addSongs batch method for import"
      pattern: "addSongs"
    - from: "lib/features/running_songs/presentation/running_songs_screen.dart"
      to: "lib/features/spotify_auth/providers/spotify_auth_providers.dart"
      via: "watches spotifyConnectionStatusSyncProvider to show import button"
      pattern: "spotifyConnectionStatusSyncProvider"
---

<objective>
Build the two Spotify playlist import screens (playlist browser and track selector with multi-select import), add routes, and wire the "Import from Spotify" entry point on the Running Songs screen.

Purpose: Completes the user-facing flow for browsing Spotify playlists and importing songs into "Songs I Run To". This is the final phase of the v1.4 milestone.

Output: Two new screens, updated router, and updated Running Songs screen with conditional import button.
</objective>

<execution_context>
@/Users/tijmen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tijmen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-spotify-playlist-import/33-RESEARCH.md
@.planning/phases/33-spotify-playlist-import/33-01-SUMMARY.md

@lib/features/spotify_import/domain/spotify_playlist_service.dart
@lib/features/spotify_import/data/mock_spotify_playlist_service.dart
@lib/features/spotify_import/providers/spotify_import_providers.dart
@lib/features/running_songs/providers/running_song_providers.dart
@lib/features/running_songs/domain/running_song.dart
@lib/features/running_songs/presentation/running_songs_screen.dart
@lib/features/spotify_auth/providers/spotify_auth_providers.dart
@lib/features/spotify_auth/domain/spotify_auth_service.dart
@lib/features/song_search/presentation/song_search_screen.dart
@lib/features/song_feedback/domain/song_feedback.dart
@lib/app/router.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: SpotifyPlaylistsScreen and SpotifyPlaylistTracksScreen</name>
  <files>
    lib/features/spotify_import/presentation/spotify_playlists_screen.dart
    lib/features/spotify_import/presentation/spotify_playlist_tracks_screen.dart
  </files>
  <action>
    **1. SpotifyPlaylistsScreen** (`spotify_playlists_screen.dart`):
    - Create `SpotifyPlaylistsScreen extends ConsumerStatefulWidget`. Use StatefulWidget to hold the FutureBuilder-like loading state.
    - State: `List<SpotifyPlaylistInfo>? _playlists`, `bool _loading = true`, `String? _error`.
    - In `initState`, call `_loadPlaylists()` which reads `spotifyPlaylistServiceProvider` and calls `getUserPlaylists()`. On success set `_playlists`, on error set `_error`, always set `_loading = false`.
    - AppBar title: "My Spotify Playlists".
    - Loading state: `CircularProgressIndicator` centered.
    - Error state: error message with retry button.
    - Empty state: "No playlists found" message.
    - Loaded state: `ListView.builder` of playlist cards. Each card shows:
      - Playlist cover image (if `imageUrl` non-null, use `Image.network` with 56x56 ClipRRect rounded corners; else show `Icons.queue_music` icon in a 56x56 container with `surfaceContainerHighest` background).
      - Playlist name (titleSmall, max 1 line, ellipsis).
      - Subtitle: "{trackCount} tracks" and owner name if available (bodySmall, onSurfaceVariant).
      - Use `Card` with same styling as `_RunningSongCard` in running_songs_screen.dart (elevation: 0, surfaceContainerLow, borderRadius 10).
      - `onTap`: navigate to `/spotify-playlists/${playlist.id}` passing playlist name as query parameter `name`.

    **2. SpotifyPlaylistTracksScreen** (`spotify_playlist_tracks_screen.dart`):
    - Create `SpotifyPlaylistTracksScreen extends ConsumerStatefulWidget`. Constructor takes `playlistId` (String) and `playlistName` (String?).
    - State: `List<SpotifyPlaylistTrack>? _tracks`, `bool _loading = true`, `String? _error`, `Set<int> _selectedIndices = {}` (track selection by index).
    - In `initState`, call `_loadTracks()` which reads `spotifyPlaylistServiceProvider` and calls `getPlaylistTracks(playlistId)`. Set state accordingly.
    - AppBar title: playlist name or "Playlist Tracks".
    - Loading state: centered spinner.
    - Error state: error message with retry button.
    - Empty state: "No tracks in this playlist" message.
    - Loaded state: `ListView.builder` with track items. Each item shows:
      - Leading: `Checkbox` controlled by `_selectedIndices.contains(index)`. On changed, toggle index in `_selectedIndices` and call `setState`.
      - Track artwork (if `imageUrl` non-null, `Image.network` 40x40 with ClipRRect borderRadius 4; else `Icons.music_note` in 40x40 container).
      - Title: track title (titleSmall, max 1 line, ellipsis).
      - Subtitle: artist name. If track duration available, append formatted duration (m:ss). Use bodySmall, onSurfaceVariant.
      - Trailing: if the track already exists in "Songs I Run To" (check via `ref.watch(runningSongProvider)` using `SongKey.normalize(track.artist, track.title)`), show a small `Icon(Icons.check_circle, color: Colors.green, size: 20)` and disable the checkbox (set value: true, onChanged: null).
    - Bottom bar: Use a `BottomAppBar` or persistent bottom widget. Show a `FilledButton` with text "Import {N} Songs" (where N = selected count, excluding already-imported tracks). Disable when selection is empty. On tap:
      1. Capture `WidgetRef ref` before any async operation (per project convention -- see STATE.md decisions).
      2. Build the list of `SpotifyPlaylistTrack` for selected indices.
      3. Convert each to `RunningSong` using `SongKey.normalize(track.artist, track.title)` for songKey, `bpm: null`, `source: RunningSongSource.spotify`, `addedDate: DateTime.now()`.
      4. Call `ref.read(runningSongProvider.notifier).addSongs(runningSongs)` (batch method from Plan 01).
      5. Show a SnackBar: "{N} songs imported" (N = the return value from addSongs).
      6. Clear selection.
    - "Select All" / "Deselect All" toggle in AppBar actions: IconButton that toggles all non-imported tracks.
  </action>
  <verify>
    Run `dart analyze lib/features/spotify_import/presentation/` -- no errors.
    Both files compile and follow established UI patterns.
  </verify>
  <done>
    SpotifyPlaylistsScreen shows user's Spotify playlists with cover images, names, and track counts. SpotifyPlaylistTracksScreen shows tracks with checkboxes for multi-select, already-imported indicators, and batch import button. Import creates RunningSong entries via batch addSongs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Router wiring and Running Songs screen import entry point</name>
  <files>
    lib/app/router.dart
    lib/features/running_songs/presentation/running_songs_screen.dart
  </files>
  <action>
    **1. Router** (`router.dart`):
    - Add import for `SpotifyPlaylistsScreen` and `SpotifyPlaylistTracksScreen`.
    - Add nested route for Spotify playlists:
      ```dart
      GoRoute(
        path: '/spotify-playlists',
        builder: (context, state) => const SpotifyPlaylistsScreen(),
        routes: [
          GoRoute(
            path: ':id',
            builder: (context, state) {
              final id = state.pathParameters['id']!;
              final name = state.uri.queryParameters['name'];
              return SpotifyPlaylistTracksScreen(
                playlistId: id,
                playlistName: name,
              );
            },
          ),
        ],
      ),
      ```
    - Place this after the `/song-search` route, before `/post-run-review`.

    **2. Running Songs screen entry point** (`running_songs_screen.dart`):
    - Add import for `spotify_auth_providers.dart` and `spotify_auth_service.dart` (for `SpotifyConnectionStatus`).
    - In the `AppBar.actions` list (there are two places -- both the empty-state Scaffold and the populated Scaffold), add an "Import from Spotify" IconButton BEFORE the existing search IconButton:
      - Read `ref.watch(spotifyConnectionStatusSyncProvider)` at the top of the build method.
      - Only show the import button when status is `SpotifyConnectionStatus.connected`.
      - Icon: `Icons.cloud_download`.
      - Tooltip: `'Import from Spotify'`.
      - `onPressed`: `() => context.push('/spotify-playlists')`.
    - Extract the AppBar actions into a helper method `List<Widget> _appBarActions(BuildContext context, WidgetRef ref, SpotifyConnectionStatus status)` to avoid duplicating the conditional logic in both Scaffold branches.
  </action>
  <verify>
    Run `dart analyze lib/app/router.dart lib/features/running_songs/presentation/running_songs_screen.dart` -- no errors.
    Verify routes are registered and entry point is conditional on Spotify connection.
  </verify>
  <done>
    Routes /spotify-playlists and /spotify-playlists/:id registered in GoRouter. Running Songs screen shows "Import from Spotify" button in app bar when Spotify is connected, hidden otherwise. Both empty-state and populated views show the button consistently.
  </done>
</task>

</tasks>

<verification>
1. `dart analyze lib/features/spotify_import/ lib/features/running_songs/presentation/ lib/app/` -- no errors
2. `/spotify-playlists` route exists and renders SpotifyPlaylistsScreen
3. `/spotify-playlists/:id` route exists and passes playlistId and name parameters
4. Running Songs screen shows import button only when Spotify connected
5. Import flow: browse playlists -> select tracks -> import -> songs appear in "Songs I Run To"
6. Already-imported tracks show green check and cannot be double-imported
</verification>

<success_criteria>
- SpotifyPlaylistsScreen displays playlists with images, names, track counts
- SpotifyPlaylistTracksScreen displays tracks with multi-select checkboxes
- Batch import button converts selected tracks to RunningSong entries
- Already-imported tracks visually indicated and excluded from re-import
- GoRouter routes registered with nested :id parameter
- Running Songs screen shows conditional "Import from Spotify" entry point
- No analysis errors
</success_criteria>

<output>
After completion, create `.planning/phases/33-spotify-playlist-import/33-02-SUMMARY.md`
</output>
